-- ----------------------------
-- Triggers structure for table User
-- ----------------------------
DROP TRIGGER [dbo].[TR_User_AUDIT]
GO
CREATE TRIGGER [dbo].[TR_User_AUDIT]
ON [dbo].[User]
AFTER INSERT, UPDATE, DELETE
AS
	SET NOCOUNT ON;
  --Avoid Trigger when batch insert,update 
  IF (SELECT COUNT(*) FROM inserted) > 1
  BEGIN
     Return
  END
  DECLARE @TableName VARCHAR(128);
	DECLARE @ActionCode VARCHAR(50);
	DECLARE @PKSelect VARCHAR(1000);
  DECLARE @UpdateUser VARCHAR(128);
  DECLARE @UpdateKey VARCHAR(40);
		
  DECLARE @BeforeAfter NVARCHAR(MAX); 
  DECLARE @BeforeValue nvarchar(MAX);
  DECLARE @AfterValue nvarchar(MAX);
  DECLARE @Qry nvarchar(MAX);
  DECLARE @CompareTable table(　　
　　[Field] nvarchar(255),
　　[Before] nvarchar(MAX),
　　[After] nvarchar(MAX)
　);
		
  -- get DATA
  SELECT * INTO #ins FROM inserted
  SELECT * INTO #del FROM deleted
  --U=Update、I=Insert、D=Delete
  SELECT @ActionCode='', @PKSelect='';
  -- table
  SELECT @TableName = 'User'    
  
  -- date and user
  SELECT @UpdateUser = '' 	
  SET @BeforeAfter=''; 
     
    --Update ( deleted + inserted )
    IF EXISTS(SELECT 1 FROM deleted) AND EXISTS(SELECT 1 FROM inserted)
    BEGIN         	  
    SET @ActionCode   = @TableName+'.'+ 
                      ( case 
                           when (SELECT Deleted FROM deleted)='Y' AND (SELECT Deleted FROM inserted)='N' then 'Insert' 
                           when (SELECT Deleted FROM deleted)='N' AND (SELECT Deleted FROM inserted)='Y' then 'Delete'
                           else 'Update' 
                      end ) 
    SET @PKSelect     = ( SELECT 'UserId='+UserId+',UserName='+UserName FROM inserted )
    SET @UpdateUser   = ( SELECT ModifiedUser FROM inserted )
	  SET @UpdateKey    = ( SELECT ModifiedUID FROM inserted )
      --compare before&after
      DECLARE @curCol varchar(50)
      DECLARE the_cursor CURSOR FOR
      SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'User' 
      OPEN the_cursor
      FETCH NEXT FROM the_cursor INTO @curCol
      WHILE @@FETCH_STATUS = 0
        BEGIN  
          set @Qry = 'SELECT @Result = ' +@curCol+' FROM #ins '
          EXECUTE sp_executesql @Qry, N'@Result NVARCHAR(MAX) OUTPUT', @Result=@AfterValue OUTPUT
          set @Qry = 'SELECT @Result = ' +@curCol+' FROM #del '
          EXECUTE sp_executesql @Qry, N'@Result NVARCHAR(MAX) OUTPUT', @Result=@BeforeValue OUTPUT
          IF @BeforeValue<>@AfterValue
    					insert @CompareTable VALUES ( @curCol, @BeforeValue, @AfterValue)         
		      --next 
          FETCH NEXT FROM the_cursor INTO @curCol
        END
      CLOSE the_cursor
      DEALLOCATE the_cursor
      SET @BeforeAfter = (select * from @CompareTable FOR JSON PATH)
    END
    --Insert ( inserted )
    IF EXISTS(SELECT 1 FROM inserted) AND NOT EXISTS(SELECT 1 FROM deleted)   
    BEGIN   
        SET @BeforeAfter      = ( SELECT * FROM inserted FOR JSON PATH ) 
        SET @ActionCode       = @TableName+'.'+'Insert'
        SET @PKSelect     = ( SELECT 'UserId='+UserId+',UserName='+UserName FROM inserted )
        SET @UpdateUser   = ( SELECT ModifiedUser FROM inserted )
		SET @UpdateKey    = ( SELECT ModifiedUID FROM inserted )
    END
 
    --Delete ( deleted )
    IF EXISTS(SELECT 1 FROM deleted) AND NOT EXISTS(SELECT 1 FROM inserted)
    BEGIN   
        SET @BeforeAfter  = ( SELECT * FROM deleted FOR JSON PATH ) 
		    SET @ActionCode   = @TableName+'.'+'Delete'
        SET @PKSelect     = ( SELECT 'UserId='+UserId+',UserName='+UserName FROM deleted )
    END
     
    INSERT INTO ezAcquireAudit.dbo.AuditLog (    
								ActionCode, 
								TableName, 
								PK, 
								BeforeAfter, 
								UpdateDate, 
								UpdateUser,
								AuditKey)
    VALUES (    
        @ActionCode,
        @TableName,
				@PKSelect,
				@BeforeAfter,
				GETDATE(),
				@UpdateUser,
				@UpdateKey
    )
GO