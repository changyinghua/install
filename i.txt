USE [ezAcquire]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetUserFormQuery]    Script Date: 2021/11/19 下午 02:11:10 ******/
DROP PROCEDURE [dbo].[sp_GetUserFormQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryResultJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetQueryResultJson]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryDetailJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetQueryDetailJson]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryConditionJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetQueryConditionJson]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetOptionList]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetOptionList]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetMachineCode]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetMachineCode]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetIndexQueryList]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_GetIndexQueryList]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_UnLock]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_UnLock]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_ManageModifyMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_ManageInsertMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageDeleteMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_ManageDeleteMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_Logout]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_Logout]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_Login]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_User_Login]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageModify]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageInsert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_SignatureQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_SignatureQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanVerify]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_ScanVerify]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageModify]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageInsert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageDelete]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageDelete]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_SAMQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_SAMQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_MaskTypeInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_MaskTypeInsert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageModifyMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageModifyIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageModifyIndex]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageMaskTypeInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageMaskTypeInsert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageInsertMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageDeleteIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageDeleteIndex]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageDelete]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Role_ManageDelete]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanRequest]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_RescanRequest]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanCompleted]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_RescanCompleted]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_RescanCancel]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_QueryMultipleIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_QueryMultipleIndex]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_QueryCondition]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Image_QueryCondition]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_QueryByPage]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Image_QueryByPage]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_Print]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Image_Print]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_ModifyIndexValue]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Image_ModifyIndexValue]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_IndexQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Image_IndexQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_HSCQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_HSCQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_GetRescanQueue]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_GetRescanQueue]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_GetAppendScanQueue]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_GetAppendScanQueue]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormTemplate_Insert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormTemplate_Insert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormTemplate_DeleteTemplate]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormTemplate_DeleteTemplate]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageModifyItem]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageModifyItem]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageModify]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageInsert]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageModifyForm]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageModifyForm]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageModify]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageInsertMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageDeleteForm]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageDeleteForm]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Form_ManageQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Form_ManageModifyMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Form_ManageInsertMap]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Delete_User]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Delete_User]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Delete_Form]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Delete_Form]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_DataExchange_getDataByKey]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_DataExchange_getDataByKey]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Clause_ClauseQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_Clause_ClauseQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_BLSQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_BLSQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanRequest]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_AppendScanRequest]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanCompleted]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_AppendScanCompleted]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_AppendScanCancel]
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_APLQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_ezAcquire_APLQuery]
GO
/****** Object:  StoredProcedure [dbo].[sp_DropDefaultConstraint]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_DropDefaultConstraint]
GO
/****** Object:  StoredProcedure [dbo].[sp_Common_SplitStr2Table]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[sp_Common_SplitStr2Table]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_TransferFilingReport]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_TransferFilingReport]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_Transfer]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_Transfer]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_ScanTransferReport]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_ScanTransferReport]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_SaveBagBatch]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_SaveBagBatch]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_RecoverDestruction]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_RecoverDestruction]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_QueryWarehouseFiling]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_QueryWarehouseFiling]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_MoveWarehouse]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_MoveWarehouse]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_GetBagNumber]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_GetBagNumber]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_FilingQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_FilingQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_FilingCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_FilingCancel]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_Destruction]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_Destruction]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_ConfirmBagBatch]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_ConfirmBagBatch]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowTransferQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowTransferQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowTransfer]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowTransfer]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowSignQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowSignQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowSign]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowSign]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewReject]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewReject]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewApprove]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewApprove]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCheckQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCheckQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCheck]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCheck]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCancelQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCancelQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCancel]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturn]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowReturn]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowCancel]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowApplicationQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowApplicationQuery]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowApplication]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BorrowApplication]
GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BagWarehouse]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP PROCEDURE [dbo].[ezAcquireFiling_BagWarehouse]
GO
/****** Object:  UserDefinedFunction [dbo].[sp_Common_Split]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP FUNCTION [dbo].[sp_Common_Split]
GO
/****** Object:  UserDefinedFunction [dbo].[fnc_split]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP FUNCTION [dbo].[fnc_split]
GO
/****** Object:  UserDefinedFunction [dbo].[fn_Zdecimal]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP FUNCTION [dbo].[fn_Zdecimal]
GO
/****** Object:  UserDefinedFunction [dbo].[fn_SplitString]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP FUNCTION [dbo].[fn_SplitString]
GO
/****** Object:  UserDefinedFunction [dbo].[ezAcquireAudit_Trans2Random]    Script Date: 2021/11/19 下午 02:11:11 ******/
DROP FUNCTION [dbo].[ezAcquireAudit_Trans2Random]
GO
/****** Object:  UserDefinedFunction [dbo].[ezAcquireAudit_Trans2Random]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[ezAcquireAudit_Trans2Random](
	@OperatorUserId		varchar(20),	--操作者Id
	@OperationFunction	varchar(20),	--操作系統
	@Description 		varchar(max),	--描述
	@DocAuditCode		varchar(100)	--回寫代碼
)
RETURNS varchar(128)
WITH EXECUTE AS CALLER
AS
BEGIN

	DECLARE	@oOperatorUserId	varbinary(max);
	DECLARE	@oOperationFunction	varbinary(max);
	DECLARE	@oDescription		varbinary(max);
	DECLARE	@oDocAuditCode		varbinary(max);
	DECLARE	@oAddString			varbinary(max);
	DECLARE	@oReturnString		varchar(128);
	
	SET @oOperatorUserId = CONVERT(varbinary(max),@OperatorUserId);
	SET @oOperationFunction = CONVERT(varbinary(max),@OperationFunction);
	SET @oDescription = CONVERT(varbinary(max),@Description);
	SET @oDocAuditCode =  CONVERT(varbinary(max),@DocAuditCode);
	SET @oAddString = @oOperatorUserId + @oOperationFunction + @oDescription;
	SET @oReturnString = HASHBYTES('SHA1', CONVERT(varbinary(20),@oAddString));
	
	RETURN(@oReturnString);

END

GO
/****** Object:  UserDefinedFunction [dbo].[fn_SplitString]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fn_SplitString]
( 
	@InputString VARCHAR(8000)
)
RETURNS NVARCHAR(MAX)
AS
BEGIN
  
	DECLARE @Words VARCHAR(MAX)
	DECLARE @t VARCHAR(MAX)
	DECLARE @I INT
	DECLARE	@ReturnString		NVARCHAR(MAX);
	SET @Words = @InputString
  
    SELECT @I = 0
		SELECT @ReturnString = ''
    WHILE(@I < LEN(@Words)+1)
    BEGIN
      SELECT @t = SUBSTRING(@words,@I,1)
			SET @ReturnString = @ReturnString + @t + ',' 
      SET @I = @I + 1
    END
   RETURN @ReturnString
END
GO
/****** Object:  UserDefinedFunction [dbo].[fn_Zdecimal]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create FUNCTION [dbo].[fn_Zdecimal]
(
    @char char(1)
)
returns char(1)
AS
BEGIN
    DECLARE @result char(1)

    DECLARE @temp TABLE
    (
        SEQ int,
        [CHAR] char(1)
    )

    INSERT INTO @temp VALUES (1,  'A')
    INSERT INTO @temp VALUES (2,  'B')
    INSERT INTO @temp VALUES (3,  'C')
    INSERT INTO @temp VALUES (4,  'D')
    INSERT INTO @temp VALUES (5,  'E')
    INSERT INTO @temp VALUES (6,  'F')
    INSERT INTO @temp VALUES (7,  'G')
    INSERT INTO @temp VALUES (8,  'H')
    INSERT INTO @temp VALUES (9,  'I')
    INSERT INTO @temp VALUES (10, 'J')
    INSERT INTO @temp VALUES (11, 'K')
    INSERT INTO @temp VALUES (12, 'L')
    INSERT INTO @temp VALUES (13, 'M')
    INSERT INTO @temp VALUES (14, 'N')
    INSERT INTO @temp VALUES (15, 'O')
    INSERT INTO @temp VALUES (16, 'P')
    INSERT INTO @temp VALUES (17, 'Q')
    INSERT INTO @temp VALUES (18, 'R')
    INSERT INTO @temp VALUES (19, 'S')
    INSERT INTO @temp VALUES (20, 'T')
    INSERT INTO @temp VALUES (21, 'U')
    INSERT INTO @temp VALUES (22, 'V')
    INSERT INTO @temp VALUES (23, 'W')
    INSERT INTO @temp VALUES (24, 'X')
    INSERT INTO @temp VALUES (25, 'Y')
    INSERT INTO @temp VALUES (26, 'Z')

    DECLARE @seq int
    SELECT @seq = SEQ FROM @temp WHERE [Char] = @char
    SELECT @result = [CHAR] FROM @temp WHERE SEQ = @seq + 1

    RETURN @result
END
GO
/****** Object:  UserDefinedFunction [dbo].[fnc_split]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
   create function [dbo].[fnc_split]
   (
    @OriginalStr nvarchar(4000),
    @SplitChar nvarchar(1000)
   )
   --定義函數的回傳值類型為：Table
   returns @temp table(splitValue nvarchar(1000))
   As
     Begin
      declare @index int
      declare @s nvarchar(1000)
      --通過While迴圈得到分隔之後的字串
      while(1=1)
       Begin
        --取得分隔字串在來源字中的位置
        set @index=charindex(@SplitChar,@OriginalStr)
        if @index=0
          begin
          insert into @temp(splitValue) values(@OriginalStr)
        break;
       End
      --借助於Left函數將來源字串截斷
      set @s=left(@OriginalStr,@index-1)
      insert into @temp(splitValue) values(@s)
      set @OriginalStr=Right(@OriginalStr,len(@OriginalStr)-@index)
    End
   return
  End
  

GO
/****** Object:  UserDefinedFunction [dbo].[sp_Common_Split]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[sp_Common_Split] (
      @InputString                  VARCHAR(8000),
      @Delimiter                    VARCHAR(50)
)
 
RETURNS @Items TABLE (
      Item                          VARCHAR(8000)
)
 
AS
BEGIN
      IF @Delimiter = ' '
      BEGIN
            SET @Delimiter = ','
            SET @InputString = REPLACE(@InputString, ' ', @Delimiter)
      END
 
      IF (@Delimiter IS NULL OR @Delimiter = '')
            SET @Delimiter = ','
 
--INSERT INTO @Items VALUES (@Delimiter) -- Diagnostic
--INSERT INTO @Items VALUES (@InputString) -- Diagnostic
 
      DECLARE @Item                 VARCHAR(8000)
      DECLARE @ItemList       VARCHAR(8000)
      DECLARE @DelimIndex     INT
 
      SET @ItemList = @InputString
      SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      WHILE (@DelimIndex != 0)
      BEGIN
            SET @Item = SUBSTRING(@ItemList, 0, @DelimIndex)
            INSERT INTO @Items VALUES (@Item)
 
            -- Set @ItemList = @ItemList minus one less item
            SET @ItemList = SUBSTRING(@ItemList, @DelimIndex+1, LEN(@ItemList)-@DelimIndex)
            SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      END -- End WHILE
 
      IF @Item IS NOT NULL -- At least one delimiter was encountered in @InputString
      BEGIN
            SET @Item = @ItemList
            INSERT INTO @Items VALUES (@Item)
      END
 
      -- No delimiters were encountered in @InputString, so just return @InputString
      ELSE INSERT INTO @Items VALUES (@InputString)
 
      RETURN
 
END -- End Function

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BagWarehouse]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BagWarehouse]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBagIdArr			Varchar(max)		--袋號陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_BagWarehouse 'ivy','NB1031200005|NB1031200004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得袋號資料 *******************************/	
	
	--建立暫存檔:袋號資料
	CREATE TABLE #BagIdTmp
	(
		BagId			varchar(20)
	)			
	INSERT INTO #BagIdTmp(BagId) EXEC dbo.sp_Common_SplitStr2Table @iBagIdArr;
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BagId			varchar(20),
		BatchNumber		varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BagId,BatchNumber) 
	SELECT BAGID,BatchNumber FROM FilingBatches
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,FilingStatus,'03',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM FilingBatches WHERE BAGID IN (SELECT BagId FROM #BagIdTmp) ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowApplication]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowApplication]

	@iProcessUserId		Varchar(20),		--申請人
	@iDocumentId		Varchar(50),		--文件id
	@iBorrowReason		Varchar(max)		--借調原因
	
	
	--exec dbo.ezAcquireFiling_BorrowApplication 'a02746','25046','test'
	
AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下可借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where DocumentId = @iDocumentId
	)	
	
	--select * from @DocumentIdTable
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,FilingStatus,'11',@iProcessUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE DocumentID in (
		SELECT DocumentId from @DocumentIdTable
	)
		
	--更新文件狀態
	
	UPDATE DocumentIndex
	SET FilingStatus = '11'
	WHERE DocumentID in (
		SELECT DocumentId from @DocumentIdTable
	)
	
	--寫入借調資料
	INSERT INTO FilingBorrow 
	(DocumentId,ApplicationDate,ApplicantUserId,ApplicationNote,FilingStatus) 
	SELECT DocumentId,getDate(),@iProcessUserId,@iBorrowReason,'11'
	FROM @DocumentIdTable;	
			
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE DocumentID = @iDocumentId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowApplicationQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowApplicationQuery]

	@iFilingTypeId		varchar(max),	--歸檔類別
	@iBagId				varchar(max),	--袋號
	@iFilingNumber		varchar(max),	--歸檔號碼
	@iBatchNumber		varchar(max),	--批次號碼
	@iProcessDateTimeS	varchar(max),	--歸檔日期起
	@iProcessDateTimeE	varchar(max),	--歸檔日期迄
	
	@iPolicyId			varchar(max),	--保單號碼(Mutiple)
	@iPolicySerialNo	varchar(max),	--保單序號
	@iPOSNumber			varchar(max),	--契變案號(Mutiple)
	@iClaimNumber		varchar(max),	--理賠案號(Mutiple)
	@iPaidSerialNo		varchar(max),	--授權書流水號
	
	@iInsuredId			varchar(max),	--被保人ID
	@iMainId			varchar(max),	--要保人ID
	@iSalesId			varchar(max),	--業務員ID
	@iRegReceiveDate	varchar(max),	--掛號處理日期
	
	@iBlacklistNo		varchar(max),	--建檔序號
	@iCompanyId			varchar(max)	--統一編號/院所代碼
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowApplicationQuery 
	'','','','','','',
	'','','','','',
	'','','','',
	'','10405071'
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 組合查詢字串 *******************************/	
	
	DECLARE		@oScriptString		varchar(max);
	
	SET @oScriptString = 'select * from vw_ezAcquire_FilingMaster ' + 
						 'where FilingNumber in ( ' + 
						 'select distinct FilingNumber from vw_ezAcquire_FilingMaster ' +
                         'where FilingStatus In ( ''03'',''15'') and FilingNumber <> '''')  ' 
	
	--歸檔類別
	IF(@iFilingTypeId IS NOT NULL AND @iFilingTypeId <> '') 
		SET @oScriptString = @oScriptString + 'and FilingTypeId = ''' + @iFilingTypeId  + ''''	
	--袋號
	IF(@iBagId IS NOT NULL AND @iBagId <> '') 
		SET @oScriptString = @oScriptString + 'and BagId = ''' + @iBagId  + ''''
	--歸檔號碼
	IF(@iFilingNumber IS NOT NULL AND @iFilingNumber <> '') 
		SET @oScriptString = @oScriptString + 'and FilingNumber = ''' + @iFilingNumber  + ''''
	--批次號碼
	IF(@iBatchNumber IS NOT NULL AND @iBatchNumber <> '') 
		SET @oScriptString = @oScriptString + 'and BatchNumber = ''' + @iBatchNumber  + ''''		
	--歸檔日期起
	IF(@iProcessDateTimeS IS NOT NULL AND @iProcessDateTimeS <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime >= ''' + @iProcessDateTimeS  + ' 00:00:00'' '	
	--歸檔日期迄
	IF(@iProcessDateTimeE IS NOT NULL AND @iProcessDateTimeE <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime <= ''' + @iProcessDateTimeE  + ' 23:59:59'' '
	
	--保單號碼
	IF(@iPolicyId IS NOT NULL AND @iPolicyId <> '') 
		SET @oScriptString = @oScriptString + 'and I_50 like ''%' + @iPolicyId  + '%'''
	--保單序號
	IF(@iPolicySerialNo IS NOT NULL AND @iPolicySerialNo <> '') 
		SET @oScriptString = @oScriptString + 'and I_51 = ''' + @iPolicySerialNo  + ''''
	--契變案號
	IF(@iPOSNumber IS NOT NULL AND @iPOSNumber <> '') 
		SET @oScriptString = @oScriptString + 'and I_52 like ''%' + @iPOSNumber  + '%'''
	--理賠案號
	IF(@iClaimNumber IS NOT NULL AND @iClaimNumber <> '') 
		SET @oScriptString = @oScriptString + 'and I_60 like ''%' + @iClaimNumber  + '%'''
	--授權書流水序號
	IF(@iPaidSerialNo IS NOT NULL AND @iPaidSerialNo <> '') 
		SET @oScriptString = @oScriptString + 'and I_49 = ''' + @iPaidSerialNo  + ''''
	
	--被保人ID
	IF(@iInsuredId IS NOT NULL AND @iInsuredId <> '') 
		SET @oScriptString = @oScriptString + 'and I_47 = ''' + @iInsuredId  + ''''
	--要保人ID
	IF(@iMainId IS NOT NULL AND @iMainId <> '') 
		SET @oScriptString = @oScriptString + 'and I_48 = ''' + @iMainId  + ''''
	--業務員ID
	IF(@iSalesId IS NOT NULL AND @iSalesId <> '') 
		SET @oScriptString = @oScriptString + 'and I_55 = ''' + @iSalesId  + ''''
	--掛號處理日期
	IF(@iRegReceiveDate IS NOT NULL AND @iRegReceiveDate <> '') 
		SET @oScriptString = @oScriptString + 'and I_53 = ''' + @iRegReceiveDate  + ''''
	
	--建檔序號
	IF(@iBlacklistNo IS NOT NULL AND @iBlacklistNo <> '') 
		SET @oScriptString = @oScriptString + 'and I_58 = ''' + @iBlacklistNo  + ''''
	
	--統一編號/院所代碼
	IF(@iCompanyId IS NOT NULL AND @iCompanyId <> '') 
		SET @oScriptString = @oScriptString + 'and I_61 = ''' + @iCompanyId  + ''''
	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	--SELECT @oScriptString;
	EXEC( @oScriptString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowCancel]

	@iProcessUserId		Varchar(20),		--取消人
	@iBorrowId			Varchar(50)			--借調id
	
	--exec dbo.[ezAcquireFiling_BorrowCancel] '',''
AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus in ('11','12')	
	
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,FilingStatus,'03',@iProcessUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE DocumentID in (
		SELECT DocumentId from @DocumentIdTable
	)
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentId from @DocumentIdTable
	)
	
	--寫入取消資料
	UPDATE FilingBorrow 
	SET ReviewDate = getDate(),
	ReviewerUserId = @iProcessUserId,
	ReviewInstruction = 'C',
	FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentId from @DocumentIdTable
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturn]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReturn]

	@iProcessUserId		Varchar(20),		--歸還人
	@iBorrowId			Varchar(50),		--借調id
	@iReturnNote		Varchar(max)		--歸還備註	
	
	--exec dbo.ezAcquireFiling_BorrowReturn 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '14'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'14','15',@iProcessUserId 
	FROM @DocumentIdTable
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '15'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入傳送資料
	UPDATE FilingBorrow 
	SET ReturnDate = getDate(),
	ReturnUserId = @iProcessUserId,
	ReturnNote = @iReturnNote,
	FilingStatus = '15'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	) AND FilingStatus = '14'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCancel]

	@iProcessUserId		Varchar(20),		--歸檔人
	@iBorrowId			Varchar(50)			--借調id
	
	--exec dbo.ezAcquireFiling_BorrowReturnCheck 'ivy','1'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '15'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'15','14',@iProcessUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BorrowId = @iBorrowId
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '14'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入傳送資料
	UPDATE FilingBorrow 
	SET ReturnDate = '',
	ReturnUserId = '',
	ReturnNote = '歸還取消',
	FilingStatus = '14'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)AND FilingStatus = '15'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCancelQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCancelQuery]

	@iUserId		varchar(20)		-- 使用者
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowReturnCancelQuery 'a00351'
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	select * from vw_ezAcquire_FilingMaster 
	where FilingStatus = '15' 
	and ReturnUserId = @iUserId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCheck]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCheck]

	@iProcessUserId		Varchar(20),		--歸檔人
	@iBorrowId			Varchar(50),		--借調id
	@iReturnCheckNote	Varchar(max)		--歸檔備註	
	
	--exec dbo.ezAcquireFiling_BorrowReturnCheck 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '15'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'15','03',@iProcessUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BorrowId = @iBorrowId
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入傳送資料
	UPDATE FilingBorrow 
	SET ReturnCheckDate = getDate(),
	ReturnCheckUserId = @iProcessUserId,
	ReturnCheckNote = @iReturnCheckNote,
	FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)AND FilingStatus = '15'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnCheckQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnCheckQuery]

	@iBranch		varchar(20)		-- 分公司
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowReturnCheckQuery '88'
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	if(@iBranch <> '' and @iBranch is not null)
		select * from vw_ezAcquire_FilingMaster where FilingStatus = '15' and branch = @iBranch
	if(@iBranch = '' or @iBranch is null)
		select * from vw_ezAcquire_FilingMaster where FilingStatus = '15'
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReturnQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReturnQuery]

	@iUserId		varchar(20)		-- 分公司
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowReturnQuery '88'
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	select * from vw_ezAcquire_FilingMaster 
	where FilingStatus = '14' and BorrowUserId = @iUserId
	
	
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewApprove]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewApprove]

	@iProcessUserId		Varchar(20),		--覆核人
	@iBorrowId			Varchar(50),		--借調id
	@iApproveReason		Varchar(max)		--核准原因	
	
	--exec dbo.ezAcquireFiling_BorrowReviewApprove 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '11'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'11','12',@iProcessUserId 
	FROM @DocumentIdTable
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '12'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入覆核資料
	UPDATE FilingBorrow 
	SET ReviewDate = getDate(),
	ReviewerUserId = @iProcessUserId,
	ReviewNote = @iApproveReason,
	ReviewInstruction = 'Y',
	FilingStatus = '12'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	AND FilingStatus = '11'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewQuery]

	@iBranch		varchar(20),	-- 分公司
	@iQueryUserId		varchar(20)		-- 查詢者
	
	/*
	exec dbo.ezAcquireFiling_BorrowReviewQuery '88','a02045'
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	select * from vw_ezAcquire_FilingMaster 
	where FilingStatus = '11' 
	and ApplicantBranch = @iBranch	
	and ApplicantBusiness = (
	select BusinessTypeCode from UserBusinessTypeMap where userid = @iQueryUserId
	)
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowReviewReject]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowReviewReject]

	@iProcessUserId		Varchar(20),		--覆核人
	@iBorrowId			Varchar(50),		--借調id
	@iRejectReason		Varchar(max)		--核准原因	
	
	--exec dbo.ezAcquireFiling_BorrowReviewReject 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '11'	
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'11','03',@iProcessUserId 
	FROM @DocumentIdTable
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入覆核資料
	UPDATE FilingBorrow 
	SET ReviewDate = getDate(),
	ReviewerUserId = @iProcessUserId,
	ReviewNote = @iRejectReason,
	ReviewInstruction = 'N',
	FilingStatus = '03'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	AND FilingStatus = '11'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowSign]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowSign]

	@iProcessUserId		Varchar(20),		--覆核人
	@iBorrowId			Varchar(50),		--借調id
	@iSignNote		Varchar(max)			--簽收備註	
	
	--exec dbo.ezAcquireFiling_BorrowSign 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '13'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'13','14',@iProcessUserId 
	FROM @DocumentIdTable
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '14'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入簽收資料
	UPDATE FilingBorrow 
	SET BorrowDate = getDate(),
	BorrowUserId = @iProcessUserId,
	BorrowNote = @iSignNote,
	FilingStatus = '14'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	AND FilingStatus = '13'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowSignQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowSignQuery]

	--@iBranch		varchar(20)		-- 分公司
	
	@iUserId		varchar(20)		--使用者
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowSignQuery ''
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	select * from vw_ezAcquire_FilingMaster 
	where FilingStatus = '13' 
	AND ApplicantUSerid = @iUserId
	
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowTransfer]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowTransfer]

	@iProcessUserId		Varchar(20),		--覆核人
	@iBorrowId			Varchar(50),		--借調id
	@iProcessNote		Varchar(max)		--傳送備註	
	
	--exec dbo.ezAcquireFiling_BorrowTransfer 'ivy','1','12344567890'

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--建立暫存的Table
	DECLARE @DocumentIdTable TABLE
	(
		DocumentId		VARCHAR(max)				--相同歸檔號碼的文件
	)		
	
	--取得同一歸檔號下已借調的DocumentId	
	INSERT INTO @DocumentIdTable(DocumentId)
	SELECT DocumentId from vw_ezAcquire_FilingMaster 
	where FilingNumber = (
		SELECT FilingNumber from vw_ezAcquire_FilingMaster
		where BorrowId = @iBorrowId
	) AND FilingStatus = '12'
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'12','13',@iProcessUserId 
	FROM @DocumentIdTable
		
	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '13'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	
	--寫入傳送資料
	UPDATE FilingBorrow 
	SET ProcessDateTime = getDate(),
	ProcessorUserId = @iProcessUserId,
	ProcessNote = @iProcessNote,
	FilingStatus = '13'
	WHERE DocumentID in (
		SELECT DocumentID FROM @DocumentIdTable
	)
	AND FilingStatus = '12'
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BorrowId = @iBorrowId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_BorrowTransferQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_BorrowTransferQuery]

	@iBranch		varchar(20)		-- 分公司
	
	
	/*
	exec dbo.ezAcquireFiling_BorrowTransferQuery ''
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 傳出結果 *******************************/		

	if(@iBranch <> '' and @iBranch is not null)
		select * from vw_ezAcquire_FilingMaster where FilingStatus = '12' and branch = @iBranch

    if(@iBranch = 'AAA' and @iBranch is not null)
		select * from vw_ezAcquire_FilingMaster where FilingStatus in( '12' ,'11')
	if(@iBranch = '' or @iBranch is null)
		select * from vw_ezAcquire_FilingMaster where FilingStatus = '12'
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_ConfirmBagBatch]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_ConfirmBagBatch]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBatchNumberArr	Varchar(max)		--批次號碼陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_ConfirmBagBatch 'ivy','88BNUA0930101004|88BNUA0930101005'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得批次資料 *******************************/	
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BatchNumber			varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BatchNumber) EXEC dbo.sp_Common_SplitStr2Table @iBatchNumberArr;
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--更新批次	
	UPDATE FilingBatches 
	SET 
	ProcessUserId = @iFilingUserId,
	ProcessDateTime = GETDATE()
	WHERE BatchNumber IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
	
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'01','03',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM FilingBatches WHERE BatchNumber IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	);
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_Destruction]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_Destruction]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBagIdArr			Varchar(max)		--袋號陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_BagWarehouse 'ivy','NB1031200005|NB1031200004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得文件資料 *******************************/	
	
	--建立暫存檔:袋號資料
	CREATE TABLE #BagIdTmp
	(
		BagId			varchar(20)
	)			
	INSERT INTO #BagIdTmp(BagId) EXEC dbo.sp_Common_SplitStr2Table @iBagIdArr;
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BagId			varchar(20),
		BatchNumber		varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BagId,BatchNumber) 
	SELECT BAGID,BatchNumber FROM FilingBatches
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	
	
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,FilingStatus,'99',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '99'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_FilingCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_FilingCancel]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBagIdArr			Varchar(max)		--袋號陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_FilingCancel 'ivy','88BNUA0930101003|88BNUA0930101003|88BNUA0930101003|88BNUA0930101004|88BNUA0930101004|88BNUA0930101004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得袋號資料 *******************************/	
	
	--建立暫存檔:袋號資料
	CREATE TABLE #BagIdTmp
	(
		BagId			varchar(20)
	)			
	INSERT INTO #BagIdTmp(BagId) EXEC dbo.sp_Common_SplitStr2Table @iBagIdArr;
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BagId			varchar(20),
		BatchNumber		varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BagId,BatchNumber) 
	SELECT BAGID,BatchNumber FROM FilingBatches
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
		
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'03','01',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
	
	--更新批次資料
	UPDATE FilingBatches
	SET BagId = '',
	ProcessUserId = @iFilingUserId,
	ProcessDateTime = GETDATE()
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	
	
	--更新袋資料
	UPDATE FilingBag
	SET Warehouse = '',
	IsDestory = 'C',	
	FilingUserID = @iFilingUserId,
	FilingDate = GETDATE(),
	DestoryUserID = @iFilingUserId,
	DestoryDate = GETDATE()
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '01'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM FilingBag WHERE BAGID IN (SELECT BagId FROM #BagIdTmp) ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_FilingQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_FilingQuery]

	@iFilingTypeId		varchar(20),	--歸檔類別
	@iFilingStatus		varchar(20),	--歸檔狀態
	@iScanTypeId		varchar(20),	--掃描管道
	@iWarehouseCode		varchar(20),	--倉庫代碼
	
	@iBagId				varchar(20),	--袋號
	@iFilingNumber		varchar(20),	--歸檔號碼
	@iBatchNumber		varchar(20),	--批次號碼
	@iProcessDateTimeS	varchar(20),	--歸檔日期起
	@iProcessDateTimeE	varchar(20),	--歸檔日期迄
	
	@iPolicyId			varchar(20),	--保單號碼(Mutiple)
	@iPolicySerialNo	varchar(20),	--保單序號
	@iPOSNumber			varchar(20),	--契變案號(Mutiple)
	@iClaimNumber		varchar(20),	--理賠案號(Mutiple)
	@iPaidSerialNo		varchar(20),	--授權書流水號
	
	@iInsuredId			varchar(20),	--被保人ID
	@iMainId			varchar(20),	--要保人ID
	@iSalesId			varchar(20),	--業務員ID
	@iRegReceiveDate	varchar(20)		--掛號處理日期
	
	
	/*
	exec dbo.ezAcquireFiling_FilingQuery 
	'','15','','',

	'','','','2015-05-01','2015-05-25',
	'','','','','',
	'','','',''
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 組合查詢字串 *******************************/	
	
	DECLARE		@oScriptString		varchar(max);
	
	SET @oScriptString = 'select * from vw_ezAcquire_FilingMaster ' + 
						 'where DocumentId Is Not Null ' 
	
	--歸檔類別
	IF(@iFilingTypeId IS NOT NULL AND @iFilingTypeId <> '') 
		SET @oScriptString = @oScriptString + 'and FilingTypeId = ''' + @iFilingTypeId  + ''''
	--歸檔狀態
	IF(@iFilingStatus IS NOT NULL AND @iFilingStatus <> '') 
		SET @oScriptString = @oScriptString + 'and FilingStatus = ''' + @iFilingStatus  + ''''
	--掃描管道
	IF(@iScanTypeId IS NOT NULL AND @iScanTypeId <> '') 
		SET @oScriptString = @oScriptString + 'and ScanTypeId = ''' + @iScanTypeId  + ''''
	--倉庫代碼
	IF(@iWarehouseCode IS NOT NULL AND @iWarehouseCode <> '') 
		SET @oScriptString = @oScriptString + 'and WarehouseCode = ''' + @iWarehouseCode  + ''''
	
	--袋號
	IF(@iBagId IS NOT NULL AND @iBagId <> '') 
		SET @oScriptString = @oScriptString + 'and BagId = ''' + @iBagId  + ''''
	--歸檔號碼
	IF(@iFilingNumber IS NOT NULL AND @iFilingNumber <> '') 
		SET @oScriptString = @oScriptString + 'and FilingNumber = ''' + @iFilingNumber  + ''''
	--批次號碼
	IF(@iBatchNumber IS NOT NULL AND @iBatchNumber <> '') 
		SET @oScriptString = @oScriptString + 'and BatchNumber = ''' + @iBatchNumber  + ''''		
	--歸檔日期起
	IF(@iProcessDateTimeS IS NOT NULL AND @iProcessDateTimeS <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime >= ''' + @iProcessDateTimeS  + ' 00:00:00'' '	
	--歸檔日期迄
	IF(@iProcessDateTimeE IS NOT NULL AND @iProcessDateTimeE <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime <= ''' + @iProcessDateTimeE  + ' 23:59:59'' '
	
	--保單號碼
	IF(@iPolicyId IS NOT NULL AND @iPolicyId <> '') 
		SET @oScriptString = @oScriptString + 'and I_50 like ''%' + @iPolicyId  + '%'''
	--保單序號
	IF(@iPolicySerialNo IS NOT NULL AND @iPolicySerialNo <> '') 
		SET @oScriptString = @oScriptString + 'and I_51 = ''' + @iPolicySerialNo  + ''''
	--契變案號
	IF(@iPOSNumber IS NOT NULL AND @iPOSNumber <> '') 
		SET @oScriptString = @oScriptString + 'and I_52 like ''%' + @iPOSNumber  + '%'''
	--理賠案號
	IF(@iClaimNumber IS NOT NULL AND @iClaimNumber <> '') 
		SET @oScriptString = @oScriptString + 'and I_60 like ''%' + @iClaimNumber  + '%'''
	--授權書流水序號
	IF(@iPaidSerialNo IS NOT NULL AND @iPaidSerialNo <> '') 
		SET @oScriptString = @oScriptString + 'and I_49 = ''' + @iPaidSerialNo  + ''''
	
	--被保人ID
	IF(@iInsuredId IS NOT NULL AND @iInsuredId <> '') 
		SET @oScriptString = @oScriptString + 'and I_47 = ''' + @iInsuredId  + ''''
	--要保人ID
	IF(@iMainId IS NOT NULL AND @iMainId <> '') 
		SET @oScriptString = @oScriptString + 'and I_48 = ''' + @iMainId  + ''''
	--業務員ID
	IF(@iSalesId IS NOT NULL AND @iSalesId <> '') 
		SET @oScriptString = @oScriptString + 'and I_55 = ''' + @iSalesId  + ''''
	--掛號處理日期
	IF(@iRegReceiveDate IS NOT NULL AND @iRegReceiveDate <> '') 
		SET @oScriptString = @oScriptString + 'and I_53 = ''' + @iRegReceiveDate  + ''''
	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	--SELECT @oScriptString;
	EXEC( @oScriptString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_GetBagNumber]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_GetBagNumber]

	@iBagCode		char(2)	--歸檔部門代碼
				
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/***************************** 取得最新袋號加1 ******************************/	
	
	DECLARE		@MaxBagNumber		varchar(20);
	DECLARE		@ThisYear			varchar(20);
	DECLARE		@ThisMonth			varchar(20);
	DECLARE		@ThisNumber			varchar(20);
	
	
	--設定今年
	SET @ThisYear = (SELECT CONVERT(VARCHAR(3),(DATEPART(YEAR,GETDATE()) - 1911)));
	--設定本月
	SET @ThisMonth = (SELECT 
						CASE  
							WHEN DATEPART(MONTH,GETDATE()) < 10 THEN '0' + CONVERT(VARCHAR(1),DATEPART(MONTH,GETDATE()) )
							ELSE  CONVERT(VARCHAR(2),DATEPART(MONTH,GETDATE()) )
						END);
	
	--設定號碼
	SET @ThisNumber = @ThisYear + @ThisMonth;
	
	
	SET @MaxBagNumber = @iBagCode + 
						(SELECT 
							 CASE MAX(SUBSTRING(BAGID,3,5)) 
							 WHEN @ThisNumber THEN CONVERT(VARCHAR(10),(CONVERT(bigint,(MAX(SUBSTRING(BAGID,3,10)))) + 1))
							 ELSE @ThisNumber + '00001'
							 END
						FROM FILINGBAG where SUBSTRING(BAGID,1,2)= @iBagCode)
	
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select @MaxBagNumber AS MaxBagNumber
		
END



GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_MoveWarehouse]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_MoveWarehouse]

	@iWarehouseCode		varchar(20),	--倉庫代碼
	@iBagId				varchar(20),	--袋號
	@iProcessUserId		varchar(20)		--使用者代碼
	
	
	--exec dbo.ezAcquireFiling_MoveWarehouse '','',''
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 更新倉庫 *********************************/	
	
	--更新袋資料
	UPDATE FilingBag
	SET Warehouse = @iWarehouseCode,
	FilingUserID = @iProcessUserId,
	FilingDate = GETDATE()
	WHERE BagId = @iBagId
	
	--更新批次資料
	UPDATE FilingBatches
	SET ProcessUserId = @iProcessUserId,
	ProcessDateTime = GETDATE()
	WHERE BagId = @iBagId
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	SELECT * FROM FilingBag WHERE BagId = @iBagId
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_QueryWarehouseFiling]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_QueryWarehouseFiling]

	@iFilingTypeId		varchar(20),	--歸檔類別
	@iWarehouseCode		varchar(20),	--倉庫代碼
	@iBatchNumber		varchar(20),	--批次號碼
	@iBagId				varchar(20),	--袋號
	@iProcessDateTimeS	varchar(20),	--歸檔日期起
	@iProcessDateTimeE	varchar(20)		--歸檔日期迄
	
	
	--exec dbo.ezAcquireFiling_QueryWarehouseFiling '','','','','',''
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 組合查詢字串 *******************************/	
	
	DECLARE		@oScriptString		varchar(max);
	
	SET @oScriptString = 'select distinct ' + 
						 'FilingTypeId,FilingTypeName,WarehouseCode,WarehouseName,' +
						 'LimitDate,BagId,ProcessUserId,ProcessUserName,ProcessDateTime ' +
						 'from vw_ezAcquire_FilingMaster ' +
						 'where FilingStatus = ''03'' ' 
	
	--歸檔類別
	IF(@iFilingTypeId IS NOT NULL AND @iFilingTypeId <> '') 
		SET @oScriptString = @oScriptString + 'and FilingTypeId = ''' + @iFilingTypeId  + ''''
	
	--倉庫代碼
	IF(@iWarehouseCode IS NOT NULL AND @iWarehouseCode <> '') 
		SET @oScriptString = @oScriptString + 'and WarehouseCode = ''' + @iWarehouseCode  + ''''
	
	--批次號碼
	IF(@iBatchNumber IS NOT NULL AND @iBatchNumber <> '') 
		SET @oScriptString = @oScriptString + 'and BatchNumber = ''' + @iBatchNumber  + ''''
	
	--袋號
	IF(@iBagId IS NOT NULL AND @iBagId <> '') 
		SET @oScriptString = @oScriptString + 'and BagId = ''' + @iBagId  + ''''
	
	--歸檔日期起
	IF(@iProcessDateTimeS IS NOT NULL AND @iProcessDateTimeS <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime >= ''' + @iProcessDateTimeS  + ' 00:00:00'' '
	
	--歸檔日期迄
	IF(@iProcessDateTimeE IS NOT NULL AND @iProcessDateTimeE <> '') 
		SET @oScriptString = @oScriptString + 'and ProcessDateTime <= ''' + @iProcessDateTimeE  + ' 23:59:59'' '
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	EXEC( @oScriptString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_RecoverDestruction]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_RecoverDestruction]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBagIdArr			Varchar(max)		--袋號陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_RecoverDestruction 'ivy','NB1031200005|NB1031200004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得文件資料 *******************************/	
	
	--建立暫存檔:袋號資料
	CREATE TABLE #BagIdTmp
	(
		BagId			varchar(20)
	)			
	INSERT INTO #BagIdTmp(BagId) EXEC dbo.sp_Common_SplitStr2Table @iBagIdArr;
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BagId			varchar(20),
		BatchNumber		varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BagId,BatchNumber) 
	SELECT BAGID,BatchNumber FROM FilingBatches
	WHERE BAGID IN (SELECT BagId FROM #BagIdTmp)	
	
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	
	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'99','03',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '03'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM vw_ezAcquire_FilingMaster WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_SaveBagBatch]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_SaveBagBatch]

	@iBagId				Varchar(20),		--袋號
	@iWarehouse			Varchar(20),		--儲存倉庫
	@iLimitDate			Varchar(20),		--保存期限:5或空白
	@iFilingUserId		Varchar(20),		--歸檔人
	@iBatchNumberArr	Varchar(max)		--批次號碼陣列,用|區隔
	
	
	--exec dbo.ezAcquireFiling_SaveBagBatch 'NB1031200001','01','','ivy','88BNUA0930101004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得批次資料 *******************************/	
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BatchNumber			varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BatchNumber) EXEC dbo.sp_Common_SplitStr2Table @iBatchNumberArr;
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--保存期限
	DECLARE		@LimitDate		varchar(20);
	IF @iLimitDate <> '' 
		SET @LimitDate = (select convert(varchar(10),dateadd(year,convert(int,@iLimitDate),getdate()),111));
	
	--寫入袋號
	INSERT INTO FILINGBAG( BAGID,Warehouse,LimitDate,FilingUserID) VALUES(@iBagId,@iWarehouse,@LimitDate,@iFilingUserId);
	
	--更新批次	
	UPDATE FilingBatches 
	SET BagId = @iBagId,
	ProcessUserId = @iFilingUserId,
	ProcessDateTime = GETDATE()
	WHERE BatchNumber IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'00','01',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '01'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	exec dbo.ezAcquireFiling_ConfirmBagBatch @iFilingUserId,@iBatchNumberArr 

				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM FILINGBAG;
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_ScanTransferReport]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_ScanTransferReport]

	@iProcessDateS		Varchar(20),		--處理日期起
	@iProcessDateE		Varchar(20)			--處理日期迄
	
	--exec dbo.ezAcquireFiling_ScanTransferReport '',''	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	DECLARE @queryString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryString = 'SELECT Branch,BranchName,FilingTypeId,FilingTypeName,' + 
					   'sum(ScanPages) ScanPages,sum(TransferPages) TransferPages ' + 
					   'FROM vw_ezAcquire_FilingReport ' + 
					   'where Branch <> '''' '
	
	--處理日期起
	IF (@iProcessDateS IS NOT NULL AND @iProcessDateS <> '')
		SET @queryString = @queryString + ' AND ProcessDate >= ''' + @iProcessDateS + ''' '
	 
	--處理日期迄
	IF (@iProcessDateE IS NOT NULL AND @iProcessDateE <> '')
		SET @queryString = @queryString + ' AND ProcessDate <= ''' + @iProcessDateE + ''' '
	
	SET @queryString = @queryString + 'Group by Branch,BranchName,FilingTypeId,FilingTypeName ' + 
									  'Order by Branch,FilingTypeId'	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	EXEC (@queryString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_Transfer]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_Transfer]

	@iFilingUserId		Varchar(20),		--歸檔人
	@iBatchNumberArr	Varchar(max)		--批次號碼陣列,用|區隔
	
	--exec dbo.ezAcquireFiling_SaveBagBatch 'ivy','88BNUA0930101004'	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 取得批次資料 *******************************/	
	
	--建立暫存檔:批次資料
	CREATE TABLE #BatchNumberTmp
	(
		BatchNumber			varchar(20)
	)			
	INSERT INTO #BatchNumberTmp(BatchNumber) EXEC dbo.sp_Common_SplitStr2Table @iBatchNumberArr;
	delete #BatchNumberTmp where BatchNumber = ''
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	--更新批次	
	UPDATE FilingBatches 
	SET 
	ProcessUserId = @iFilingUserId,
	ProcessDateTime = GETDATE()
	WHERE BatchNumber IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--記錄歸檔狀況
	INSERT INTO FilingLog 
	(DocumentId,OriginalStatus,NewFilginStatus,ModifierUserId)
	SELECT DocumentID,'00','01',@iFilingUserId 
	FROM vw_ezAcquire_FilingMaster
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)

	--更新文件狀態
	UPDATE DocumentIndex
	SET FilingStatus = '01'
	WHERE BatchNumber  IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	)
				
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM DocumentIndex WHERE BatchNumber IN (
		SELECT BatchNumber FROM #BatchNumberTmp
	) ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[ezAcquireFiling_TransferFilingReport]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ezAcquireFiling_TransferFilingReport]

	@iProcessDateS		Varchar(20),		--處理日期起
	@iProcessDateE		Varchar(20)			--處理日期迄
	
	--exec dbo.ezAcquireFiling_TransferFilingReport '',''	

AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 寫入資料 *********************************/	
	
	DECLARE @queryString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryString = 'SELECT Branch,BranchName,FilingTypeId,FilingTypeName,' + 
					   'sum(TransferPages) TransferPages,sum(FilingPages) FilingPages ' + 
					   'FROM vw_ezAcquire_FilingReport ' + 
					   'where Branch <> '''' '
	
	--處理日期起
	IF (@iProcessDateS IS NOT NULL AND @iProcessDateS <> '')
		SET @queryString = @queryString + ' AND ProcessDate >= ''' + @iProcessDateS + ''' '
	 
	--處理日期迄
	IF (@iProcessDateE IS NOT NULL AND @iProcessDateE <> '')
		SET @queryString = @queryString + ' AND ProcessDate <= ''' + @iProcessDateE + ''' '
	
	SET @queryString = @queryString + 'Group by Branch,BranchName,FilingTypeId,FilingTypeName ' + 
									  'HAVING(sum(TransferPages) > 0 AND sum(FilingPages)> 0) ' +
									  'Order by Branch,FilingTypeId'	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	EXEC (@queryString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_Common_SplitStr2Table]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Common_SplitStr2Table]

	@SourceString	varchar(5000)	--傳入字串
	
AS
BEGIN
	SET NOCOUNT ON;			
	
	DECLARE @sValue VARCHAR(100)
		
	--建立暫存檔
	CREATE TABLE #TempTable
	(
		ResultValue	varchar(100)
	)	
			
	DECLARE Source_Data CURSOR FOR
		Select * From dbo.sp_Common_Split(@SourceString,'|')		
					
	OPEN Source_Data
		FETCH NEXT FROM Source_Data
		INTO @sValue
			
	WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO #TempTable(ResultValue) VALUES(@sValue)
			FETCH NEXT FROM Source_Data 
			INTO @sValue																		
		END

	CLOSE Source_Data
	DEALLOCATE Source_Data	
	
	select * from #TempTable	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_DropDefaultConstraint]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DropDefaultConstraint]
(
    @tableName nvarchar(50),
    @columnMame nvarchar(50)
)
AS
BEGIN
    -- first define variables
    declare @default sysname, @sql nvarchar(max)

    -- get name of default constraint
    select @default = name 
    from sys.default_constraints 
    where parent_object_id = object_id(@tableName)
    AND type = 'D'
    AND parent_column_id = (
        select column_id 
        from sys.columns 
        where object_id = object_id(@tableName)
        and name = @columnMame
    )
    -- create alter table command as string and run it
    set @sql = N'alter table ' + @tableName + ' drop constraint ' + @default
    exec sp_executesql @sql
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_APLQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_APLQuery]

	@QueryUserId		varchar(50),	--查詢者代碼
	@QueryIP			varchar(30),	--查詢者IP	
		
	@iFormId			Varchar(20),	--表單代碼
	@iScanDateS			Varchar(20),	--掃描日期起
	@iScanDateE			Varchar(20),	--掃描日期迄
	@iVersionCode		Varchar(30),	--要保書文號
	@iVersionName		Varchar(100),	--要保書版本名稱
	
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_APLQuery 
	'','',
	'','','','','',
	'','',''
	
	*/
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 查詢條款 *********************************/	
	
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryTableString = 'SELECT DocumentId,D.FormId,F.FormName,Pages,ScanDatetime,ScanType,ScanUserId,' + 
							'ISNULL(I_67,'''') VersionCode,ISNULL(I_68,'''') VersionName ' + 
							'FROM DocumentIndex d ' + 
							'LEFT JOIN Form F ON d.Formid = F.Formid ' +
							'WHERE Scantype = ''APL'' and DELETED = ''N'' '
	--表單代碼
	IF (@iFormId IS NOT NULL AND @iFormId <> '')
		SET @queryTableString = @queryTableString + ' AND D.FormId = ''' + @iFormId + ''' '
	
	--掃描日期起
	IF (@iScanDateS IS NOT NULL AND @iScanDateS <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime >= ''' + @iScanDateS + ' 00:00:00'' '
	
	--掃描日期迄
	IF (@iScanDateE IS NOT NULL AND @iScanDateE <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime <= ''' + @iScanDateE + ' 23:59:59'' '
	
	--要保書文號
	IF (@iVersionCode IS NOT NULL AND @iVersionCode <> '')
		SET @queryTableString = @queryTableString + ' AND I_67 = ''' + @iVersionCode + ''' '
	
	--要保書版本名稱
	IF (@iVersionName IS NOT NULL AND @iVersionName <> '')
		SET @queryTableString = @queryTableString + ' AND I_68 like ''%' + @iVersionName + '%'' '
	
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query APL IMAGE ' ;
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	--SELECT @queryTableString;
	EXEC(@queryTableString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_AppendScanCancel]

	@RequestUserId		varchar(50),	--取消者代碼
	@RequestIP			varchar(30),	--取消者IP	
		
	@iFilingNumber		Varchar(20),	--補掃案件的歸檔號碼
	--@iRequestReason		Varchar(20),	--取消原因
	
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_AppendScanCancel 
	'jacky','',
	'88BNUA104010800013','不想掃',
	'','',''	
	*/

	/*
	功能說明：
	1.更新AppendScanQueue
	2.更新DocumentIndex.I_36 = 取消原因
	3.寫入AuditLog,OperationCode = 32
	*/


AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);			--寫入AuditLog的文字描述
	DECLARE @rAppendScanQueueId	int;			--補掃序號
	
	SET @oDescription = @RequestUserId + ' AppendScanQueue Cancel FilingNumber= ' + @iFilingNumber ;
	SET @rAppendScanQueueId = (SELECT max(TaskId) FROM AppendScanQueue WHERE FilingNumber = @iFilingNumber);
		
/****************************************************************************/
/************************* 判斷實體文件狀態 *********************************/	
	
	--更新RescanQueue
	UPDATE AppendScanQueue 
	SET [Status] = 'C',
	RequestReason = '' --RequestReason + ',' + @RequestUserId + ': ' + @iRequestReason
	WHERE TaskId = @rAppendScanQueueId
		
/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
    INSERT INTO ezAcquireAudit.dbo.AuditLog (
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString
    ) Values (
		@RequestIP, @RequestUserId,@OperatedSystem,'35', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'35',@oDescription,@DocAuditCode)
    )
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * FROM AppendScanQueue WHERE TaskId = @rAppendScanQueueId ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanCompleted]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_AppendScanCompleted]

	@iFilingNumber		Varchar(20),	--補掃案件的歸檔號碼
	
	@OperatedSystem		varchar(50),	--操作系統
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_AppendScanCompleted 
	'88BNUA104010800013',
	'','',''	
	*/

/*
功能說明：
1.更新AppendScan
2.寫入AuditLog,OperationCode = 36
*/

AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription		varchar(max);	--寫入AuditLog的文字描述
	DECLARE @rAppendScanQueueId	int;			--補掃序號
	
	SET @oDescription = ' AppendScanQueue Completed FilingNumber= ' + @iFilingNumber ;
	SET @rAppendScanQueueId = (SELECT max(TaskId) FROM AppendScanQueue WHERE FilingNumber = @iFilingNumber);
	
		
/****************************************************************************/
/********************************* 更新資料 *********************************/	
	
	--更新RescanQueue
	UPDATE AppendScanQueue 
	SET [Status] = 'F'
	WHERE TaskId = @rAppendScanQueueId	
	
/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@OperatedSystem,'36', 
       	@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random('','36',@oDescription,@iDocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		SELECT * FROM AppendScanQueue WHERE TaskId = @rAppendScanQueueId ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_AppendScanRequest]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_AppendScanRequest]

	@RequestUserId		varchar(50),	--請求者代碼
	@RequestIP			varchar(30),	--請求者IP	
		
	@iBranch			Varchar(20),	--分公司代碼
	@iFilingNumber		Varchar(20),	--補掃案件的歸檔號碼
	@iIndexData			Varchar(max),	--索引資料
	
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_AppendScanRequest 
	'a02045','10.1.104.34:52676',
	'88','61ANBB104052800001','{[Branch],[61]},{[IsRescan],[]},{[DocOrder],[]},{[IsBadDoc],[N]},{[IsReject],[]},{[Remark],[]},{[ReplaceKey],[]},{[DocName],[]},{[AccidentDate],[]},{[AccidentId],[]},{[ClauseId],[]},{[ClauseName],[]},{[ClmReceiveDate],[]},{[CloseDate],[]},{[ComplainNum],[]},{[ComplainNumber],[]},{[InsuredId],[N123109375]},{[MainId],[]},{[PaidSerialNo],[]},{[PolicyId],[1010212969|1010212978]},{[PolicySerialNo],[A102011010]},{[POSNumber],[]},{[RegReceiveDate],[]},{[RegSendDate],[]},{[SalesId],[]},{[SName],[]},{[VaryDate],[]},{[BlacklistNo],[]},{[BoxNo],[]},{[ClaimNumber],[]},{[CompanyId],[]},{[CompanyName],[]},{[ClauseUploadUser],[]},{[SalesNote],[]},{[SalesNoteUser],[]},{[BlacklistName],[]},{[VersionCode],[]},{[VersionName],[]},{[ReplaceDocId],[]},{[SalesNoteDate],[]},{[ProcessUser],[許ｘ純]},{[BatchNumber],[88AAPN1040529001]},{[FilingNumber],[61ANBB104052800001]}',
	'ImageQuery','','982e09ed-e08a-4566-8e4e-758eba02ccd8'
	
	*/

/*
功能說明：
1.可重掃條件:
  (1)判斷實體文件狀態,必須為00-待歸檔,11-借調申請,12-借調覆核,13-借調傳送,14-借調中
  (2)借調時,補掃請求人必須為借調申請人
  (3)此歸檔號碼不能已要求補掃
2.寫入資料
  (1)AppendScanQueue
  (2)寫入AuditLog,OperationCode = 34
3.回傳訊息代碼及訊息文字:
  0:補掃請求成功,補掃序號= xxx
  1:文件歸檔狀態必須為借調或待歸檔 / 補掃請求人必須為借調申請人 

*/

AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription	varchar(max);	--寫入AuditLog的文字描述
	DECLARE @rCode			Varchar(100);	--補掃要求的結果
	DECLARE @rMegText		Varchar(100);	--補掃要求的文字描述

	SET @oDescription = @RequestUserId + ' AppendScan Request FilingNumber= ' + @iFilingNumber ;
	SET @rMegText = '';
		
/****************************************************************************/
/************************* 判斷實體文件狀態 *********************************/	
	
	--判斷實體文件狀態是否為借調	
	SET @rMegText = (
		SELECT TOP 1 CASE 
		WHEN FilingStatus NOT IN ('00','11','12','13','14') THEN '文件歸檔狀態必須為借調或待歸檔'
		WHEN ( FilingStatus <> '00' AND ApplicantUserId <> @RequestUserId) THEN '補掃請求人必須為借調申請人'
		ELSE '' 
		END MegText
		FROM vw_ezAcquire_FilingMaster  
		WHERE FilingNumber = @iFilingNumber
	)

	--此歸檔號碼不能已要求補掃
	IF (@rMegText = '')
		BEGIN
			SET @rMegText = ( SELECT CASE count(*) WHEN 1 THEN '此歸檔號碼已要求補掃' ELSE ''END 
			FROM AppendScanQueue 
			WHERE FilingNumber =  @iFilingNumber
			AND [Status] = 'U'
			)
		END

	--狀態不為借調,不可補掃
	IF (@rMegText <> '')
		BEGIN
			SET @oDescription = @oDescription + ' ,不可補掃,' + @rMegText;
			SET @rCode = '1'
		END
	
	--狀態為借調,可補掃
	
	IF (@rMegText = '')
		BEGIN
			SET @rCode = '0'

			DECLARE @qBagId Varchar(20);
	
			SET @qBagId = (select distinct BagId from vw_ezAcquire_FilingMaster WHERE FilingNumber = @iFilingNumber  and BagId <> '');
			
			--寫入AppendScanQueue
			
			Insert Into AppendScanQueue (
				Branch,FilingNumber,RequestUser,IndexData,BagId)
			Values(
				@iBranch,@iFilingNumber,@RequestUserId,@iIndexData,@qBagId);
		
			SET @rMegText = '補掃請求成功,補掃序號:' + CONVERT(VARCHAR ,(SELECT TOP 1 TaskId FROM AppendScanQueue ORDER BY TaskId DESC))
		END	
	
/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@RequestIP, @RequestUserId,@OperatedSystem,'34', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'34',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		SELECT @rCode AS ResultCode, @rMegText AS ResultText ;
			
END
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_BLSQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_BLSQuery]

	@QueryUserId		varchar(50),	--查詢者代碼
	@QueryIP			varchar(30),	--查詢者IP	
		
	@iFormId			Varchar(20),	--表單代碼
	@iScanDateS			Varchar(20),	--掃描日期起
	@iScanDateE			Varchar(20),	--掃描日期迄
	@iBlacklistNo		Varchar(10),	--建檔序號
	@iBlacklistName		Varchar(30),	--姓名
	
	@OperatedSystem		varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_BLSQuery 
	'','',
	'','','','','',
	'','',''
	
	*/
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 查詢條款 *********************************/	
	
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryTableString = 'SELECT DocumentId,D.FormId,F.FormName,Pages,ScanDatetime,Scantype,' + 
							'ISNULL(I_58,'''') BlacklistNo,ISNULL(I_66,'''') BlacklistName,' + 
							'ISNULL(I_34,'''') IsBadDoc,ISNULL(IsRescan,'''') IsRescan ' + 
							'FROM DocumentIndex d ' + 
							'LEFT JOIN Form F ON d.Formid = F.Formid ' +
							'WHERE Scantype = ''BLS'' '
	--表單代碼
	IF (@iFormId IS NOT NULL AND @iFormId <> '')
		SET @queryTableString = @queryTableString + ' AND D.FormId = ''' + @iFormId + ''' '
	
	--掃描日期起
	IF (@iScanDateS IS NOT NULL AND @iScanDateS <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime >= ''' + @iScanDateS + ' 00:00:00'' '
	
	--掃描日期迄
	IF (@iScanDateE IS NOT NULL AND @iScanDateE <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime <= ''' + @iScanDateE + ' 23:59:59'' '
	
	--建檔序號
	IF (@iBlacklistNo IS NOT NULL AND @iBlacklistNo <> '')
		SET @queryTableString = @queryTableString + ' AND I_58 = ''' + @iBlacklistNo + ''' '
	
	--姓名
	IF (@iBlacklistName IS NOT NULL AND @iBlacklistName <> '')
		SET @queryTableString = @queryTableString + ' AND DocumentId In ( select documentId from MultipleIndex_I_66 where IndexValue like ''%' + @iBlacklistName + '%'') '
	
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query BLS IMAGE ' ;
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	--SELECT @queryTableString;
	EXEC(@queryTableString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Clause_ClauseQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Clause_ClauseQuery]
	
	@QueryUserId	varchar(50),	--查詢者代碼
	@QueryIP		varchar(30),	--查詢者IP	
	
	@iClauseId		varchar(20),	--查詢的條款代碼
	@iClauseName	varchar(500),	--查詢的條款名稱
	
	@OperatedSystem	varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	@DocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_Clause_ClauseQuery 
	'Ivy','10.10.10.1',
	'001','',
	'ImageQuery_Form','22334556','as'
	*/

AS

BEGIN
	SET NOCOUNT ON;
/****************************************************************************/
/********************************* 查詢條款 *********************************/	
	
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryTableString = 'Select DocumentID,Pages,Formid,Scantype,ScanUserId,ScanDateTime,MimeType,I_41,I_42,I_63,Status ' + 
							'from DocumentIndex where FormId = ''CLU001'' and Deleted = ''N'' '
	
	
	
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query ClauseId like ' + @iClauseId + ' or ClauseName like ' + @iClauseName;
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	--SELECT @queryTableString;
	EXEC(@queryTableString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_DataExchange_getDataByKey]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_DataExchange_getDataByKey]
	
	@iScantypeId		varchar(50),		--掃描管道
	@iIndexFieldArr		varchar(max),		--索引值欄位陣列
	@iIndexValueArr		varchar(max)		--索引值內容陣列
AS
BEGIN
	
	SET NOCOUNT ON;
	DECLARE @sqlStr 		varchar(max);
	DECLARE @ColumnStr 		varchar(max);
	DECLARE @condistionStr 	varchar(max);
	DECLARE @sFieldName 	VARCHAR(100);
	DECLARE @sIndexValue	VARCHAR(100);

	CREATE TABLE #FieldTable
	(
		RowNum				int,
		IndexFieldName		varchar(50),
		IndexValue			varchar(50)
	)

	/***********************************************************
		根據傳入的ScantypeId和IndexFieldName，
		放入暫存Table : #FieldTable中。
		傳入的ScanType若查無資料,查ScanType = 'ALL'的Index
	***********************************************************/

	SET @sqlStr = 'select a.ColumnNumber,a.IndexFieldName,c.splitValue IndexValue '
					+ ' from vw_ezAcquire_DataExchangeFieldName a left outer join '
					+ ' (SELECT Rownum = (SELECT COUNT(1) FROM dbo.fnc_split(''' 
					+ @iIndexFieldArr + ''','','') WHERE splitValue <= d.splitValue), '
					+ 'splitValue FROM dbo.fnc_split(''' + @iIndexFieldArr + ''','','') d ) b  '
					+ 'on a.IndexFieldName = b.splitValue left outer join ' 
					+ ' (SELECT Rownum = (SELECT COUNT(1) FROM dbo.fnc_split(''' 
					+ @iIndexValueArr + ''','','') WHERE splitValue <= e.splitValue), '
					+ 'splitValue FROM dbo.fnc_split(''' + @iIndexValueArr + ''','','') e ) c '
					+ 'on b.Rownum = c.Rownum  '
					+ 'where a.scantypeId = ''' + @iScantypeId + ''' order by a.ColumnNumber' 		
					
	INSERT INTO #FieldTable (RowNum,IndexFieldName,IndexValue) execute(@sqlStr);
	
	--select * from #FieldTable
	--select @sqlStr
	/***********************************************************
		根據欄位I_xx和傳入的值，至DataExchange查出符合的資料。
		列出的欄位名稱為DisplayName,
		列出的欄位內容為[TABLE]IndexExchangeMap中的設定,
		列出的欄位值為[TABLE]DataExchange內的資料
	***********************************************************/

	
	SET @sqlStr = '';
	SET @ColumnStr = '';
	SET @condistionStr = '';
	
	DECLARE ExchangeData_Cursor CURSOR FOR
		select IndexFieldName,IndexValue from #FieldTable order by RowNum
	OPEN ExchangeData_Cursor
	
	FETCH NEXT FROM ExchangeData_Cursor
		INTO @sFieldName,@sIndexValue;
		
		WHILE @@FETCH_STATUS = 0
		BEGIN			
			IF @ColumnStr = ''  
				SET @ColumnStr = @sFieldName 
			ELSE 
				SET @ColumnStr = @ColumnStr + ',' + @sFieldName + ' '
			
			IF @sIndexValue IS NOT NULL
				SET @condistionStr = @condistionStr + ' and ' + @sFieldName + ' = ''' + @sIndexValue + ''' '
			FETCH NEXT FROM ExchangeData_Cursor
			INTO @sFieldName,@sIndexValue;			 	
		END;
	CLOSE ExchangeData_Cursor;
	DEALLOCATE ExchangeData_Cursor;

	IF @ColumnStr = '' SET @ColumnStr = '*' 

	SET @sqlStr = 'SELECT ' + @ColumnStr + ' FROM DataExchange WHERE SCANTYPEID =''' + @iScantypeId + ''' ' + @condistionStr

	--select @sqlStr;
	
	EXECUTE(@sqlStr); 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Delete_Form]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Delete_Form]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iFormId		varchar(100)	--刪除的表單代碼
AS
BEGIN
	SET NOCOUNT ON;	
	
	DECLARE @ResultStr varchar(500);

/****************************************************************************/
/****************************** 表單代碼 **********************************/	


	--傳入的表單代碼為NULL
	IF  @iFormId IS NULL 
		SET @ResultStr = 'Input FormId is NULL'
	
	--傳入的表單代碼為空字串
	IF  @iFormId = ''	
		SET @ResultStr = 'Input FormId is '''' '	

	IF  @iFormId IS NOT NULL AND @iFormId <> ''
	BEGIN			
			
		DECLARE @UCount smallint;
		SET @UCount = (Select count(*) from FormGroupMap where FormId = @iFormId)

		--表單代碼已設定群組
		IF @UCount > 0 
			SET @ResultStr = 'This FormId has FormGroup,CAN NOT Deleted!'

		--表單代碼無設定群組
		IF @UCount = 0
		BEGIN
					
			SET @UCount = (Select count(*) from Form where FormId = @iFormId)
			
			--表單代碼不存在
			IF @UCount = 0
				SET @ResultStr = 'This FormId is not exist!'

			IF @UCount > 0 
			BEGIN
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					[Description])
				VALUES(
					@OperatorIP,@OperatorUserId,'Script','16',           
       				@OperatorUserId + ' Delete Form FormId = ' + @iFormId)
					
				SET @ResultStr = ''
			END	
		END	
	END
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT @ResultStr AS ResultString
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Delete_User]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Delete_User]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iUserId		varchar(100)	--刪除的使用者代碼
AS
BEGIN
	SET NOCOUNT ON;	
	
	DECLARE @ResultStr varchar(500);

/****************************************************************************/
/****************************** 使用者代碼 **********************************/	
	
	--傳入的使用者代碼為NULL
	IF  @iUserId IS NULL 
		SET @ResultStr = 'Input UserId is NULL'
	
	--傳入的使用者代碼為空字串
	IF  @iUserId = ''	
		SET @ResultStr = 'Input UserId is '''' '	

	IF  @iUserId IS NOT NULL AND @iUserId <> ''
	BEGIN			
			
		DECLARE @UCount smallint;
		SET @UCount = (Select count(*) from UserRoleMap where UserId = @iUserId)

		--使用者代碼已設定角色
		IF @UCount > 0 
			SET @ResultStr = 'This UserId has Role,CAN NOT Deleted!'

		--使用者代碼無設定角色
		IF @UCount = 0
		BEGIN
					
			SET @UCount = (Select count(*) from [User] where UserId = @iUserId)
			
			--使用者代碼	不存在
			IF @UCount = 0
				SET @ResultStr = 'This UserId is not exist!'

			IF @UCount > 0 
			BEGIN
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					[Description])
				VALUES(
					@OperatorIP,@OperatorUserId,'Script','15',           
       				@OperatorUserId + ' Delete User UserId = ' + @iUserId)
				
				DELETE [User] WHERE UserId = @iUserId
					
				SET @ResultStr = ''
			END	
		END	
	END
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT @ResultStr AS ResultString
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Form_ManageInsertMap]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	                	
	@iFormId			nvarchar(20),	--新增的表單代碼
	@iFormName			nvarchar(100),	--新增的表單名稱
	@iPageCount			tinyint,		--頁碼
	@iOMR				char(1),		--OMR辨識:[0]否 [1]是
	@iICR 				char(1),		--ICR辨識:[0]否 [1]是	
	@iOCR 				char(1),		--OCR辨識:[0]否 [1]是	
	@iSplit	 			tinyint,		--分割數,預設為1
	@iSavePages 		varchar(100),	--存檔頁次	
	@iPageSeqence		varchar(100),	--頁面順序	
	@iSecurity			char(1),		--敏感性表單:[0]否 [1]是
	@iSave				char(1),		--是否存檔：Y/N
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************** 新增表單 **********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert Form FormId=' +  @iFormId;

	INSERT INTO Form
	(FormId,FormName,[PageCount],OMR,ICR,OCR,SplitFlg,SavePages,[Security],SplitSeq,SaveFlg)
    VALUES
    (@iFormId,@iFormName,@iPageCount,@iOMR,@iICR,@iOCR,@iSplit,@iSavePages,@iSecurity,@iPageSeqence,@iSave)
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormId,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','6',           
       		@iFormId,
			@iFormId,'',@iFormId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'6',@oDescription,@iDocAuditCode)
	)
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from Form where FormId = @iFormId
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Form_ManageModifyMap]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iFormId			nvarchar(20),	--修改的表單代碼
	@iFormName			nvarchar(100),	--修改的表單名稱
	
	@iPageCount			int,			--頁碼
	@iOMR				char(1),		--OMR辨識:[0]否 [1]是
	@iICR 				char(1),		--ICR辨識:[0]否 [1]是	
	@iOCR 				char(1),		--OCR辨識:[0]否 [1]是	
	@iSplit	 			int,			--分割數,預設為1
	
	@iSavePages 		varchar(100),	--存檔頁次
	@iPageSeqence		varchar(100),	--頁面順序		
	@iSecurity			char(1),		--敏感性表單:[0]否 [1]是
	@iSave				char(1),		--是否存檔:Y/N
		
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 修改表單LOG ********************************/	
	DECLARE @oDescription  varchar(max)
		
	SET @oDescription = @OperatorUserId + ' Update Form FormId=' +  @iFormId;

/****************************************************************************/
/******************************** 修改表單 **********************************/	
	UPDATE Form
	SET FormName = @iFormName,
		[PageCount] = @iPageCount,
		OMR = @iOMR,
		ICR = @iICR,
		OCR = @iOCR,
		SplitFlg = @iSplit,
		SavePages = @iSavePages,
		SplitSeq = @iPageSeqence,
		[Security] = @iSecurity,
		[SaveFlg] = @iSave
	WHERE FormId = @iFormId
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormId,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','6',           
       		@iFormId,
			@iFormId,@iFormId,@iFormId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'6',@oDescription,@iDocAuditCode)
	)
  
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from Form where FormId = @iFormId
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Form_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Form_ManageQuery]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(50),	--操作者IP
	
	@targetFormId		varchar(50),	--被查詢表單代碼
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
		
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Form TargetFormId =' + @targetFormId;
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
	    FormId,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','7',           
		@targetFormId,@targetFormId,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'7',@oDescription,@iDocAuditCode)
	)	
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageDeleteForm]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageDeleteForm]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iFormGroupCode	nvarchar(20),	--刪除的表單群組代碼
	@iFormId		varchar(1000),	--刪除的表單代碼
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 刪除表單 *********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Delete Form From FormGroup FormGroupCode=' +  @iFormGroupCode + ' And FormId=' + @iFormId;
	

	DELETE FormGroupMap WHERE FormGroupCode = @iFormGroupCode AND FormId = @iFormId
	
	--修改LOG
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		FormId,FormGroupCode,TransactionTatget,TransactionBefore,TransactionAfter,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','8',           
       	@iFormId,@iFormGroupCode,@iFormGroupCode,@iFormId,'',
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription,@iDocAuditCode)
)		

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormGroupCode as FormGroupCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageInsertMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iFormGroupCode	nvarchar(20),	--新增的表單群組代碼
	@iFormGroupName	nvarchar(100),	--新增的表單群組名稱
	@iBusinessType	varchar(max),	--業務類別

	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 新增集合 *********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert FormGroup FormGroupCode=' +  @iFormGroupCode + ' AND BusinessType = ' + @iBusinessType ;
	
	INSERT INTO FormGroup (FormGroupCode,FormGroupName) VALUES (@iFormGroupCode,@iFormGroupName)
	
	IF @iBusinessType IS NOT NULL AND @iBusinessType <> ''
		INSERT INTO FormGroupBusinessTypeMap(FormGroupCode,BusinessTypeCode) VALUES (@iFormGroupCode,@iBusinessType)

	--新增群組：寫入Log
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        FormGroupCode,TransactionTatget,TransactionBefore,TransactionAfter,
        [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','8',           
       	@iFormGroupCode,@iFormGroupCode,'',@iFormGroupCode,
        @oDescription,@iDocAuditCode,@iSessionId,
        dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription,@iDocAuditCode)
	)
	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormGroupCode as FormGroupCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageModify]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP	varchar(30),		--操作者IP
	
	@iFormGroupCode	nvarchar(20),	--修改的表單群組代碼
	@iFormGroupName	nvarchar(100),	--修改的表單群組名稱
	@iFormIdArr		varchar(max),	--本次修改後的表單編號清單
	@iBusinessType	varchar(max),	--業務類別
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/******************************* 修改群組名稱 *******************************/	
	
	UPDATE FormGroup SET FormGroupName = @iFormGroupName WHERE FormGroupCode = @iFormGroupCode
	
/****************************************************************************/
/******************************* 修改業務類別 *******************************/	

	IF @iBusinessType IS NOT NULL AND @iBusinessType <> ''
		BEGIN
			DELETE FormGroupBusinessTypeMap WHERE FormGroupCode = @iFormGroupCode
			INSERT INTO FormGroupBusinessTypeMap(FormGroupCode,BusinessTypeCode) VALUES (@iFormGroupCode,@iBusinessType)
		END

/****************************************************************************/
/******************************* 表單編號清單 *******************************/	
	--傳入空白表示刪除所有的表單
	IF  @iFormIdArr = ''
		BEGIN			
			
		DELETE FormGroupMap WHERE FormGroupCode = @iFormGroupCode
	
		--修改LOG

		SET @oDescription = @OperatorUserId + ' Delete AllForm From FormGroup FormGroupCode=' +  @iFormGroupCode;
			
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperationDate,OperatedSystem,OperationFunction,
			FormGroupCode,TransactionTatget,
			[Description],DocAuditCode,SessionId,RandomString
		)VALUES(
			@OperatorIP,@OperatorUserId,GETDATE(),'SystemAdmin','8',           
       		@iFormGroupCode,@iFormGroupCode,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription,@iDocAuditCode)
		)		
		
		END
	ELSE
		BEGIN			
	
			--建立暫存檔:儲存表單編號
			CREATE TABLE #FormIdTmp
			(
				FormId		varchar(20),
				ModifyStatus	char(1)
			)			
			INSERT INTO #FormIdTmp(FormId) EXEC dbo.sp_Common_SplitStr2Table @iFormIdArr;
			
			--本次無異動者
			UPDATE #FormIdTmp 
			SET ModifyStatus = 'N'
			WHERE FormId IN(
			SELECT FormId FROM FormGroupMap 
			WHERE FormGroupCode = @iFormGroupCode
			AND FormId IN (
				SELECT FormId FROM #FormIdTmp
			))
			
			--本次新增者
			UPDATE #FormIdTmp 
			SET ModifyStatus = 'A'
			WHERE FormId IN(
			SELECT FormId FROM #FormIdTmp 
			WHERE FormId NOT IN (
				SELECT FormId FROM FormGroupMap
				WHERE FormGroupCode = @iFormGroupCode
			))
			
			--本次刪除者
			INSERT INTO #FormIdTmp(FormId,ModifyStatus)
			SELECT FormId,'D' FROM FormGroupMap 
			WHERE FormGroupCode = @iFormGroupCode
			AND FormId NOT IN(
				SELECT FormId FROM #FormIdTmp 
			)
			
			--刪除：表單編號
			DELETE FormGroupMap 
			WHERE FormGroupCode = @iFormGroupCode
			AND FormId IN (
				SELECT FormId FROM #FormIdTmp WHERE ModifyStatus = 'D'
			)

			SET @oDescription = @OperatorUserId + ' Delete Form From FormGroup FormGroupCode=' +  @iFormGroupCode + ' And FormId = ';
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
				OperatorIP,OperatorUserId,OperationDate,OperatedSystem,OperationFunction,
				FormId,FormGroupCode,TransactionTatget,TransactionBefore,
				[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,GETDATE(),'SystemAdmin','8',           
       				FormId,@iFormGroupCode,@iFormGroupCode,FormId,
					@oDescription + FormId,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription + FormId,@iDocAuditCode)
			FROM #FormIdTmp WHERE ModifyStatus = 'D' 
		
		END
	
		
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormGroupCode as FormGroupCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageModifyForm]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageModifyForm]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iFormGroupCode		nvarchar(20),	--修改的表單群組代碼
	@iFormId			varchar(1000),	--修改的表單代碼
	@iQueryPages		varchar(100),	--查詢頁次
	@iPrintRights		char(1),		--列印權限
	@iPrintPages		varchar(100),	--列印頁次
	@iOrderSerial		smallint,		--排列順序	
	@iAnnotationView	char(1),		--註記檢視權限:[0]否 [1]是
	@iAnnotationEdit	char(1), 		--註記編輯權限:[0]否 [1]是
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 修改表單 *********************************/	
	
	--查詢是否己存在
	DECLARE @formCount smallint;
	DECLARE	@oDescription varchar(max);

	SET @formCount = (SELECT COUNT(*) FROM FormGroupMap WHERE FormId = @iFormId AND FormGroupCode = @iFormGroupCode )
	
	--新增
	IF @formCount = 0 
		BEGIN
			
			INSERT INTO FormGroupMap
				(FormGroupCode,FormId,QueryPages,PrintRights,PrintPages,OrderSerial,AnnotationView,AnnotationEdit) 
			VALUES 
				(@iFormGroupCode,@iFormId,@iQueryPages,@iPrintRights,@iPrintPages,@iOrderSerial,@iAnnotationView,@iAnnotationEdit)
				
			SET @oDescription = @OperatorUserId + ' Insert Form Into FormGroup FormGroupCode=' +  @iFormGroupCode + ' And FormId=' + @iFormId;

			--新增LOG
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					FormId,FormGroupCode,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString
				)VALUES(
					@OperatorIP,@OperatorUserId,'SystemAdmin','8',           
       				@iFormId,@iFormGroupCode,@iFormGroupCode,'',@iFormId,
					@oDescription,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription,@iDocAuditCode)
				)			
			
		END
	--修改
	ELSE
		BEGIN
			
			DELETE FormGroupMap 
			WHERE FormGroupCode = @iFormGroupCode 
			AND FormId = @iFormId
			
			INSERT INTO FormGroupMap(FormGroupCode,FormId,QueryPages,PrintPages,PrintRights,OrderSerial,AnnotationView,AnnotationEdit)
			VALUES (@iFormGroupCode, @iFormId,@iQueryPages,@iPrintPages,@iPrintRights,@iOrderSerial,@iAnnotationView,@iAnnotationEdit)

			/*
			UPDATE FormGroupMap
			SET QueryPages = @iQueryPages,
				PrintPages = @iPrintPages,
				PrintRights=@iPrintRights,
				OrderSerial=@iOrderSerial,
				AnnotationView = @iAnnotationView,
				AnnotationEdit = @iAnnotationEdit
			WHERE FormGroupCode = @iFormGroupCode 
			AND FormId = @iFormId
			*/
			SET @oDescription = @OperatorUserId + ' Modify Form From FormGroup FormGroupCode=' +  @iFormGroupCode + ' And FormId=' + @iFormId;

			--修改LOG
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					FormId,FormGroupCode,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString
			)VALUES(
					@OperatorIP,@OperatorUserId,'SystemAdmin','8',           
       				@iFormId,@iFormGroupCode,@iFormGroupCode,@iFormId,@iFormId,
					@oDescription,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'8',@oDescription,@iDocAuditCode)
			)	
				
		END

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormGroupCode as FormGroupCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormGroup_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormGroup_ManageQuery]

	@OperatorUserId			varchar(50),	--操作者代碼
	@OperatorIP				varchar(50),	--操作者IP
	
	@targetFormGroupCode	varchar(50),	--被查詢表單群組
	@iDocAuditCode			varchar(100),	--傳入的檢核碼
	@iSessionId				varchar(100)	--SessionId
		
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Form TargetFormGroupCode =' + @targetFormGroupCode;
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
	    FormGroupCode,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','9',           
	    @targetFormGroupCode,@targetFormGroupCode,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'9',@oDescription,@iDocAuditCode)
	)	
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageInsert]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iFormSetCode	nvarchar(20),	--新增的表單集合代碼
	@iFormSetName	nvarchar(100),	--新增的表單集合名稱

	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 新增集合 *********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert FormSet FormSetCode=' +  @iFormSetCode;
	
	INSERT INTO FormSets (FormSetCode,FormSetName) VALUES (@iFormSetCode,@iFormSetName)
	
	--新增集合：寫入Log
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        FormSetCode,TransactionTatget,TransactionBefore,TransactionAfter,
        [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','20',           
       	@iFormSetCode,@iFormSetCode,'',@iFormSetCode,
        @oDescription,@iDocAuditCode,@iSessionId,
        dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'20',@oDescription,@iDocAuditCode)
	)
	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormSetCode as FormSetCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageModify]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),		--操作者IP
	
	@iFormSetCode	nvarchar(20),	--修改的表單集合代碼
	@iFormSetName	nvarchar(100),	--修改的表單集合名稱
	@iItemArr		nvarchar(max),	--修改的項目
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/********************************* 修改集合 *********************************/	
	
	UPDATE FormSets SET FormSetName = @iFormSetName WHERE FormSetCode = @iFormSetCode
	
	--修改LOG

		SET @oDescription = @OperatorUserId + ' ModifyFormSet FormSetCode=' +  @iFormSetCode + ' FormSetName = ' + @iFormSetName;
			
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormSetCode,TransactionTatget,
			[Description],DocAuditCode,SessionId,RandomString
		)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','20',           
       		@iFormSetCode,@iFormSetCode,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'20',@oDescription,@iDocAuditCode)
		)		

/****************************************************************************/
/********************************* 檢查項目 *********************************/	
	--暫存Table:傳入的Item
	CREATE TABLE #NewItemTmp
	(
		ItemType	varchar(10),
		Item		varchar(20),
		ItemString	varchar(50)
	)
	INSERT INTO #NewItemTmp(ItemString) Select splitValue From dbo.fnc_split(@iItemArr,',') ;
	update #NewItemTmp set ItemType = ( Select splitValue from dbo.fnc_split(ItemString,'|')  where len(splitValue) = 1 )
	update #NewItemTmp set Item = ( Select splitValue from dbo.fnc_split(ItemString,'|')  where len(splitValue) > 1 )
	
	--暫存Table:傳入的Item
	CREATE TABLE #OldtemTmp
	(
		ItemType	varchar(10),
		Item		varchar(20),
		IsExist		int		default 0
	)				
	INSERT INTO #OldtemTmp(ItemType,Item) Select ItemType,Item from formsetmap where FormSetCode = @iFormSetCode
	update #OldtemTmp set IsExist = (select count(*) from #NewItemTmp where ItemType = #OldtemTmp.ItemType and Item = #OldtemTmp.Item)
	
	--isExit = 0 表示被刪除者
	
	SET @oDescription = @OperatorUserId + ' ModifyFormSet FormSetCode=' +  @iFormSetCode + ' Delete ItemType/Item = ';
			
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormSetCode,TransactionTatget,
			[Description],DocAuditCode,SessionId,RandomString)	
		SELECT
			@OperatorIP,@OperatorUserId,'SystemAdmin','20',           
       		@iFormSetCode,( ItemType + '/' + Item ) ,
       		@oDescription + ( ItemType + '/' + Item )  ,@iDocAuditCode,@iSessionId,
       		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'20', @oDescription + ( ItemType + '/' + Item ),@iDocAuditCode )
		FROM #OldtemTmp WHERE IsExist = 0
		
	--Delete formsetmap where FormSetCode = @iFormSetCode 
	DELETE a
		FROM formsetmap a
		INNER JOIN #OldtemTmp b
		ON a.Item = b.Item and a.ItemType = b.ItemType
	Where a.FormSetCode = @iFormSetCode and b.IsExist = 0
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormSetCode as FormSetCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageModifyItem]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageModifyItem]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iFormSetCode		nvarchar(20),	--修改的表單集合代碼
	@iItemType			varchar(1000),	--修改的項目種類:G:GroupID F:FormID
	@iItem				varchar(100),	--項目內容:FormId/FormGroupCode
	@iCondition			char(1),		--存在條件:0:Option 1:Must
	@iSorting			int,			--排列順序
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 修改表單 *********************************/	
	
	--查詢是否己存在
	DECLARE @formCount smallint;
	DECLARE	@oDescription varchar(max);

	SET @formCount = (SELECT COUNT(*) FROM FormSetMap WHERE Item = @iItem AND ItemType = @iItemType AND FormSetCode = @iFormSetCode )
	
	--新增
	IF @formCount = 0 
		BEGIN
			
			INSERT INTO FormSetMap
				(FormSetCode,ItemType,Item,Condition,Sorting) 
			VALUES 
				(@iFormSetCode,@iItemType,@iItem,@iCondition,@iSorting)
				
			SET @oDescription = @OperatorUserId + ' Insert Item Into FormSet FormSetCode=' +  @iFormSetCode + ' And ItemType/Item=' + @iItemType + '/' + @iItem;
	
		END
	--修改
	ELSE
		BEGIN
			
			UPDATE FormSetMap
			SET Condition = @iCondition,
				Sorting = @iSorting				
			WHERE FormSetCode = @iFormSetCode 
			AND Item = @iItem
			AND ItemType = @iItemType
			
			SET @oDescription = @OperatorUserId + ' Modify Item Into FormSet FormSetCode=' +  @iFormSetCode + ' And ItemType/Item=' + @iItemType + '/' + @iItem;
			
	END

		--新增LOG
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormSetCode,TransactionTatget,
			[Description],DocAuditCode,SessionId,RandomString
		)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','20',           
       		@iFormSetCode,@iFormSetCode,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'20',@oDescription,@iDocAuditCode)
		)			

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormSetCode as FormSetCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormSet_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormSet_ManageQuery]

	@OperatorUserId			varchar(50),	--操作者代碼
	@OperatorIP				varchar(50),	--操作者IP
	
	@targetFormSetCode		varchar(50),	--被查詢表單集合
	@iDocAuditCode			varchar(100),	--傳入的檢核碼
	@iSessionId				varchar(100)	--SessionId
		
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Form TargetFormSetCode =' + @targetFormSetCode;
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
	    FormSetCode,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','9',           
	    @targetFormSetCode,@targetFormSetCode,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'21',@oDescription,@iDocAuditCode)
	)	
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormTemplate_DeleteTemplate]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormTemplate_DeleteTemplate]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	                	
	@iFormId			nvarchar(20),	--表單代碼
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	
	/*
	exec dbo.sp_ezAcquire_FormTemplate_DeleteTemplate 
	'SysAdmin','10.0.0.183:50692',
	'NB0102',
	'',''
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/****************************** 刪除表單範本 ********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Delete FormTemplat FormId=' +  @iFormId ;
	
	DELETE FormTemplate WHERE FORMID = @iFormId;
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormId,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','6',           
       		@iFormId,
			@iFormId,'',@iFormId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'6',@oDescription,@iDocAuditCode)
	)
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @iFormId AS FORMID;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_FormTemplate_Insert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_FormTemplate_Insert]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	                	
	@iFormId			nvarchar(20),	--表單代碼
	@iPage				int,			--頁碼
	@iTemplateFile		Image,			--檔案
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	
	/*
	exec dbo.sp_ezAcquire_FormTemplate_Insert 
	'SysAdmin','10.0.0.183:50692',
	'NB0102',1,0xFFD8FFE000104A4649460001010000,
	'',''
	*/
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************** 新增表單範本 **********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert FormTemplat FormId=' +  @iFormId + ' Page= ' + CONVERT(VARCHAR,@iPage);
	
	INSERT INTO FormTemplate
	(FormId,FormPage,TemplateFile)
    VALUES
    (@iFormId,@iPage,@iTemplateFile)
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			FormId,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','6',           
       		@iFormId,
			@iFormId,'',@iFormId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'6',@oDescription,@iDocAuditCode)
	)
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT SerialNumber,FormId,FormPage from FormTemplate where FormId = @iFormId
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_GetAppendScanQueue]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************************************************/
CREATE PROCEDURE [dbo].[sp_ezAcquire_GetAppendScanQueue]
(
	@RequestUserId		varchar(50),	--請求者代碼
	@RequestIP			varchar(30),	--請求者IP	
	@iBranch			Varchar(20),	--分公司代碼
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
)
AS
	
	/*
	exec dbo.sp_ezAcquire_GetAppendScanQueue 
	'jacky','10.0.1.15:3327',
	'',
	'ImageQuery','','fc68254c-0f59-42e7-b5ce-90591c53a698'
	
	*/

    /*
    功能說明：
    1.補掃列表:
      (1)AppendScanStatus = 'U'(U:未重掃)
      (2)分公司可有可無
    */


BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription VARCHAR(MAX) --寫入AuditLog的文字描述
	SET @oDescription = @RequestUserId + ' Get AppendScanQueue Branch = ''' + @iBranch + '''' ;
		
/****************************************************************************/
/***************************** 查詢補掃列表 *********************************/	
	SELECT 
		TaskId as AppendScanQueueId,
		Branch,U.UnitName,
		BagId,FilingNumber,
		StartTime as RequestTime,RequestUser,ISNULL(UR.UserName,'') RequestUserName,RequestReason,
		IndexData
	FROM AppendScanQueue AQ
		LEFT JOIN Unit U ON U.UnitCode = AQ.Branch
		LEFT JOIN [User] UR ON AQ.RequestUser = UR.UserId
	WHERE [Status] = 'U'
        AND (@iBranch = '' OR @iBranch = '88' OR Branch = @iBranch)  
		
/****************************************************************************/
/****************************** 寫入AuditLog ********************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog (
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString
	) Values (
		@RequestIP, @RequestUserId,@OperatedSystem,'38', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'38',@oDescription,@DocAuditCode)
    )
				
END
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_GetRescanQueue]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************************************************/
CREATE PROCEDURE [dbo].[sp_ezAcquire_GetRescanQueue]  
(  
     @RequestUserId     varchar(50)     --請求者代碼     
    ,@RequestIP         varchar(30)     --請求者IP     
    ,@iBranch           Varchar(20)     --分公司代碼   
    ,@OperatedSystem    varchar(50)     --操作系統     
    ,@DocAuditCode      varchar(100)    --傳入的檢核碼 
    ,@iSessionId        varchar(100)    --SessionId    
)
AS
    /*  
    exec dbo.sp_ezAcquire_GetRescanQueue   
    'jacky','10.0.1.15:3327',  
    '',  
    'ImageQuery','','fc68254c-0f59-42e7-b5ce-90591c53a698'  
    */  
  
    /*  
    功能說明：  
    1.重掃列表:  
      (1)RescanStatus = 'U'(U:未重掃)  
      (2)分公司可有可無  
    */  
BEGIN  
    SET NOCOUNT ON;  
    
    DECLARE @oDescription varchar(max); --寫入AuditLog的文字描述  
    
    SET @oDescription = @RequestUserId + ' Get RescanQueue Branch = ''' + @iBranch + '''' ;  
    
/****************************************************************************/  
/***************************** 查詢重掃列表 *********************************/   
    SELECT   
       TaskId as RescanQueueId,  
       Branch, U.UnitName,  
       OriScanType, S.ScanTypeName,  
       ReplaceKey,  
       ISNULL(BagId, '') as BagId,
       ISNULL(F.FormId,'') FormId, ISNULL(F.FormName,'') FormName,  
       StartTime as RequestTime,RequestUser,ISNULL(UR.UserName,'') RequestUserName,
       RequestReason,
       CASE WHEN A.Description IS NULL THEN RequestReason ELSE A.Description END ReasonDescription,  
       ISNULL(IndexData, '') as IndexData  
    FROM RescanQueue RQ  
       LEFT JOIN Unit U ON U.UnitCode = RQ.Branch  
       LEFT JOIN ScanTypes S ON RQ.OriScanType = S.ScanTypeId  
       LEFT JOIN Form F ON F.FormId = RQ.FormId  
       LEFT JOIN [User] UR ON RQ.RequestUser = UR.UserId  
       LEFT JOIN FilingAttributes A ON A.Code = RQ.RequestReason AND A.Type = 'RescanReason'  
    WHERE [Status] = 'U'  
       AND (@iBranch = '' OR Branch = @iBranch)  
   
/****************************************************************************/  
/****************************** 寫入AuditLog ********************************/   
    
    INSERT INTO ezAcquireAudit.dbo.AuditLog (  
        OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,  
        [Description],DocAuditCode,SessionId,RandomString
    ) Values (  
        @RequestIP, @RequestUserId,@OperatedSystem,'37',   
        @oDescription,@DocAuditCode,@iSessionId,  
        dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'37',@oDescription,@DocAuditCode)
    )  

END  

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_HSCQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_HSCQuery]

	@QueryUserId		varchar(50),	--查詢者代碼
	@QueryIP			varchar(30),	--查詢者IP	
		
	@iFormId			Varchar(20),	--表單代碼
	@iScanDateS			Varchar(20),	--掃描日期起
	@iScanDateE			Varchar(20),	--掃描日期迄
	@iCompanyId			Varchar(10),	--統一編號
	@iCompanyName		Varchar(100),	--名稱
	
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_HSCQuery 
	'','',
	'','','','','',
	'','',''
	
	*/
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 查詢條款 *********************************/	
	
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryTableString = 'SELECT DocumentId,D.FormId,F.FormName,Pages,ScanDatetime,ScanType,' + 
							'ISNULL(I_61,'''') CompanyId,ISNULL(I_62,'''') CompanyName, ' + 
							'ISNULL(I_34,'''') IsBadDoc,ISNULL(IsRescan,'''') IsRescan ' + 
							'FROM DocumentIndex d ' + 
							'LEFT JOIN Form F ON d.Formid = F.Formid ' +
							'WHERE Scantype = ''HSC'' '
	--表單代碼
	IF (@iFormId IS NOT NULL AND @iFormId <> '')
		SET @queryTableString = @queryTableString + ' AND D.FormId = ''' + @iFormId + ''' '
	
	--掃描日期起
	IF (@iScanDateS IS NOT NULL AND @iScanDateS <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime >= ''' + @iScanDateS + ' 00:00:00'' '
	
	--掃描日期迄
	IF (@iScanDateE IS NOT NULL AND @iScanDateE <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime <= ''' + @iScanDateE + ' 23:59:59'' '
	
	--統一編號
	IF (@iCompanyId IS NOT NULL AND @iCompanyId <> '')
		SET @queryTableString = @queryTableString + ' AND I_61 = ''' + @iCompanyId + ''' '
	
	--名稱
	IF (@iCompanyName IS NOT NULL AND @iCompanyName <> '')
		SET @queryTableString = @queryTableString + ' AND I_62 like ''%' + @iCompanyName + '%'' '
	
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query HSC IMAGE ' ;
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	--SELECT @queryTableString;
	EXEC(@queryTableString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_IndexQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Image_IndexQuery]
	
	@QueryUserId	varchar(50),	--查詢者代碼
	@QueryIP		varchar(30),	--查詢者IP		
	@DocumentId		varchar(20),	--查詢的文件代碼
	@OperatedSystem	varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	@DocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId

AS

BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query DocumentId = ' + Convert(varchar,@DocumentId);
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        DocumentId,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22',           
       	@DocumentId,
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT @DocumentId As DocumentId;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_ModifyIndexValue]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Image_ModifyIndexValue]
		
	@OperatorUserId		varchar(50),	--查詢者代碼
	@OperatorIP			varchar(30),	--查詢者IP		
	@OperatedSystem		varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	
	@DocumentId			varchar(20),	--修改的DOCID
	@BeforeString		varchar(max),	--修改前索引值
	@AfterString		varchar(max),	--修改後索引值
	
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId

AS

BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Modfiy Image Indexes';
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,DocumentId,
		TransactionBefore,TransactionAfter,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@OperatorIP, @OperatorUserId,@OperatedSystem,'26',@DocumentId, 
       	@BeforeString,@AfterString,@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'26',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/		
	
	select max(serialId)serialId from ezAcquireAudit.dbo.AuditLog

	/*
		EXEC dbo.sp_ezAcquire_Image_ModifyIndexValue
		'chaogun','','',
		'72057594037950825','TEST_BEFORE','TEST_AFTER',
		'',''

	*/

END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_Print]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Image_Print]
	
	@OperatorUserId	varchar(50),	--查詢者代碼
	@OperatorIP		varchar(30),	--查詢者IP
	@OperatedSystem	varchar(20),	--SystemAdmin、Scan、ImageQuery_Form、ImageQuery_Web、Filing
	
	@FormId			varchar(50),	--表單編號
	@DocumentId		bigint,			--影像編號
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
	/****************************************************************************/
	/****************************** 寫入ReportLog *******************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Print Image FormId = ' + @FormId + ' And DocumentId =' + Convert(varchar,@DocumentId);
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		DocumentId,FormId,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,@OperatedSystem,'13',           
		@DocumentId,@FormId,
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'13',@oDescription,@iDocAuditCode)
	)
	
	/****************************************************************************/
	/********************************** 回傳資料 ********************************/	
	
	select max(serialId)serialId from ezAcquireAudit.dbo.AuditLog
	
	END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_QueryByPage]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Image_QueryByPage]
	
	@OperatorUserId	varchar(50),	--查詢者代碼
	@OperatorIP		varchar(30),	--查詢者IP
	@OperatedSystem	varchar(20),	--SystemAdmin、Scan、ImageQuery_Form、ImageQuery_Web、Filing
	@FormId			varchar(50),	--表單編號
	@DocumentId		bigint,			--影像編號
	@PageNumber		smallint,		--頁數
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
	
	/****************************************************************************/
	/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Image FormId = ' + @FormId + 
						' And DocumentId =' + Convert(varchar,@DocumentId) + 
						' And PageNumber = ' + Convert(varchar,@PageNumber);

	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		DocumentId,PageNumber,FormId,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,@OperatedSystem,'10',           
		@DocumentId,@PageNumber,@FormId,
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'10',@oDescription,@iDocAuditCode)
	)
	
	/****************************************************************************/
	/********************************** 回傳資料 ********************************/	
	
	select max(serialId)serialId from ezAcquireAudit.dbo.AuditLog
	
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Image_QueryCondition]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************************************************/
CREATE PROCEDURE [dbo].[sp_ezAcquire_Image_QueryCondition]
	@OperatorUserId		varchar(50),	--查詢者代碼
	@OperatorIP			varchar(30),	--查詢者IP		
	@OperatedSystem		varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	@ConditionString	varchar(max),	--查詢條件字串
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
	--exec dbo.sp_ezAcquire_Image_QueryCondition 'a00039','','','PolicyId=666666','',''
BEGIN
	SET NOCOUNT ON;
	
	DECLARE @ResultCount bigint; 
	DECLARE @DataCountStr varchar(max); 
	SET @DataCountStr = ' TOP 500 ';
	
/****************************************************************************/
/******************************** 切割條件值 ********************************/	

	--建立暫存的條件式Table
	DECLARE @ConditionTable TABLE
	(
		Clause				VARCHAR(max),				 --條件式
		LogicalOperators	VARCHAR(100),				 --邏輯運算子:AND/OR
		SourceFieldName		VARCHAR(100),				 --此條件所查的原始欄位名稱
		IndexFieldName		VARCHAR(100),				 --此條件所查的索引值欄位
		Multiple			VARCHAR(1)		DEFAULT '0', --此條件所查的索引值是否複合
		ComparisonOperators	VARCHAR(100),				 --比較運算子：=,>,<,>=,<=,<>		
		IndexValue			VARCHAR(max),				 --此條件的查詢內容
		CompiledClause		VARCHAR(max)				 --編譯後的條件式
	)		
	
	--以|分隔	
	INSERT INTO @ConditionTable(Clause)
	SELECT * from dbo.sp_Common_Split(@ConditionString,'|')
                                                                                                                    --EXEC dbo.sp_Common_SplitStr2Table @ConditionString;
	--取得邏輯運算子:AND/OR
	UPDATE @ConditionTable 
	SET LogicalOperators = 
		CASE 
			WHEN UPPER(SUBSTRING(LTRIM(Clause),1,3)) = 'AND' THEN 'AND'
			WHEN UPPER(SUBSTRING(LTRIM(Clause),1,2)) = 'OR' THEN 'OR'
			ELSE 'AND'
		END 

	--取得比較運算子：=,>,<,>=,<=,<>	
	UPDATE @ConditionTable 
	SET ComparisonOperators = 
		CASE 
			WHEN CHARINDEX('>=', Clause) > 0 THEN '>='
			WHEN CHARINDEX('<=', Clause) > 0 THEN '<='
			WHEN CHARINDEX('!=', Clause) > 0 THEN '!='
			WHEN CHARINDEX('<>', Clause) > 0 THEN '<>'
			WHEN CHARINDEX('>', Clause) > 0 THEN '>'
			WHEN CHARINDEX('<', Clause) > 0 THEN '<'
			WHEN CHARINDEX('=', Clause) > 0 THEN '='
			WHEN CHARINDEX('IN', Clause) > 0 THEN 'IN'
			ELSE ''
		END 

	--取得原始欄位名稱:SourceFieldName
	UPDATE @ConditionTable 
	SET SourceFieldName = RTRIM(LEFT(LTRIM(REPLACE(Clause,LogicalOperators + ' ','')),CHARINDEX(ComparisonOperators, LTRIM(REPLACE(Clause,LogicalOperators + ' ','')))-1))
	UPDATE @ConditionTable SET IndexFieldName = UPPER(SourceFieldName)
		
	--取得索引值欄位:IndexFieldName
	UPDATE CT 
	SET CT.IndexFieldName = ID.IndexFieldName,
	CT.Multiple = ID.Multiple
	FROM @ConditionTable CT
	JOIN IndexDescription ID ON (ID.IndexDisplayName = CT.SourceFieldName)

	--取得查詢內容:IndexValue
	UPDATE @ConditionTable 
	SET IndexValue = LTRIM(REPLACE(REPLACE(REPLACE(Clause,LogicalOperators + ' ',''),SourceFieldName,''),ComparisonOperators,''))
	
	--比較運算子為IN時,去掉兩邊的括號
	UPDATE @ConditionTable 
	SET IndexValue = REPLACE(REPLACE(IndexValue,'(',''),')','')
	WHERE ComparisonOperators = 'IN'

	                                                                                                                --SELECT * FROM  #ConditionTable
/****************************************************************************/
/*************************** 組合每一個條件子句 *****************************/	
	
	--非複合欄位,非IN條件式
	UPDATE @ConditionTable
	SET CompiledClause = LogicalOperators + ' DI.' + IndexFieldName + ' ' + ComparisonOperators + '''' + REPLACE(IndexValue,' ','')  + ''''
	WHERE Multiple = '0' AND ComparisonOperators <> 'IN'

	--複合欄位,非IN條件式
	UPDATE @ConditionTable
	SET CompiledClause = 
        ' JOIN MultipleIndex_' + IndexFieldName + ' AS ' + IndexFieldName 
        + ' ON (' + IndexFieldName + '.DocumentID = DI.DocumentID AND ' 
        + IndexFieldName + '.IndexValue ' + ComparisonOperators + '''' + REPLACE(IndexValue,' ','')  + ''')'
	WHERE Multiple = '1' AND ComparisonOperators <> 'IN'

	--非複合欄位,IN條件式
	UPDATE @ConditionTable
	SET CompiledClause = 
        LogicalOperators + ' DI.' + IndexFieldName + ' ' + ComparisonOperators 
        + ' ( ''' + REPLACE(REPLACE(IndexValue,' ',''),',',''',''')  + ''')'
	WHERE Multiple = '0' AND ComparisonOperators = 'IN'

	--複合欄位,IN條件式
	UPDATE @ConditionTable
	SET CompiledClause = 
        ' JOIN MultipleIndex_' + IndexFieldName + ' AS ' + IndexFieldName
        + ' ON (' + IndexFieldName + '.DocumentID = DI.DocumentID AND '
        + IndexFieldName + '.IndexValue IN' 
        + ' ( ''' + REPLACE(REPLACE(IndexValue,' ',''),',',''',''')  + '''))'
	WHERE Multiple = '1' AND ComparisonOperators = 'IN'

/****************************************************************************/
/****************************** SQL指令字串 ********************************/	
	
	DECLARE @outputString		VARCHAR(MAX);	--完整查詢SQL指令字串
	DECLARE @outFieldString		VARCHAR(MAX);	--顯示的欄位字串
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	DECLARE @whereString		VARCHAR(MAX);	--where條件的指令字串
	DECLARE @sValue				VARCHAR(MAX);

	SET @outFieldString = ''
	SET @queryTableString = ' FROM DOCUMENTINDEX AS DI '
	SET @whereString = ' WHERE DI.DOCUMENTID IS NOT NULL AND DI.DELETED <> ''Y'' '

/****************************************************************************/
/***************************** 索引值查詢限制 *******************************/	
	
	DECLARE @IndexRestriction TABLE 
	(
		IndexFieldName		VARCHAR(20),		--索引值欄位名稱
		IndexDisplayName	VARCHAR(100),		--索引值顯示名稱
		Multiple			VARCHAR(1),			--是否複合
		IndexFieldValue		VARCHAR(100)		--限制的內容
	)
	INSERT INTO @IndexRestriction(IndexFieldName,IndexDisplayName,Multiple,IndexFieldValue)
	SELECT DISTINCT ID.IndexFieldName,ID.IndexDisplayName,ID.Multiple,RI.IndexFieldValue
	FROM IndexDescription ID
	LEFT JOIN RoleIndexMap RI ON ID.IndexFieldName = RI.IndexFieldName
	LEFT JOIN vw_ezAcquire_UserFormGroup FG ON RI.RoleCode = FG.RoleId AND FG.UserId = @OperatorUserId
	WHERE IndexDataType = '4' AND Restriction = '1'		
	
	INSERT INTO @ConditionTable
	(LogicalOperators,IndexFieldName,SourceFieldName,Multiple,ComparisonOperators,IndexValue)
	SELECT DISTINCT 
	'AND', IndexFieldName,IndexDisplayName,Multiple,'IN','(SELECT IndexValue FROM #ConditionTable WHERE IndexFieldName = ''' + IndexFieldName + ''')'
	FROM @IndexRestriction	
	
	--非複合欄位
	UPDATE CT
	SET CompiledClause = LogicalOperators + ' DI.' + CT.IndexFieldName + ' ' + ComparisonOperators + IndexValue
	FROM @ConditionTable CT
	JOIN @IndexRestriction IR ON CT.IndexFieldName = IR.IndexFieldName
	WHERE CT.Multiple = '0'
						
	--Multiple = 1 複合欄位
	UPDATE CT
	SET CompiledClause = 
        ' JOIN MultipleIndex_' + CT.IndexFieldName + ' AS ' + CT.IndexFieldName 
        + ' ON ' + CT.IndexFieldName + '.DocumentID = DI.DocumentID AND '
        + CT.IndexFieldName + '.IndexValue IN' + IndexValue 
	FROM @ConditionTable CT
	JOIN @IndexRestriction IR ON CT.IndexFieldName = IR.IndexFieldName 
	WHERE CT.Multiple = '1'

	--判斷是否為I_40 事故人Id,I_47 主被保人Id,I_50 保單號碼		
	SET @DataCountStr = (
		SELECT CASE COUNT(*)
			WHEN 0 THEN ' top 500 '
			ELSE ''
			END 
		FROM @ConditionTable
		WHERE IndexFieldName IN ('I_40','I_47','I_50')	
	)
	                                                                                                                --select * from @ConditionTable
	
/****************************************************************************/
/****************************** 表單權限設定 ********************************/	
		
	--建立暫存的表單及權限Table
	DECLARE  @UserFormTable TABLE
	(
		FormId				VARCHAR(100),	--表單編號
		PageCounts			int,			--頁數
		QueryPages			VARCHAR(100),	--查詢頁次
		PrintPages			VARCHAR(10),	--列印權限:[0]否 [1]是
		PrintRights			VARCHAR(100),	--列印頁次		
		AnnotationView		VARCHAR(10),	--註記檢視權限:[0]否 [1]是
		AnnotationEdit		VARCHAR(10)		--註記編輯權限:[0]否 [1]是
	)

	--取得使用者可檢視的表單及權限
	INSERT INTO @UserFormTable(FormId,PageCounts,QueryPages,PrintPages,PrintRights,AnnotationView,AnnotationEdit)
	SELECT FormId,MAX(PageCounts),MAX(QueryPages),MAX(PrintPages),MAX(PrintRights),MAX(AnnotationView),MAX(AnnotationEdit)
	FROM vw_ezAcquire_UserFormGroup 
	WHERE UserId = @OperatorUserId
	GROUP BY FormId	
                                                                                                                    --select * from @UserFormTable
/****************************************************************************/
/****************************** 查詢條件組合 ********************************/	
	
	--將複合欄位加入JoinTable指令字串
	DECLARE Source_Data CURSOR FOR Select CompiledClause From @ConditionTable 	WHERE Multiple = '1'
			
	OPEN Source_Data
		FETCH NEXT FROM Source_Data
		INTO @sValue
			
	WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @queryTableString  = @queryTableString + @sValue + ' '
			FETCH NEXT FROM Source_Data 
			INTO @sValue																		
		END

	CLOSE Source_Data
	DEALLOCATE Source_Data

	--將非複合欄位加入Whereq指令字串
	DECLARE Source_Data CURSOR FOR Select CompiledClause From @ConditionTable 	WHERE Multiple = '0'
			
	OPEN Source_Data
		FETCH NEXT FROM Source_Data
		INTO @sValue
			
	WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @whereString  = @whereString + @sValue + ' '
			FETCH NEXT FROM Source_Data 
			INTO @sValue																		
		END

	CLOSE Source_Data
	DEALLOCATE Source_Data	

	SET @outputString = 'SELECT DI.documentid,formid ' + @queryTableString + @whereString 
	                                                                                                                --select @outputString
	--建立暫存的結果TABLE
	Create Table #ResultDocument
	(
		DocumentId			VARCHAR(100),	--文件編號
		FormId				VARCHAR(100)	--表單編號
	)
	--將結果存至結果TABLE
	INSERT INTO #ResultDocument EXEC(@outputString)

	--將無權限表單刪除
	DELETE #ResultDocument WHERE FORMID NOT IN (SELECT FORMID FROM @UserFormTable)

	--計算資料筆數
	SET @ResultCount = (select COUNT(*) from #ResultDocument)
	                                                                                                                --select * from #ResultDocument
/****************************************************************************/
/******************************* 顯示欄位 ***********************************/	
	
	DECLARE @ResultSQLStr varchar(max);
	SET @ResultSQLStr = ''

	--建立暫存的欄位名稱Table
	DECLARE  @ColumnNameTable TABLE
	(
		Serical			int			IDENTITY(1,1),	--欄位順序
		OutColumnName	VARCHAR(max)				--欄位名稱
	)
	
	--預設的欄位:DocumentIndex及表單權限
	INSERT INTO @ColumnNameTable(OutColumnName) Values
	('DocumentId'),('DocumentClassId'),('CreateDateTime'),('DocumentType'),
	('MimeType'),('Pages'),('Deleted'),('Status'),('FormID'),('ScanType'),
	('ScanUserId'),('ScanDateTime'),('VerifyUserId'),('VerifyDateTime'),
	('BatchNumber'),('FilingStatus'),('Security'),('FilingNumber')

	--由使用者定義的索引值欄位:I_31,I_32,I_33,I_34
	INSERT INTO @ColumnNameTable(OutColumnName) 
	select IndexFieldName from IndexDescription  WHERE IndexCategory = 'C' 
    ORDER BY IndexFieldName

	--將欄位加起來	
	DECLARE Source_Data CURSOR FOR Select OutColumnName From @ColumnNameTable ORDER BY Serical
			
	OPEN Source_Data
		FETCH NEXT FROM Source_Data
		INTO @sValue
				
	WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @ResultSQLStr = '' 
				SET @ResultSQLStr  = @sValue
			ELSE
				SET @ResultSQLStr  = @ResultSQLStr + ' , ' + @sValue					
				
			FETCH NEXT FROM Source_Data 
			INTO @sValue			
																				
		END

	CLOSE Source_Data
	DEALLOCATE Source_Data

	SET @ResultSQLStr = 
        'SELECT ' + @DataCountStr + @ResultSQLStr + ',' + CONVERT(VARCHAR,@ResultCount) + ' AS TotalCount'
        + ' FROM DOCUMENTINDEX'
        + ' WHERE DOCUMENTID IN ( SELECT DOCUMENTID FROM #ResultDocument)' 
        + ' ORDER BY Convert(varchar ,ScanDateTime,120) Desc , FilingNumber Desc , FormID asc'

/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' QueryImage SQL = ' + @ResultSQLStr + ' -- ' + @outputString;
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@OperatorIP, @OperatorUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/		
                                                                                                                    --SELECT @outputString
                                                                                                                    --SELECT @ResultSQLStr
	EXEC( @ResultSQLStr);

	IF OBJECT_ID('tempdb..#ResultDocument') IS NOT NULL
		DROP TABLE #ResultDocument
	/*
		EXEC dbo.sp_ezAcquire_Image_QueryCondition
		'SysAdmin','','',
		' PolicyId = A175131527 ',
		'',''
	*/
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_QueryMultipleIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_QueryMultipleIndex]
	@iTableName varchar(20),	
	@iIndexValue varchar(20)		--索引值
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE @sIndex VARCHAR(20);
	DECLARE @sqlStr varchar(500);
			
	SET @sqlStr = ' SELECT DocumentId,OrderSerial FROM MultipleIndex_' 
				+ @iTableName + ' WHERE IndexValue = ''' + @iIndexValue + ''''
				
	EXECUTE (@sqlStr);				
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanCancel]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_RescanCancel]

	@RequestUserId		varchar(50),	--取消者代碼
	@RequestIP			varchar(30),	--取消者IP	
	@iDocId				Varchar(20),	--影像序號
	@iRequestReason		Varchar(20),	--取消原因
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_RescanCancel 
	'jacky','',
	'20011','不想掃',
	'','',''	
	*/

	/*
	功能說明：
	1.更新RescanQueue
	2.更新DocumentIndex.IsRescan = 'N',I_36 = 取消原因
	3.寫入AuditLog,OperationCode = 32
	*/

AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription	varchar(max);	--寫入AuditLog的文字描述
	DECLARE @rRescanQueueId	int;			--重掃序號
	
	SET @oDescription = @RequestUserId + ' Rescan Cancel DocumentId= ' + @iDocId ;
	SET @rRescanQueueId = (SELECT max(TaskId) FROM RescanQueue WHERE ReplaceKey = @iDocId);
		
/****************************************************************************/
/************************* 判斷實體文件狀態 *********************************/	
	
	--更新RescanQueue
	UPDATE RescanQueue 
	SET [Status] = 'C'
	WHERE TaskId = @rRescanQueueId
	
	--更新DocumentIndex.IsRescan = 'Y'
	UPDATE DocumentIndex 
	SET IsRescan = 'N',
	I_36 = @iRequestReason
	WHERE DOCUMENTID = @iDocId;
	
/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		DocumentId,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@RequestIP, @RequestUserId,@OperatedSystem,'32', 
		@iDocId,
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'32',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		--SELECT * FROM RescanQueue WHERE TaskId = @rRescanQueueId ;
	     	
		--Jacky Modify  只有Update 永遠部會失敗
		SELECT '0' AS ResultCode, '取消重掃成功!!' AS ResultText ;
	
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanCompleted]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_RescanCompleted]

	@iDocId				Varchar(20),	--影像序號
	
	@OperatedSystem		varchar(50),	--操作系統
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_RescanCompleted 
	'24999',
	'Commit1','76c74c2d-588b-41cf-9d8b-3cd686a08cf1','76c74c2d-588b-41cf-9d8b-3cd686a08cf1'	

	2015-04-22 14:12:59,368 [DEBUG] CommitServer - PName='      @iDocAuditCode' 	 Value='76c74c2d-588b-41cf-9d8b-3cd686a08cf1'
	*/

    /*
    功能說明：
    1.更新RescanQueue
    2.寫入AuditLog,OperationCode = 33
    */

AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription	varchar(max);	--寫入AuditLog的文字描述
	DECLARE @rRescanQueueId	int;			--重掃序號
	
	SET @oDescription = ' Rescan Complete DocumentId= ' + @iDocId ;
	SET @rRescanQueueId = (SELECT max(TaskId) FROM RescanQueue WHERE ReplaceKey = @iDocId);
	
		
/****************************************************************************/
/********************************* 更新資料 *********************************/	
	
	--更新RescanQueue
	UPDATE RescanQueue 
	SET [Status] = 'F'
	WHERE TaskId = @rRescanQueueId
	
	--更新DocumentIndex.Deleted = 'Y'
	UPDATE DocumentIndex 
	SET Deleted = 'Y'
	WHERE DOCUMENTID = @iDocId;

/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatedSystem,OperationFunction,
		DocumentId,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@OperatedSystem,'33', 
		@iDocId,
       	@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random('','33',@oDescription,@iDocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		SELECT * FROM RescanQueue WHERE TaskId = @rRescanQueueId ;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_RescanRequest]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_RescanRequest]

	@RequestUserId		varchar(50),	--請求者代碼
	@RequestIP			varchar(30),	--請求者IP	
	@iBranch			Varchar(20),	--分公司代碼
	@iDocId				Varchar(20),	--重掃DocId
	@iRequestReason		Varchar(MAX),	--重掃原因
	@iIndexData			Varchar(max),	--索引資料
	@iFormId			Varchar(10),	--表單編號
	@OperatedSystem		varchar(50),	--操作系統
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_RescanRequest 
	'jacky','10.0.1.15:3327',
	'88','20023','002',' {[Branch],[88]},{[IsRescan],[Y]},{[DocOrder],[]},{[IsBadDoc],[]},{[IsReject],[]},{[Remark],[要保書掃描順序錯誤]},{[ReplaceKey],[]},{[DocName],[]},{[AccidentDate],[]},{[AccidentId],[]},{[ClauseId],[]},{[ClauseName],[]},{[ClmReceiveDate],[]},{[CloseDate],[]},{[ComplainNum],[]},{[ComplainNumber],[]},{[InsuredId],[B123456789]},{[MainId],[A123456789]},{[PaidSerialNo],[]},{[PolicyId],[]},{[PolicySerialNo],[]},{[POSNumber],[]},{[RegReceiveDate],[]},{[RegSendDate],[]},{[SalesId],[A987654321]},{[SName],[]},{[VaryDate],[]},{[BlacklistNo],[]},{[BoxNo],[]},{[ClaimNumber],[]},{[CompanyId],[]},{[CompanyName],[]},{[ClauseUploadUser],[]},{[SalesNote],[]},{[SalesNoteUser],[]},{[BlacklistName],[]},{[VersionCode],[]},{[VersionName],[]},{[ReplaceDocId],[]},{[SalesNoteDate],[]}',
	'NA0100',
	'ImageQuery','','fc68254c-0f59-42e7-b5ce-90591c53a698'
	
	*/

    /*
    功能說明：

    1.可重掃條件:
        (1)判斷實體文件狀態,必須為00-待歸檔,11-借調申請,12-借調覆核,13-借調傳送,14-借調中
        (2)借調時,重掃請求人必須為借調申請人
        (3)IsRescan <> 'Y'

    2.寫入資料
        (1)RescanQueue
        (2)更新DocumentIndex.IsRescan = 'Y'
        (3)寫入AuditLog,OperationCode = 31

    3.回傳訊息代碼及訊息文字:
        0:重掃請求成功,重掃序號= xxx
        1:文件歸檔狀態必須為借調或待歸檔 / 重掃請求人必須為借調申請人 / 文件已要求重掃
    */

AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription	varchar(max);	--寫入AuditLog的文字描述
	DECLARE @rCode			Varchar(100);	--重掃要求的結果
	DECLARE @rMegText		Varchar(100);	--重掃要求的文字描述

	SET @oDescription = @RequestUserId + ' Rescan Request DocumentId = ' + @iDocId ;
	SET @rMegText = '';
		
/****************************************************************************/
/************************* 判斷實體文件狀態 *********************************/	
	
	--判斷實體文件狀態是否為借調	
	SET @rMegText = (
		SELECT CASE 
		WHEN FilingStatus NOT IN ('00','11','12','13','14') THEN '文件歸檔狀態必須為借調或待歸檔'
		WHEN ( FilingStatus <> '00' AND ApplicantUserId <> @RequestUserId) THEN '重掃請求人必須為借調申請人'
		WHEN (IsRescan = 'Y' ) THEN '文件已要求重掃'
		ELSE '' 
		END MegText
		FROM vw_ezAcquire_FilingMaster  
		WHERE DocumentId = @iDocId
	)
	
	IF (@rMegText IS NULL)
    BEGIN
        SET @rMegText = '無歸檔記錄'
    END
	select @rMegText AS MegText

	--狀態不為借調,不可重掃
	IF (@rMegText <> '')
		BEGIN
			SET @oDescription = @oDescription + ' ,不可重掃,' + @rMegText;
			SET @rCode = '1'
		END
	
	--狀態為借調,可重掃
	IF (@rMegText = '')
		BEGIN
			SET @rCode = '0'

			DECLARE @qScanType Varchar(20);
			DECLARE @qPolicyId Varchar(MAX);
			DECLARE @qBagId Varchar(20);
			DECLARE @requestReasonDescription NVARCHAR(MAX)
	
			SET @qScanType = (SELECT ScanTypeId FROM vw_ezAcquire_FilingMaster WHERE DocumentId = @iDocId);
			SET @qPolicyId = (SELECT I_50 FROM vw_ezAcquire_FilingMaster WHERE DocumentId = @iDocId);
			SET @qBagId = (select BagId from vw_ezAcquire_FilingMaster WHERE DocumentId = @iDocId);
			SET @requestReasonDescription = (SELECT [Description] FROM FilingAttributes WHERE [Type] = 'RescanReason' AND Code = @iRequestReason)

			IF ISNULL(@requestReasonDescription, '') <> ''
			BEGIN
				SET @iRequestReason = @requestReasonDescription
			END

			--寫入 RescanQueue
			Insert Into RescanQueue (
				Branch,ReplaceKey,RequestUser,RequestReason,
				PolicyId,OriScanType,IndexData,BagId,FormId)
			Values(
				@iBranch,@iDocId,@RequestUserId,@iRequestReason,
				@qPolicyId,@qScanType,@iIndexData,@qBagId,@iFormId);

			--更新 DocumentIndex.IsRescan = 'Y'
			UPDATE DocumentIndex SET IsRescan = 'Y' WHERE DOCUMENTID = @iDocId;

			SET @rMegText = '重掃請求成功,重掃序號=' + CONVERT(VARCHAR ,(SELECT TOP 1 TaskId FROM RescanQueue ORDER BY TaskId DESC))
		END	
	
/****************************************************************************/
/****************************** 寫入AuditLog *******************************/	
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		DocumentId,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@RequestIP, @RequestUserId,@OperatedSystem,'31', 
		@iDocId,
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@RequestUserId,'31',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT @rCode AS ResultCode, @rMegText AS ResultText
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageDelete]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageDelete]

	@OperatorUserId			varchar(50),	--操作者代碼
	@OperatorIP				varchar(30),	--操作者IP
	
	@iRoleId				int,			--異動的角色代碼
			
	@iDocAuditCode			varchar(100),	--傳入的檢核碼
	@iSessionId				varchar(100)	--SessionId		
AS
BEGIN
	SET NOCOUNT ON;	

	DECLARE	@oDescription varchar(max);

/****************************************************************************/
/***************************** 處理索引值內容 *******************************/	

		--刪除RoleIndexMap
		DELETE RoleIndexMap WHERE RoleCode = @iRoleId ;		
		
		--刪除RoleFunctionMap
		DELETE RoleFunctionMap WHERE RoleCode = @iRoleId ;		
		
		--刪除RoleFormGroupMap
		DELETE RoleFormGroupMap WHERE RoleCode = @iRoleId ;		
		
		--刪除ScanTypeRoleMap
		DELETE RoleScanTypeMap WHERE RoleCode = @iRoleId ;	
		
		--刪除RoleBusinessTypeMap
		DELETE RoleBusinessTypeMap WHERE RoleCode = @iRoleId ;

		--刪除Roles
		DELETE Role WHERE RoleCode = @iRoleId ;	
						
		SET @oDescription = @OperatorUserId + ' Delete RoleCode=' + Convert(varchar,@iRoleId) ;

		--寫入AuditLOG檔
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			RoleId,TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString)
		values(
			@OperatorIP,@OperatorUserId,'SystemAdmin','17',           
       		@iRoleId,@iRoleId,@iRoleId,'',
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'17',@oDescription,@iDocAuditCode))		

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT * FROM Role WHERE RoleCode = @iRoleId 	
	
	--exec dbo.sp_ezAcquire_Role_ManageDelete 'Ivy','10.0.0.183:50692',2,'',''
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageDeleteIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageDeleteIndex]

	@OperatorUserId			varchar(50),	--操作者代碼
	@OperatorIP				varchar(30),	--操作者IP
	
	@iRoleId				int,			--異動的角色代碼
			
	@iDocAuditCode			varchar(100),	--傳入的檢核碼
	@iSessionId				varchar(100)	--SessionId		
AS
BEGIN
	SET NOCOUNT ON;	

	DECLARE	@oDescription varchar(max);

/****************************************************************************/
/***************************** 處理索引值內容 *******************************/	

		--刪除所有的值
		DELETE RoleIndexMap WHERE RoleCode = @iRoleId ;		
				
		SET @oDescription = @OperatorUserId + ' Delete IndexValue RoleCode=' + Convert(varchar,@iRoleId) ;

		--寫入AuditLOG檔
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			RoleId,TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString)
		values(
			@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       		@iRoleId,@iRoleId,@iRoleId,@iRoleId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode))		

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT * FROM RoleIndexMap WHERE RoleCode = @iRoleId 
	
END
GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageInsertMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iRoleName		nvarchar(100),	--新增的角色名稱
	@iUserIdArr		varchar(max),	--新增的使用者代碼清單
	@iFormGroupArr	varchar(max),	--新增的表單群組代碼清單
	@iFunctionArr	varchar(max),	--新增的功能代碼清單	
	@iScanTypeArr	varchar(max),	--新增的掃描管道清單	
	@iSecurityArr	varchar(max),	--安全性清單
	@iMaskTypeArr	varchar(max),	--遮罩類別清單	
	@iBusinessType	varchar(max),	--業務別
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId	
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE @newRoleId int;			--新增的角色代碼
	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/******************************** 新增角色 **********************************/	
	
	INSERT INTO Role(Rolename) VALUES (@iRoleName);
	
	--新增的角色代碼
	SET @newRoleId = (SELECT MAX(RoleCode) FROM Role);

/****************************************************************************/
/****************************** 新增使用者 **********************************/	
	IF  @iUserIdArr IS NOT NULL AND @iUserIdArr <> ''
		BEGIN			
			
			DECLARE @sUserId VARCHAR(50)
			DECLARE UserId_Data CURSOR FOR
				Select splitValue From dbo.fnc_split(@iUserIdArr,'|')			
			OPEN UserId_Data
				FETCH NEXT FROM UserId_Data
				INTO @sUserId
			
			WHILE @@FETCH_STATUS = 0
			BEGIN
				--寫入對應檔
				INSERT INTO UserRoleMap(RoleCode,UserId) VALUES(@newRoleId,@sUserId)
				
				SET @oDescription = @OperatorUserId + ' Insert User Into Role User=' +  @sUserId + ' And RoleCode=' + Convert(varchar,@newRoleId);

				--寫入報表LOG檔
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
						OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
						RoleId,
						TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
						[Description],DocAuditCode,SessionId,RandomString
				)VALUES(
						@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       					@newRoleId,
       					@sUserId,@newRoleId,'',@sUserId,
						@oDescription ,@iDocAuditCode,@iSessionId,
						dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode)
				)											
									
				FETCH NEXT FROM UserId_Data 
				INTO @sUserId																		
			END

			CLOSE UserId_Data
			DEALLOCATE UserId_Data	

		END	
/****************************************************************************/
/****************************** 新增表單群組 ********************************/	
		IF  @iFormGroupArr IS NOT NULL AND @iFormGroupArr <> ''
		BEGIN			
			DECLARE @sFormGroup VARCHAR(50)
			DECLARE FormGroup_Data CURSOR FOR
				Select splitValue From dbo.fnc_split(@iFormGroupArr,'|')			
			OPEN FormGroup_Data
				FETCH NEXT FROM FormGroup_Data
				INTO @sFormGroup
				
			WHILE @@FETCH_STATUS = 0
			BEGIN
				--寫入對應檔
				INSERT INTO RoleFormGroupMap(RoleCode,FormGroupCode) VALUES(@newRoleId,@sFormGroup)

				SET @oDescription =  @OperatorUserId + ' Insert FormGroup Into Role FormGroup=' +  @sFormGroup + ' And RoleCode=' +Convert(varchar,@newRoleId);
				
				--寫入報表LOG檔
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
						OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
						FormGroupCode,RoleId,
						TransactionTatget,TransactionBefore,TransactionAfter,
						[Description],DocAuditCode,SessionId,RandomString
				)VALUES(
						@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       					@sFormGroup,@newRoleId,
       					@newRoleId,'',@sFormGroup,
       					@oDescription,@iDocAuditCode,@iSessionId,
						dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode)
				)											
					
				
				FETCH NEXT FROM FormGroup_Data 
				INTO @sFormGroup																		
			END

			CLOSE FormGroup_Data
			DEALLOCATE FormGroup_Data
					
		END	
/****************************************************************************/
/******************************** 新增功能 **********************************/	
		IF  @iFunctionArr IS NOT NULL AND @iFunctionArr <> ''
		BEGIN			
			DECLARE @sFunctionCode VARCHAR(50)
			DECLARE FunctionCode_Data CURSOR FOR
				Select splitValue From dbo.fnc_split(@iFunctionArr,'|')			
			OPEN FunctionCode_Data
				FETCH NEXT FROM FunctionCode_Data
				INTO @sFunctionCode
	
			WHILE @@FETCH_STATUS = 0
			BEGIN
				--寫入對應檔
				INSERT INTO RoleFunctionMap(RoleCode,FunctionCode) VALUES(@newRoleId,@sFunctionCode)

				SET @oDescription = @OperatorUserId + ' Insert FunctionCode Into Role FunctionCode=' +   Convert(varchar,@sFunctionCode) + ' And RoleCode=' + Convert(varchar,@newRoleId);
				
				--寫入報表LOG檔
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
						OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
						RoleId,FunctionCode,
						TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
						[Description],DocAuditCode,SessionId,RandomString
				)VALUES(
						@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       					@newRoleId,@sFunctionCode,
       					'',@newRoleId,'',@sFormGroup,
       					@oDescription ,@iDocAuditCode,@iSessionId,
       					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode)
				)	
				
				FETCH NEXT FROM FunctionCode_Data 
				INTO @sFunctionCode																		
			END

			CLOSE FunctionCode_Data
			DEALLOCATE FunctionCode_Data		
		END

/****************************************************************************/
/****************************** 新增掃描管道 ********************************/	
		IF  @iScanTypeArr IS NOT NULL AND @iScanTypeArr <> ''
		BEGIN			
			DECLARE @sScanType VARCHAR(50)
			DECLARE ScanType_Data CURSOR FOR
				Select splitValue From dbo.fnc_split(@iScanTypeArr,'|')			
			OPEN ScanType_Data
				FETCH NEXT FROM ScanType_Data
				INTO @sScanType
	
			WHILE @@FETCH_STATUS = 0
			BEGIN
				--寫入對應檔
				INSERT INTO RoleScanTypeMap(RoleCode,ScanTypeId) VALUES(@newRoleId,@sScanType)


				SET @oDescription = @OperatorUserId + ' Insert ScanType Into Role ScanType=' +   Convert(varchar,@sScanType) + ' And RoleCode=' + Convert(varchar,@newRoleId);
				
				--寫入報表LOG檔
				INSERT INTO ezAcquireAudit.dbo.AuditLog(
						OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
						RoleId,FunctionCode,ScanTypeId,
						TransactionTatget,TransactionBefore,TransactionAfter,
						[Description],DocAuditCode,SessionId,RandomString
				)VALUES(
						@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       					@newRoleId,@sScanType,@newRoleId,
       					'','',@sScanType,
						@oDescription ,@iDocAuditCode,@iSessionId,
						dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode)
				)	
				
				FETCH NEXT FROM ScanType_Data 
				INTO @sScanType																		
			END

			CLOSE ScanType_Data
			DEALLOCATE ScanType_Data		
		END

/****************************************************************************/
/****************************** 新增業務類別 ********************************/	
		IF  @iBusinessType IS NOT NULL AND @iBusinessType <> ''
		BEGIN			
			INSERT INTO RoleBusinessTypeMap(RoleCode,BusinessTypeCode) VALUES (@newRoleId,@iBusinessType);
		END

/****************************************************************************/
/**************************** 異動遮罩類別的設定 ****************************/	

		exec dbo.sp_ezAcquire_Role_ManageMaskTypeInsert @OperatorUserId,@OperatorIP,@newRoleId,@iFormGroupArr,@iSecurityArr,@iMaskTypeArr,@iSessionId,@iDocAuditCode

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT @newRoleId as newRoleId
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageMaskTypeInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageMaskTypeInsert]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iRoleId		int,			--異動的角色代碼
	@iFormGroupArr	varchar(max),	--表單群組代碼清單
	@iSecurityArr	varchar(max),	--安全性清單
	@iMaskTypeArr	varchar(max),	--遮罩類別清單	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId	
AS
BEGIN
	SET NOCOUNT ON;	

	DECLARE	@oDescription varchar(max);

/****************************************************************************/
/****************************** 處理表單群組 ********************************/	

	--建立暫存檔:表單群組
	CREATE TABLE #FormGroupTmp
	(
		SerialId 		int 			IDENTITY(1,1)	NOT NULL,
		FormGroupCode	varchar(20)
	)			
	INSERT INTO #FormGroupTmp(FormGroupCode) EXEC dbo.sp_Common_SplitStr2Table @iFormGroupArr;

/****************************************************************************/
/***************************** 處理安全性清單 *******************************/	

	--建立暫存檔:安全性清單
	CREATE TABLE #SecurityTmp
	(
		SerialId 		int 			IDENTITY(1,1)	NOT NULL,
		SecurityCode	Smallint
	)			
	INSERT INTO #SecurityTmp(SecurityCode) EXEC dbo.sp_Common_SplitStr2Table @iSecurityArr;

/****************************************************************************/
/****************************** 處理遮罩類別 ********************************/	

	--建立暫存檔:遮罩類別
	CREATE TABLE #MaskTypeTmp
	(
		SerialId 		int 			IDENTITY(1,1)	NOT NULL,
		MaskType		varchar(100)
	)			
	INSERT INTO #MaskTypeTmp(MaskType) EXEC dbo.sp_Common_SplitStr2Table @iMaskTypeArr;

/****************************************************************************/
/********************************* 修改資料 *********************************/	

	UPDATE RoleFormGroupMap
	SET Security = R.SecurityCode,
	ImageMaskTypeArray = R.MaskType 
	FROM (
	select a.FormGroupCode, b.SecurityCode,c.MaskType
	from #FormGroupTmp a,#SecurityTmp b,#MaskTypeTmp c
	where a.SerialId = b.SerialId
	and b.SerialId = c.SerialId) R
	WHERE RoleFormGroupMap.FormGroupCode = R.FormGroupCode
	AND RoleCode = @iRoleId
	
	SET @oDescription = @OperatorUserId + ' Insert MaskType Into RoleFormGroupMap RoleCode=' + Convert(varchar,@iRoleId) + 
						' And FormGroupCode=';

	--新增：寫入報表LOG檔
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		RoleId,FormGroupCode,MaskTypeId,
		TransactionTatget,[Description],SessionId,
		DocAuditCode,RandomString)
	SELECT
		@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       	@iRoleId,FormGroupCode,ImageMaskTypeArray,
       	FormGroupCode,@oDescription + FormGroupCode + ' And MaskType=' + ImageMaskTypeArray  ,@iDocAuditCode,@iSessionId,
       	dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4', @oDescription + FormGroupCode + ' And MaskType=' + ImageMaskTypeArray ,@iDocAuditCode )
	FROM RoleFormGroupMap WHERE RoleCode = @iRoleId


/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT * FROM RoleFormGroupMap WHERE RoleCode = @iRoleId
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageModifyIndex]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageModifyIndex]

	@OperatorUserId			varchar(50),	--操作者代碼
	@OperatorIP				varchar(30),	--操作者IP
	@iRoleId				int,			--異動的角色代碼
	@iIndexFieldName		varchar(max),	--索引值欄位,I_31,I_32....
	@iIndexFieldKeyArr		varchar(max),	--索引值KEY
	@iIndexFieldValueArr	varchar(max),	--索引值VALUE:TPE,KAO,TNI
	@iDocAuditCode			varchar(100),	--傳入的檢核碼
	@iSessionId				varchar(100)	--SessionId		
AS
BEGIN
	SET NOCOUNT ON;	

	DECLARE	@oDescription varchar(max);

/****************************************************************************/
/***************************** 處理索引值內容 *******************************/	

		--寫入索引值內容
		IF @iIndexFieldValueArr IS NOT NULL AND @iIndexFieldValueArr <> ''
		BEGIN			
			
			--建立暫存檔:儲存索引值Key
			CREATE TABLE #IndexKeyTmp
			(
				Serial		bigint		IDENTITY(1,1),
				FieldKey	varchar(20)
			)			
			INSERT INTO #IndexKeyTmp(FieldKey) EXEC dbo.sp_Common_SplitStr2Table @iIndexFieldKeyArr;
			
			
			--建立暫存檔:儲存索引值Value
			CREATE TABLE #IndexValueTmp
			(
				Serial		bigint		IDENTITY(1,1),
				FieldValue	varchar(20)
			)			
			INSERT INTO #IndexValueTmp(FieldValue) EXEC dbo.sp_Common_SplitStr2Table @iIndexFieldValueArr;
			
			
			--新增：索引值至RoleIndexMap
			INSERT INTO RoleIndexMap(RoleCode,IndexFieldName,IndexFieldKey,IndexFieldValue) 
				SELECT @iRoleId,@iIndexFieldName,K.FieldKey,V.FieldValue 
				FROM #IndexValueTmp V
				JOIN #IndexKeyTmp K ON V.Serial = K.Serial
	
		END	
		
		SET @oDescription = @OperatorUserId + ' Modify IndexValue Into Role RoleCode=' + Convert(varchar,@iRoleId) + ' And IndexField = ' + @iIndexFieldName;

		--寫入AuditLOG檔
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			RoleId,TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString)
		values(
			@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       		@iRoleId,@iIndexFieldName,'',@iIndexFieldValueArr,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode))		

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT * FROM RoleIndexMap WHERE RoleCode = @iRoleId AND IndexFieldName = @iIndexFieldName
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageModifyMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iRoleId		int,			--異動的角色代碼
	@iUserIdArr		varchar(max),	--新增的使用者代碼清單
	@iFormGroupArr	varchar(max),	--新增的表單群組代碼清單
	@iFunctionArr	varchar(max),	--新增的功能代碼清單
	@iScanTypeArr	varchar(max),	--新增的掃描管道清單	
	@iRoleName		varchar(max),	--角色名稱
	@iSecurityArr	varchar(max),	--安全性清單
	@iMaskTypeArr	varchar(max),	--遮罩類別清單
	@iBusinessType	varchar(max),	--業務類別
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId		
AS
BEGIN
	SET NOCOUNT ON;	

	DECLARE	@oDescription varchar(max);

/****************************************************************************/
/****************************** 處理使用者 **********************************/	
	IF  @iUserIdArr IS NOT NULL AND @iUserIdArr <> ''
		BEGIN			
						
			--建立暫存檔:儲存使用者
			CREATE TABLE #UserIdTmp
			(
				UserId		varchar(20),
				ModifyStatus	char(1)
			)			
			INSERT INTO #UserIdTmp(UserId) EXEC dbo.sp_Common_SplitStr2Table @iUserIdArr;
			
			--本次無異動者
			UPDATE #UserIdTmp 
			SET ModifyStatus = 'N'
			WHERE UserId IN(
			SELECT UserId FROM UserRoleMap 
			WHERE RoleCode = @iRoleId
			AND UserId IN (
				SELECT UserId FROM #UserIdTmp
			))
			
			--本次新增者
			UPDATE #UserIdTmp 
			SET ModifyStatus = 'A'
			WHERE UserId IN(
			SELECT UserId FROM #UserIdTmp 
			WHERE UserId NOT IN (
				SELECT UserId FROM UserRoleMap
				WHERE RoleCode = @iRoleId
			))
			
			--本次刪除者
			INSERT INTO #UserIdTmp(UserId,ModifyStatus)
			SELECT UserId,'D' FROM UserRoleMap 
			WHERE RoleCode = @iRoleId
			AND UserId NOT IN(
				SELECT UserId FROM #UserIdTmp 
			)
			
			--新增：使用者與角色對應
			INSERT INTO UserRoleMap(RoleCode,UserId) 
				SELECT @iRoleId,UserId FROM #UserIdTmp WHERE ModifyStatus = 'A'
			
			SET @oDescription = @OperatorUserId + ' Insert User Into Role RoleCode=' + Convert(varchar,@iRoleId) + ' And UserId='  ;

			--新增：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				UserId,@iRoleId,'',UserId,
       				@oDescription + UserId,@iDocAuditCode,@iSessionId,
       				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ UserId,@iDocAuditCode)
			FROM #UserIdTmp WHERE ModifyStatus = 'A' 	
						
			
			--刪除：使用者與角色對應
			DELETE UserRoleMap
			WHERE RoleCode = @iRoleId
			AND UserId IN (
				SELECT UserId FROM #UserIdTmp WHERE ModifyStatus = 'D'
			)
			
			SET @oDescription = @OperatorUserId + ' Delete User From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And UserId='  ;

			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				UserId,@iRoleId,UserId,'',
       				@oDescription + UserId,@iDocAuditCode,@iSessionId,
       				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ UserId,@iDocAuditCode)
			FROM #UserIdTmp WHERE ModifyStatus = 'D' 	
			
		END	
	--刪除全部
	ELSE
		BEGIN
			
			SET @oDescription = @OperatorUserId + ' Delete User From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And UserId='  ;

			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				UserId,@iRoleId,UserId,'',
       				@oDescription + UserId,@iDocAuditCode,@iSessionId,
       				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ UserId,@iDocAuditCode)
			FROM UserRoleMap WHERE RoleCode = @iRoleId	
			
			--刪除：使用者與角色對應
			DELETE UserRoleMap
			WHERE RoleCode = @iRoleId
	
		END
/****************************************************************************/
/****************************** 新增表單群組 ********************************/	

		IF  @iFormGroupArr IS NOT NULL AND @iFormGroupArr <> ''
		BEGIN			
			
			--建立暫存檔:儲存表單群組
			CREATE TABLE #FormGroupTmp
			(
				FormGroupCode		varchar(20),
				ModifyStatus	char(1)
			)			
			INSERT INTO #FormGroupTmp(FormGroupCode) EXEC dbo.sp_Common_SplitStr2Table @iFormGroupArr;
			
			--原來已存在
			UPDATE #FormGroupTmp 
			SET ModifyStatus = 'N'
			WHERE FormGroupCode IN(
				SELECT FormGroupCode FROM RoleFormGroupMap
				WHERE RoleCode = @iRoleId
			)
			
			--本次新增者
			UPDATE #FormGroupTmp 
			SET ModifyStatus = 'A'
			WHERE FormGroupCode IN(
			SELECT FormGroupCode FROM #FormGroupTmp 
			WHERE FormGroupCode NOT IN (
				SELECT FormGroupCode FROM RoleFormGroupMap
				WHERE RoleCode = @iRoleId
			))
			
			--本次刪除者
			INSERT INTO #FormGroupTmp(FormGroupCode,ModifyStatus)
			SELECT FormGroupCode,'D' FROM RoleFormGroupMap 
			WHERE RoleCode = @iRoleId
			AND FormGroupCode NOT IN(
				SELECT FormGroupCode FROM #FormGroupTmp 
			)
			
			--新增：表單群組與角色對應
			INSERT INTO RoleFormGroupMap(RoleCode,FormGroupCode) 
				SELECT @iRoleId,FormGroupCode FROM #FormGroupTmp WHERE ModifyStatus = 'A'
				
			SET @oDescription = @OperatorUserId + ' Insert FormGroup Into Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FormGroup= ' ;

			--新增：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					FormGroupCode,RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				FormGroupCode,@iRoleId,
       				'',@iRoleId,'',FormGroupCode,
					@oDescription + FormGroupCode,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FormGroupCode,@iDocAuditCode)
			FROM #FormGroupTmp WHERE ModifyStatus = 'A' 	
			
			--刪除：表單群組與角色對應
			DELETE RoleFormGroupMap
			WHERE RoleCode = @iRoleId
			AND FormGroupCode IN (
				SELECT FormGroupCode FROM #FormGroupTmp WHERE ModifyStatus = 'D'
			)
			
			SET @oDescription = @OperatorUserId + ' Delete FormGroup From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FormGroup= ' ;

			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					FormGroupCode,RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				FormGroupCode,@iRoleId,
					'',@iRoleId,FormGroupCode,'',
					@oDescription + FormGroupCode ,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FormGroupCode,@iDocAuditCode)
			FROM #FormGroupTmp WHERE ModifyStatus = 'D' 	
			
			--select * from #FormGroupTmp					
		END 
	--刪除全部
	ELSE
		BEGIN
				
			SET @oDescription = @OperatorUserId + ' Delete FormGroup From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FormGroup= ' ;
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					FormGroupCode,RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				FormGroupCode,@iRoleId,
					'',@iRoleId,FormGroupCode,'',
					@oDescription + FormGroupCode,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FormGroupCode,@iDocAuditCode)
			FROM RoleFormGroupMap WHERE RoleCode = @iRoleId
			
			--刪除：表單群組與角色對應
			DELETE RoleFormGroupMap
			WHERE RoleCode = @iRoleId
	
		END	
		
/****************************************************************************/
/******************************** 新增功能 **********************************/	
	IF  @iFunctionArr IS NOT NULL AND @iFunctionArr <> ''
		BEGIN		
		
			--建立暫存檔:儲存功能代碼
			CREATE TABLE #RoleFunctionTmp
			(
				FunctionCode	varchar(100),
				ModifyStatus	char(1)
			)			
			INSERT INTO #RoleFunctionTmp(FunctionCode) EXEC dbo.sp_Common_SplitStr2Table @iFunctionArr;
			
			--原來已存在
			UPDATE #RoleFunctionTmp 
			SET ModifyStatus = 'N'
			WHERE FunctionCode IN(
				SELECT FunctionCode FROM RoleFunctionMap
				WHERE RoleCode = @iRoleId
			)
			
			--本次新增者
			UPDATE #RoleFunctionTmp 
			SET ModifyStatus = 'A'
			WHERE FunctionCode IN(
			SELECT FunctionCode FROM #RoleFunctionTmp 
			WHERE FunctionCode NOT IN (
				SELECT FunctionCode FROM RoleFunctionMap
				WHERE RoleCode = @iRoleId
			))
			
			--本次刪除者
			INSERT INTO #RoleFunctionTmp(FunctionCode,ModifyStatus)
			SELECT FunctionCode,'D' FROM RoleFunctionMap 
			WHERE RoleCode = @iRoleId
			AND FunctionCode NOT IN(
				SELECT FunctionCode FROM #RoleFunctionTmp 
			)
			
			
			--新增：功能代碼與角色對應
			INSERT INTO RoleFunctionMap(RoleCode,FunctionCode) 
				SELECT @iRoleId,FunctionCode FROM #RoleFunctionTmp WHERE ModifyStatus = 'A'
						
			SET @oDescription = @OperatorUserId + ' Insert Function Into  Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FunctionCode = ' ;
						
			--新增：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,FunctionCode,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				'',FunctionCode,@iRoleId,'',FunctionCode,
       				@oDescription + FunctionCode,@iDocAuditCode,@iSessionId,
       				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FunctionCode,@iDocAuditCode)
			FROM #RoleFunctionTmp WHERE ModifyStatus = 'A' 	
			
			
			--刪除：功能代碼與角色對應
			DELETE RoleFunctionMap
			WHERE RoleCode = @iRoleId
			AND FunctionCode IN (
				SELECT FunctionCode FROM #RoleFunctionTmp WHERE ModifyStatus = 'D'
			)
			
			SET @oDescription = @OperatorUserId + ' Delete Function From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FunctionCode = ' ;
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,FunctionCode,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				'',FunctionCode,@iRoleId,FunctionCode,'',
					@oDescription+ FunctionCode,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FunctionCode,@iDocAuditCode)
			FROM #RoleFunctionTmp WHERE ModifyStatus = 'D' 		
			
					
		END 
	--刪除全部
	ELSE
		BEGIN
			
			SET @oDescription = @OperatorUserId + ' Delete Function From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And FunctionCode = ' ;
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,FunctionCode,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				'',FunctionCode,@iRoleId,FunctionCode,'',
       				@oDescription+ FunctionCode,@iDocAuditCode,@iSessionId,
       				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ FunctionCode,@iDocAuditCode)
			FROM RoleFunctionMap WHERE  RoleCode = @iRoleId
			
			--刪除：功能代碼與角色對應
			DELETE RoleFunctionMap
			WHERE RoleCode = @iRoleId
	
		END	

/****************************************************************************/
/****************************** 新增掃描管道 ********************************/	
	IF  @iScanTypeArr IS NOT NULL AND @iScanTypeArr <> ''
		BEGIN		
		
			--建立暫存檔:儲存功能代碼
			CREATE TABLE #RoleScanTypeTmp
			(
				ScanTypeId		varchar(100),
				ModifyStatus	char(1)
			)			
			INSERT INTO #RoleScanTypeTmp(ScanTypeId) EXEC dbo.sp_Common_SplitStr2Table @iScanTypeArr;
			
			--原來已存在
			UPDATE #RoleScanTypeTmp 
			SET ModifyStatus = 'N'
			WHERE ScanTypeId IN(
				SELECT ScanTypeId FROM RoleScanTypeMap
				WHERE RoleCode = @iRoleId
			)
			
			--本次新增者
			UPDATE #RoleScanTypeTmp 
			SET ModifyStatus = 'A'
			WHERE ScanTypeId IN(
			SELECT ScanTypeId FROM #RoleScanTypeTmp 
			WHERE ScanTypeId NOT IN (
				SELECT ScanTypeId FROM RoleScanTypeMap
				WHERE RoleCode = @iRoleId
			))
			
			--本次刪除者
			INSERT INTO #RoleScanTypeTmp(ScanTypeId,ModifyStatus)
			SELECT ScanTypeId,'D' FROM RoleScanTypeMap 
			WHERE RoleCode = @iRoleId
			AND ScanTypeId NOT IN(
				SELECT ScanTypeId FROM #RoleScanTypeTmp 
			)
			
			
			--新增：掃描管道與角色對應
			INSERT INTO RoleScanTypeMap(RoleCode,ScanTypeId) 
				SELECT @iRoleId,ScanTypeId FROM #RoleScanTypeTmp WHERE ModifyStatus = 'A'
						
			SET @oDescription = @OperatorUserId + ' Insert Scantype Into  Role RoleCode=' + Convert(varchar,@iRoleId) + ' And ScanType = ' ;
						
			--新增：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,ScanTypeId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
       				'',ScanTypeId,@iRoleId,'',ScanTypeId,
					@oDescription + ScanTypeId,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ ScanTypeId,@iDocAuditCode)
			FROM #RoleScanTypeTmp WHERE ModifyStatus = 'A' 	
			
			
			--刪除：掃描管道與角色對應
			DELETE RoleScanTypeMap
			WHERE RoleCode = @iRoleId
			AND ScanTypeId IN (
				SELECT ScanTypeId FROM #RoleScanTypeTmp WHERE ModifyStatus = 'D'
			)
			
			SET @oDescription = @OperatorUserId + ' Delete ScanType From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And ScanType = ' ;
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,ScanTypeId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
					'',ScanTypeId,@iRoleId,ScanTypeId,'',
					@oDescription+ ScanTypeId,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ ScanTypeId,@iDocAuditCode)
			FROM #RoleScanTypeTmp WHERE ModifyStatus = 'D' 		
			
					
		END 
	--刪除全部掃描管道
	ELSE
		BEGIN
			
			SET @oDescription = @OperatorUserId + ' Delete ScanType From Role RoleCode=' + Convert(varchar,@iRoleId) + ' And ScanType = ' ;
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,ScanTypeId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT
					@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
       				@iRoleId,
					'',ScanTypeId,@iRoleId,ScanTypeId,'',
					@oDescription+ ScanTypeId,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription+ ScanTypeId,@iDocAuditCode)
			FROM RoleScanTypeMap WHERE  RoleCode = @iRoleId
			
			--刪除：掃描管道與角色對應
			DELETE RoleScanTypeMap
			WHERE RoleCode = @iRoleId
	
		END	

/****************************************************************************/
/******************************** 修改業務別 ********************************/	
	IF  @iBusinessType IS NOT NULL AND @iBusinessType <> ''
		BEGIN			
			DELETE RoleBusinessTypeMap WHERE RoleCode = @iRoleId
			INSERT INTO RoleBusinessTypeMap(RoleCode,BusinessTypeCode) VALUES (@iRoleId,@iBusinessType);
		END

/****************************************************************************/
/********************************* 修改名稱 *********************************/	

	UPDATE Role SET RoleName = @iRoleName 
	WHERE RoleCode = @iRoleId
	AND RoleName <> @iRoleName


/****************************************************************************/
/**************************** 異動遮罩類別的設定 ****************************/	

	exec dbo.sp_ezAcquire_Role_ManageMaskTypeInsert @OperatorUserId,@OperatorIP,@iRoleId,@iFormGroupArr,@iSecurityArr,@iMaskTypeArr,@iSessionId,@iDocAuditCode
		
		
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT * FROM Role WHERE RoleCode = @iRoleId
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_ManageQuery]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(50),	--操作者IP
	
	@targetRoleId		bigint,			--被查詢角色代碼
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Role TargetRoleId =' + Convert(varchar,@targetRoleId);
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		RoleId,
		TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','5',           
		@targetRoleId,
		'',@targetRoleId,'','',
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'5',@oDescription,@iDocAuditCode)
	)
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Role_MaskTypeInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Role_MaskTypeInsert]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iMaskTypeName	varchar(50),	--新增的遮罩類別
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE @newMaskTypeId int;		--新增的遮罩類別
	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/****************************** 新增遮罩類別 ********************************/	

	INSERT INTO ImageMaskType(ImageMaskTypeName) VALUES (@iMaskTypeName);
	
	--新增的遮罩類別
	SET @newMaskTypeId = (SELECT MAX(ImageMaskTypeId) FROM ImageMaskType);
	
	SET @oDescription = @OperatorUserId + ' Insert ImageMaskType ImageMaskTypeId=' +  
						Convert(varchar,@newMaskTypeId) + ' And ImageMaskTypeName=' + @iMaskTypeName;
	
	--寫入LOG檔
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			MaskTypeId,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','4',           
    		@newMaskTypeId,
    		@newMaskTypeId,'',@newMaskTypeId,
    		@oDescription ,@iDocAuditCode,@iSessionId,
    		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'4',@oDescription,@iDocAuditCode)
	)				
	
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	SELECT @newMaskTypeId as newMaskTypeId
	
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_SAMQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_SAMQuery]

	@QueryUserId		varchar(50),	--查詢者代碼
	@QueryIP			varchar(30),	--查詢者IP	
		
	@iFormId			Varchar(20),	--表單代碼
	@iScanDateS			Varchar(20),	--掃描日期起
	@iScanDateE			Varchar(20),	--掃描日期迄
	@iSalesId			Varchar(20),	--業務員Id
	@iBoxNo				Varchar(20),	--箱號
	@iSalesNoteDate		Varchar(20),	--註記日期	
	@iSalesNoteUser		Varchar(20),	--註記人員	
	
	@OperatedSystem		varchar(50),	--操作系統:'ImageQuery_Form','ImageQuery_Web'
	@DocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
	/*
	exec dbo.sp_ezAcquire_SAMQuery 
	'','',
	'111120','','','','','','',
	'','',''
	
	*/
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/********************************* 查詢條款 *********************************/	
	
	DECLARE @queryTableString	VARCHAR(MAX);	--queryTable的指令字串
	SET @queryTableString = 'SELECT D.*,F.FormName ' + 
							--'ISNULL(I_55,'''') SalesId,ISNULL(I_59,'''') BoxNo,' + 
							--'ISNULL(I_64,'''') SalesNote,ISNULL(I_65,'''') SalesNoteUser,ISNULL(I_70,'''') SalesNoteDate ' +
							'FROM DocumentIndex d ' + 
							'LEFT JOIN Form F ON d.Formid = F.Formid ' +
							'WHERE Scantype IN( ''SAM'',''PID'') '
	--表單代碼
	IF (@iFormId IS NOT NULL AND @iFormId <> '')
		SET @queryTableString = @queryTableString + ' AND D.FormId = ''' + @iFormId + ''' '
	
	--掃描日期起
	IF (@iScanDateS IS NOT NULL AND @iScanDateS <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime >= ''' + @iScanDateS + ' 00:00:00'' '
	
	--掃描日期迄
	IF (@iScanDateE IS NOT NULL AND @iScanDateE <> '')
		SET @queryTableString = @queryTableString + ' AND ScanDatetime <= ''' + @iScanDateE + ' 23:59:59'' '
	
	--業務員Id
	IF (@iSalesId IS NOT NULL AND @iSalesId <> '')
		SET @queryTableString = @queryTableString + ' AND I_55 = ''' + @iSalesId + ''' '
	
	--箱號
	IF (@iBoxNo IS NOT NULL AND @iBoxNo <> '')
		SET @queryTableString = @queryTableString + ' AND I_59 = ''' + @iBoxNo + ''' '
	
	--註記日期
	IF (@iSalesNoteDate IS NOT NULL AND @iSalesNoteDate <> '')
		SET @queryTableString = @queryTableString + ' AND I_70 = ''' + @iSalesNoteDate + ''' '
	
	--註記人員
	IF (@iSalesNoteUser IS NOT NULL AND @iSalesNoteUser <> '')
		SET @queryTableString = @queryTableString + ' AND I_65 = ''' + @iSalesNoteUser + ''' '
	
	
/****************************************************************************/
/****************************** 寫入ReportLog *******************************/	
	
	DECLARE	@oDescription varchar(max);

	SET @oDescription = @QueryUserId + ' Query SAM IMAGE ' ;
	
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
        [Description],DocAuditCode,SessionId,RandomString)
	Values(
		@QueryIP, @QueryUserId,@OperatedSystem,'22', 
       	@oDescription,@DocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@QueryUserId,'22',@oDescription,@DocAuditCode))
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
	
	--SELECT @queryTableString;
	EXEC(@queryTableString);
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageDelete]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageDelete]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iStationMAC		varchar(50),	--掃描工作站MAC Address
		
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/*************************** 刪除掃描工作站位LOG ****************************/	
	DECLARE @oDescription  varchar(max)
		
	SET @oDescription = @OperatorUserId + ' Delete ScanStation StationMAC = ' + @iStationMAC;

/****************************************************************************/
/*************************** 刪除掃描工作站 *********************************/	
	DELETE ScanStation
	WHERE StationMAC = @iStationMAC
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','28',           
       		@iStationMAC,@iStationMAC,'',
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'28',@oDescription,@iDocAuditCode)
	)
  
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from ScanStation where StationMAC = @iStationMAC
	
	/*
		exec dbo.sp_ezAcquire_ScanStation_ManageDelete 'SysAdmin','10.0.0.183:50692',
														'Station01',
														'',''
	
	*/
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageInsert]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	                	
	@iStationMAC		varchar(50),	--掃描工作站MAC Address
	@iDescription		nvarchar(300),	--掃描工作站描述
	@iRandomString		varchar(300),	--加密欄位
	@iAddOn_1			varchar(50),	--附加屬性值1：IDOCR(渣打)
	@iAddOn_2			varchar(50),	--附加屬性值2
	@iAddOn_3			varchar(50),	--附加屬性值3
	@iAddOn_4			varchar(50),	--附加屬性值4
	@iAddOn_5			varchar(50),	--附加屬性值5
	@iUnitCode			varchar(20),	--單位代碼
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************** 新增單位 **********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert ScanStation StationMAC = '+  @iStationMAC;

	INSERT INTO ScanStation
	(StationMAC,Description,RandomString,AddOn_1,AddOn_2,AddOn_3,AddOn_4,AddOn_5,UnitCode)
    VALUES
    (@iStationMAC,@iDescription,@iRandomString,@iAddOn_1,@iAddOn_2,@iAddOn_3,@iAddOn_4,@iAddOn_5,@iUnitCode)
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','27',           
       		@iStationMAC,'',@iStationMAC,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'27',@oDescription,@iDocAuditCode)
	)
	

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from ScanStation where StationMAC = @iStationMAC
	
	/*
		exec dbo.sp_ezAcquire_ScanStation_ManageInsert 'SysAdmin','10.0.0.183:50692',
														'Station71','Station71','Station71',
														'Y','','','','','Ivy101',
														'',''
	
	*/
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanStation_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_ScanStation_ManageModify]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iStationMAC		varchar(50),	--掃描工作站MAC Address
	@iDescription		nvarchar(300),	--掃描工作站描述
	@iRandomString		varchar(300),	--加密欄位
	@iAddOn_1			varchar(50),	--附加屬性值1：IDOCR(渣打)
	@iAddOn_2			varchar(50),	--附加屬性值2
	@iAddOn_3			varchar(50),	--附加屬性值3
	@iAddOn_4			varchar(50),	--附加屬性值4
	@iAddOn_5			varchar(50),	--附加屬性值5
	@iUnitCode			varchar(20),	--單位代碼
		
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/*************************** 修改掃描工作站位LOG ****************************/	
	DECLARE @oDescription  varchar(max)
		
	SET @oDescription = @OperatorUserId + ' Update ScanStation StationMAC =' + @iStationMAC;

/****************************************************************************/
/*************************** 修改掃描工作站 *********************************/	
	UPDATE ScanStation
	SET 
	Description		= @iDescription,
	RandomString	= @iRandomString,
	AddOn_1			= @iAddOn_1,
	AddOn_2			= @iAddOn_2,
	AddOn_3			= @iAddOn_3,
	AddOn_4			= @iAddOn_4,
	AddOn_5			= @iAddOn_5,
	UnitCode		= @iUnitCode
	WHERE StationMAC = @iStationMAC
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','29',           
       		@iStationMAC,@iStationMAC,@iStationMAC,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'29',@oDescription,@iDocAuditCode)
	)
  
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from ScanStation where StationMAC = @iStationMAC
	
	/*
		exec dbo.sp_ezAcquire_ScanStation_ManageModify 'SysAdmin','10.0.0.183:50692',
														'Station71','Station01_','Station01_',
														'Y','','','','','Ivy100',
														'',''
	
	*/
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_ScanVerify]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_ScanVerify]

	@ScanUserId		varchar(50),	--掃描者代碼
	@ScanIP			varchar(50),	--掃描IP
	@ScanDateTime	datetime,		--掃描時間
	
	@VerifyUserId	varchar(50),	--品管者代碼
	@VerifyIP		varchar(50),	--品管IP
	@VerifyDateTime	datetime,		--品管時間
		
	@DocumentId		bigint,			--掃入的影像編號
	@FormId			varchar(50),	--掃入的表單編號
	@ScanTypeId		varchar(50),	--掃入的掃描管道	
	
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
		
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @ScanUserId + ' Scan Form FormId=' + @FormId + ' And DocumentId=' + Convert(varchar,@DocumentId);
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperationDate,OperatedSystem,OperationFunction,
	    DocumentId,FormId,ScanTypeId,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@ScanIP,@ScanUserId,@ScanDateTime,'SystemAdmin','12',           
	    @DocumentId,@FormId,@ScanTypeId,@DocumentId,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@ScanUserId,'12',@oDescription,@iDocAuditCode)
	)	

	SET @oDescription = @VerifyUserId + ' Verify Form FormId=' + @FormId + ' And DocumentId=' + Convert(varchar,@DocumentId);
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperationDate,OperatedSystem,OperationFunction,
	    DocumentId,FormId,ScanTypeId,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@VerifyIP,@VerifyUserId,@VerifyDateTime,'SystemAdmin','12',           
	    @DocumentId,@FormId,@ScanTypeId,@DocumentId,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@VerifyUserId,'12',@oDescription,@iDocAuditCode)
	)	
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_SignatureQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_SignatureQuery]

	@iQueryType			Varchar(1),			--查詢類別:'A'-保費 'P'-保服 'N'-契約
	@iPara_1			Varchar(20),		--參數1
	@iPara_2			Varchar(20),		--參數2
	@iPara_3			Varchar(20),		--參數3
	@iPara_4			Varchar(20)			--參數4	
	
	--exec dbo.sp_ezAcquire_SignatureQuery 'N','1000327882','','H220587384',''
	--exec dbo.sp_ezAcquire_SignatureQuery 'A','','','1000327882','H220587384'
	--exec dbo.sp_ezAcquire_SignatureQuery 'N','A123456789','B123456789','A123456789','A123456789'

	
/*
保服簽名,QueryType = 'P'	
	參數1=要保人ID		簽名=保戶簽章樣式卡
	參數2=契變案號		簽名=契變書最新簽名樣式
	參數3=保單號碼		簽名=要保書
	參數4=送件人ID		簽名=業務員簽章樣式卡

契約簽名,QueryType = 'N'	
	參數1=要保人ID		簽名=保戶簽章樣式卡
	參數2=被保人ID		簽名=保戶簽章樣式卡
	參數3=法定代理人_ID	簽名=保戶簽章樣式卡
	參數4=配偶_ID		簽名=保戶簽章樣式卡

保費簽名,QueryType = 'A'	
	參數1=要保人ID		簽名=保戶簽章樣式卡
	參數2=契變案號		簽名=契變書最新簽名樣式
	參數3=保單號碼		簽名=要保書
	參數4=送件人ID		簽名=業務員簽章樣式卡

*/	

AS
BEGIN
	SET NOCOUNT ON;
	

/****************************************************************************/
/********************************* 暫存資料 *********************************/	
		
	--建立暫存的影像資料
	DECLARE @SignatureTemp TABLE
	(
		Seq				int,						--順序
		DocumentId		varchar(50)		default '',	--影像編號
		FormId	 		varchar(20)		default '',	--表單代碼
		FormName 		varchar(200)	default '',	--表單名稱
		Pages			int				default 0,	--總頁數
		PageNumber 		int				default 0,	--頁碼
		XLeft	 		int				default 0,	--起始位置-X
		YTop	 		int				default 0,	--起始位置-Y
		Width	 		int				default 0,	--寬
		Height	 		int				default 0	--高
	)	
	
	INSERT INTO @SignatureTemp(Seq) VALUES (1);
	INSERT INTO @SignatureTemp(Seq) VALUES (2);
	INSERT INTO @SignatureTemp(Seq) VALUES (3);
	INSERT INTO @SignatureTemp(Seq) VALUES (4);		

/****************************************************************************/
/****************************** 保服/保費簽名 *******************************/	

	IF(@iQueryType = 'P' or @iQueryType = 'A')
	BEGIN
		
		--參數1=要保人ID		簽名=保戶簽章樣式卡
		IF @iPara_1 <> '' 
		BEGIN
			UPDATE
				 @SignatureTemp 
			SET
				 DocumentId = T.DocumentId,
				 FormId = T.FormId, 
				 FormName = T.FORMNAME,
				 Pages = T.Pages,
				 PageNumber = T.PageNumber,
				 XLeft = T.XLeft,
				 YTop = T.YTop,
				 Width = T.Width,
				 Height = T.Height
			FROM
				 @SignatureTemp AS S
			INNER JOIN(
				SELECT  TOP 1 1 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
				FROM DocumentIndex D
				LEFT JOIN Form F ON D.FormID = F.FormId
				LEFT JOIN Signatures S ON S.FormId = F.FormID
				WHERE I_48  = @iPara_1
				AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'USRSGN')
				ORDER BY D.CREATEDATETIME DESC			
			) AS T 
			ON S.Seq = T.Seq 
		END		
		
		--參數2=契變案號		簽名=契變書最新簽名樣式
		IF @iPara_2 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN (
			SELECT  TOP 1 2 as Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE DOCUMENTID IN (SELECT DOCUMENTID FROM MultipleIndex_I_52 WHERE INDEXVALUE =  @iPara_2)
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'POSSGN')
			ORDER BY D.CREATEDATETIME DESC
			) AS T 
		ON S.Seq = T.Seq 	
		END	
		
		--參數3=保單號碼		簽名=要保書
		IF @iPara_3 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN (
			SELECT  TOP 1 3 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE DOCUMENTID IN (SELECT DOCUMENTID FROM MultipleIndex_I_50 WHERE INDEXVALUE =  @iPara_3)
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'NBSSGN')
			ORDER BY D.CREATEDATETIME DESC
		) AS T 
		ON S.Seq = T.Seq 
		END
		
		
		--參數4=送件人ID		簽名=業務員簽章樣式卡
		IF @iPara_4 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN (
			SELECT TOP 1 4 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE (I_55  = @iPara_4 or I_48 = @iPara_4)
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'SALSGN')
			ORDER BY D.CREATEDATETIME DESC			
		) AS T 
		ON S.Seq = T.Seq 
		END
	END
/****************************************************************************/
/****************************** 契約簽名 *******************************/	

	IF(@iQueryType = 'N')
	BEGIN
		--參數1=要保人ID	簽名=保戶簽章樣式卡
		IF @iPara_1 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN(
			SELECT  TOP 1 1 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE I_48  = @iPara_1
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'USRSGN')
			ORDER BY D.CREATEDATETIME DESC			
		) AS T 
		ON S.Seq = T.Seq 
		END

		--參數2=被保人ID	簽名=保戶簽章樣式卡
		IF @iPara_2 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN(
			SELECT  TOP 1 2 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE I_48  = @iPara_2
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'USRSGN')
			ORDER BY D.CREATEDATETIME DESC			
		) AS T 
		ON S.Seq = T.Seq
		END

		--參數3=法定代理人_ID	簽名=保戶簽章樣式卡
		IF @iPara_3 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN (
			SELECT  TOP 1 3 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE I_48  = @iPara_3
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'USRSGN')
			ORDER BY D.CREATEDATETIME DESC			
		) AS T 
		ON S.Seq = T.Seq 
		END

		--參數4=配偶_ID	簽名=保戶簽章樣式卡
		IF @iPara_4 <> '' 
		BEGIN
		UPDATE
			 @SignatureTemp 
		SET
			 DocumentId = T.DocumentId,
			 FormId = T.FormId, 
			 FormName = T.FORMNAME,
			 Pages = T.Pages,
			 PageNumber = T.PageNumber,
			 XLeft = T.XLeft,
			 YTop = T.YTop,
			 Width = T.Width,
			 Height = T.Height
		FROM
			 @SignatureTemp AS S
		INNER JOIN (
			SELECT  TOP 1 4 Seq, DOCUMENTID,F.FORMID,F.FormName,D.Pages,S.PageNumber,S.XLeft,S.YTop,S.Width,S.Height
			FROM DocumentIndex D
			LEFT JOIN Form F ON D.FormID = F.FormId
			LEFT JOIN Signatures S ON S.FormId = F.FormID
			WHERE I_48  = @iPara_4
			AND D.FORMID IN ( SELECT FORMID FROM formgroupmap WHERE formgroupcode = 'USRSGN')
			ORDER BY D.CREATEDATETIME DESC				
		) AS T 
		ON S.Seq = T.Seq 
		END
	END
/****************************************************************************/
/********************************* 傳出結果 *********************************/	

	select * FROM @SignatureTemp;
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageInsert]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageInsert]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	                	
	@iUnitCode			nvarchar(20),	--新增的單位代碼
	@iUnitName			nvarchar(100),	--新增的單位名稱
	@iStationCount		int,			--掃描工作站數
	@iOCRCount			int,			--OCR數	
	
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************** 新增單位 **********************************/	

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Insert Unit UnitCode =' +  @iUnitCode + 
						' UnitName = ' +  @iUnitName + 
						' ScanStationCount = ' + CAST(@iStationCount AS VARCHAR) + 
						' OCRCount = ' + CAST(@iOCRCount AS VARCHAR) ;

	INSERT INTO Unit
	(UnitCode,	UnitName,	ScanStationCount,	OCRCount)
    VALUES
    (@iUnitCode,@iUnitName,	@iStationCount,	@iOCRCount)
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			UnitCode,TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','24',           
       		@iUnitCode,@iUnitCode,'',@iUnitCode,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'24',@oDescription,@iDocAuditCode)
	)
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from Unit where UnitCode = @iUnitCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageModify]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageModify]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(30),	--操作者IP
	
	@iUnitCode			nvarchar(20),	--修改的單位代碼
	@iUnitName			nvarchar(100),	--修改的單位名稱
	@iStationCount		int,			--掃描工作站數
	@iOCRCount			int,			--OCR數	
		
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
	
AS
BEGIN
	SET NOCOUNT ON;
	
/****************************************************************************/
/******************************* 修改單位LOG ********************************/	
	DECLARE @oDescription  varchar(max)
		
	SET @oDescription = @OperatorUserId + ' Update Unit UnitCode =' +  @iUnitCode + 
						' UnitName = ' +  @iUnitName + 
						' ScanStationCount = ' + CAST(@iStationCount AS VARCHAR) + 
						' OCRCount = ' + CAST(@iOCRCount AS VARCHAR) ;

/****************************************************************************/
/******************************** 修改單位 **********************************/	
	UPDATE Unit
	SET UnitName = @iUnitName,
	ScanStationCount = @iStationCount,
	OCRCount = @iOCRCount
	WHERE UnitCode = @iUnitCode
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			UnitCode,
			TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
			@OperatorIP,@OperatorUserId,'SystemAdmin','24',           
       		@iUnitCode,
			@iUnitCode,'',@iUnitName,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'24',@oDescription,@iDocAuditCode)
	)
  
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * from Unit where UnitCode = @iUnitCode
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_Unit_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_Unit_ManageQuery]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(50),	--操作者IP
	
	@targetUnitCode		varchar(50),	--被查詢單位代碼
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
		
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query Unit TargetUnitCode =' + @targetUnitCode;
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
	    UnitCode,TransactionTatget,
	    [Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','25',           
		@targetUnitCode,@targetUnitCode,
	    @oDescription,@iDocAuditCode,@iSessionId,
	    dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'25',@oDescription,@iDocAuditCode)
	)	
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_Login]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_Login]

	@loginUserId		varchar(50),	--登入者代碼
	@loginIP			varchar(50),	--登入者IP	
	@loginSystem		varchar(20),	--SystemAdmin、Scan、ImageQuery_Form、ImageQuery_Web、Filing
	@loginResult		varchar(1),		--1:登入成功 2:密碼有誤 3.無此帳號 4:權限不足 
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE	@oDescription varchar(max);
	
/************************************************************************************** 
	登入記錄,AuditCode = 1
**************************************************************************************/

	SET @oDescription = @loginUserId + ' Login System:' + @loginSystem + ' ' + 
		( CASE @loginResult WHEN '1' THEN '登入成功 ' WHEN '2' THEN '密碼有誤' WHEN '3' THEN '無此帳號' WHEN '4' THEN '權限不足' ELSE '其他異常狀況' END);
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		TargetUserId,TransactionTatget,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@loginIP,@loginUserId,@loginSystem,'1',           
		@loginUserId,@loginUserId,
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@loginUserId,'1',@oDescription,@iDocAuditCode)
	)
	
/************************************************************************************** 
	登入成功更新使用者FailCount
**************************************************************************************/
	IF (@loginResult = '1')
	BEGIN
		--更新使用者登入失敗次數=0
		UPDATE [User]
		SET FailCount = 0
		WHERE UserId = @loginUserId	
	
	END
	
/************************************************************************************** 
	登入密碼有誤時再多寫一個記錄,AuditCode = 23
	更新使用者FailCount
**************************************************************************************/
	
	IF (@loginResult = '2')
	BEGIN
		
		DECLARE	@oFailCount int;
		
		
		--更新使用者登入失敗次數
		UPDATE [User]
		SET FailCount = FailCount + 1
		WHERE UserId = @loginUserId	
		
		SET @oFailCount = (select FailCount from [User] WHERE UserId = @loginUserId)
		
		--寫入Audit
		SET @oDescription = @loginUserId + ' Login System:' + @loginSystem + ' ' + 
							' Input Wrong Password ' + CAST(@oFailCount as varchar) + ' Times';
		
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			TargetUserId,TransactionTatget,
			[Description],DocAuditCode,SessionId,RandomString
		)VALUES(
			@loginIP,@loginUserId,@loginSystem,'23',           
			@loginUserId,@loginUserId,
			@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@loginUserId,'23',@oDescription,@iDocAuditCode)
		)
		
	END	
	
/**************************************************************************************/	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_Logout]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_Logout]

	@logoutUserId		varchar(50),	--登出者代碼
	@logoutIP			varchar(50),	--登出者IP	
	@logoutSystem		varchar(20),	--SystemAdmin、Scan、ImageQuery_Form、ImageQuery_Web、Filing
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @logoutUserId + ' Logout System:' + @logoutSystem;
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		TargetUserId,TransactionTatget,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@logoutIP,@logoutUserId,@logoutSystem,'1',           
		@logoutUserId,@logoutUserId,
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@logoutUserId,'1',@oDescription,@iDocAuditCode)
	)
		
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageDeleteMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_ManageDeleteMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iUserId		nvarchar(20),	--刪除的使用者代碼
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iSessionId		varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);
	DECLARE @oRoleid int;
	
/****************************************************************************/
/******************************** 刪除使用者 ********************************/	

	-- 將Deleted設為'Y'	
	UPDATE [User] SET Deleted = 'Y' WHERE UserId = @iUserId

	--刪除：使用者與角色對應
	SET @oRoleid = (SELECT TOP 1 RoleCode FROM UserRoleMap WHERE UserId = @iUserId)
	DELETE UserRoleMap WHERE UserId = @iUserId

	--刪除UserBusinessTypeMap
	DELETE UserBusinessTypeMap WHERE UserId = @iUserId
	
		
/****************************************************************************/
/******************************* 記錄AUDIT **********************************/	
	
	SET @oDescription =@iUserId + ' Delete User UserCode =' +  @iUserId + ' And Delete UserRoleMap' ;

	--刪除：寫入報表LOG檔
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
				OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
				RoleId,TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
				[Description],DocAuditCode,SessionId,RandomString
	)VALUES(	
			@OperatorIP,@OperatorUserId,'SystemAdmin','15',           
       		@oRoleid,@iUserId,@iUserId,@iUserId,'', 
       		@oDescription,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'15',@oDescription,@iDocAuditCode)
	)
	
	--DELETE UserRoleMap WHERE UserId = @iUserId
	
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
	SELECT * FROM [User] WHERE UserId = @iUserId;
	
	--exec dbo.sp_ezAcquire_User_ManageDeleteMap 'SysAdmin','10.0.0.183:50692','Ivy','',''

		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageInsertMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_ManageInsertMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iUserId		nvarchar(20),	--新增的使用者代碼
	@iUserName		nvarchar(100),	--新增的使用者名稱
	@iPassword		nvarchar(20),	--新增的使用者密碼

	@iRoleIdArr		varchar(max),	--新增的群組代碼清單
	@iDocAuditCode	varchar(100),	--傳入的檢核碼
	@iUserCheckCode	varchar(128),	--傳入的檢核碼

	@iIsActive		varchar(2),		--是否啟用
	@iUnitCode		varchar(20),	--單位代碼
	@iEnableDate	datetime,		--啟用日期
	@iDisableDate	datetime,		--停用日期
	@iBusinessType	varchar(max),	--業務類別

	@iSessionId		varchar(100)	--SessionId

	/*
	exec dbo.sp_ezAcquire_User_ManageInsertMap 'SysAdmin','10.0.0.183:50692',
												'Ivy','Ivy','Ivy',
												'1|2|3','',	'',
												'Y','','2014/11/11','2099/12/31','NB'
												''
	*/
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/**************************** 檢查使用者是否存在 ****************************/	

	DECLARE	@oUserExist int;
	
	SET @oUserExist = (SELECT COUNT(*) FROM [User] WHERE UserId = @iUserId)
	
	-- 此使用者已存在，將Deleted設為'N'
	IF (@oUserExist > 0 )
		BEGIN
			UPDATE [User] SET Deleted = 'N' WHERE UserId = @iUserId

			SET @oDescription = @iUserId + ' ReOpen User UserId =' +  @iUserId + ' And UserName=' + @iUserName +
							' And Password=' + @iPassword + ' And IsActive = ' + @iIsActive +
							' And UnitCode' + @iUnitCode + ' And BusinessType = ' + @iBusinessType;

			--修改使用者的業務類別
			IF  @iBusinessType IS NOT NULL AND @iBusinessType <> ''
				UPDATE UserBusinessTypeMap SET BusinessTypeCode = @iBusinessType WHERE UserId = @iUserId

			--修改使用者的資料寫入Audit
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
				OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
				TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
				[Description],DocAuditCode,SessionId,RandomString)
			SELECT	
				@OperatorIP,@OperatorUserId,'SystemAdmin','2',       
       			@iUserId,@iUserId,@iUserId,@iUserId, 
       			@oDescription ,@iDocAuditCode,@iSessionId,
				dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)

		END
	
/****************************************************************************/
/******************************** 新增使用者 ********************************/	
	ELSE
		BEGIN 

		INSERT INTO [User]
			(UserId,UserName,Password,RandomString,IsActive,UnitCode,CreatedUser,EnableDate,DisableDate) 
		VALUES 
			(@iUserId,@iUserName,@iPassword,@iUserCheckCode,@iIsActive,@iUnitCode,@OperatorUserId,@iEnableDate,@iDisableDate);
	
		SET @oDescription = @iUserId + ' Insert User=' +  @iUserId + ' And UserName=' + @iUserName +
							' And Password=' + @iPassword + ' And IsActive = ' + @iIsActive +
							' And UnitCode' + @iUnitCode  + ' And BusinessType = ' + @iBusinessType;

		--新增使用者的業務類別
		IF  @iBusinessType IS NOT NULL AND @iBusinessType <> ''
			INSERT INTO UserBusinessTypeMap(UserId,BusinessTypeCode) VALUES (@iUserId,@iBusinessType)

		--新增使用者的資料寫入Audit
		INSERT INTO ezAcquireAudit.dbo.AuditLog(
			OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
			TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
			[Description],DocAuditCode,SessionId,RandomString)
		SELECT	
			@OperatorIP,@OperatorUserId,'SystemAdmin','2',       
       		@iUserId,@iUserId,@iUserId,@iUserId, 
       		@oDescription ,@iDocAuditCode,@iSessionId,
			dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)

		END

	/****************************************************************************/
	/******************************* 新增群組 ***********************************/	
	
		IF  @iRoleIdArr IS NOT NULL AND @iRoleIdArr <> ''
			BEGIN			
			
				DECLARE @sRoleId VARCHAR(50)
				DECLARE RoleId_Data CURSOR FOR
					Select splitValue From dbo.fnc_split(@iRoleIdArr,'|')			
				OPEN RoleId_Data
					FETCH NEXT FROM RoleId_Data
					INTO @sRoleId
			
				WHILE @@FETCH_STATUS = 0
				BEGIN
					--寫入對應檔
					INSERT INTO UserRoleMap(RoleCode,UserId) VALUES(@sRoleId,@iUserId)
				
					SET @oDescription = @OperatorUserId + ' Insert Role and User, UserId=' +  @iUserId + ' And RoleCode=' + @sRoleId

					--寫入報表LOG檔
					INSERT INTO ezAcquireAudit.dbo.AuditLog(
						OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
						RoleId,TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
						[Description],DocAuditCode,SessionId,RandomString
					)VALUES(
						@OperatorIP,@OperatorUserId,'SystemAdmin','2',           
       					@sRoleId,@iUserId,@iUserId,'',@sRoleId,
       					@oDescription ,@iDocAuditCode,@iSessionId,
						dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)
					)			
									
					FETCH NEXT FROM RoleId_Data 
					INTO @sRoleId																		
				END

				CLOSE RoleId_Data
				DEALLOCATE RoleId_Data	

			END
		
/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		SELECT * FROM [User] where UserId = @iUserId		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageModifyMap]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_ManageModifyMap]

	@OperatorUserId	varchar(50),	--操作者代碼
	@OperatorIP		varchar(30),	--操作者IP
	
	@iUserId		nvarchar(20),	--修改的使用者代碼
	@iUserName		nvarchar(100),	--修改的使用者名稱
	@iPassword		nvarchar(20),	--修改的使用者密碼

	@iRoleIdArr		varchar(max),	--使用者角色清單
	@iDocAuditCode	varchar(100),	--傳入的檢核碼	
	@iUserCheckCode	varchar(128),	--驗證碼

	@iIsActive		varchar(2),		--是否啟用
	@iUnitCode		varchar(20),	--單位代碼
	@iEnableDate	datetime,		--啟用日期
	@iDisableDate	datetime,		--停用日期
	@iBusinessType	varchar(max),	--業務類別

	@iSessionId		varchar(100)	--SessionId

	/*
	exec dbo.sp_ezAcquire_User_ManageModifyMap 
	'SysAdmin','10.0.0.183:50692',
	'Ivy','Ivy','Ivy',
	'1|2|3','','',
	'Y','','2014/12/01','2098/01/01','PS'
	''

	*/
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);
	
/****************************************************************************/
/****************************** 處理使用者 **********************************/		
	
	UPDATE [User] 
	SET UserName = @iUserName, 
	[Password] = @iPassword,
	RandomString = @iUserCheckCode,
	IsActive = @iIsActive,
	UnitCode = @iUnitCode,
	EnableDate = @iEnableDate,
	DisableDate = @iDisableDate
	WHERE UserId = @iUserId

	SET @oDescription = @iUserId + ' Modify User=' +  @iUserId + ' And UserName=' + @iUserName +
						' And Password=' + @iPassword + ' And IsActive = ' + @iIsActive +
						' And UnitCode' + @iUnitCode + ' And BusinessType = ' + @iBusinessType;

	--寫入Audit
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
		[Description],DocAuditCode,SessionId,RandomString)
	SELECT	
		@OperatorIP,@OperatorUserId,'SystemAdmin','2',           
       	@iUserId,@iUserId,@iUserId,@iUserId, 
       	@oDescription ,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)

/****************************************************************************/
/******************************* 處理群組 ***********************************/	
	IF  @iRoleIdArr IS NOT NULL AND @iRoleIdArr <> ''
		BEGIN			
						
			--建立暫存檔:儲存使用者
			CREATE TABLE #RoleIdTmp
			(
				RoleCode		varchar(20),
				ModifyStatus	char(1)
			)			
			INSERT INTO #RoleIdTmp(RoleCode) EXEC dbo.sp_Common_SplitStr2Table @iRoleIdArr;
		
		
			--本次無異動者
			UPDATE #RoleIdTmp 
			SET ModifyStatus = 'N'
			WHERE RoleCode IN(
			SELECT RoleCode FROM UserRoleMap 
			WHERE UserId = @iUserId
			AND RoleCode IN (
				SELECT RoleCode FROM #RoleIdTmp
			))
							
			--本次新增者
			UPDATE #RoleIdTmp 
			SET ModifyStatus = 'A'
			WHERE RoleCode IN(
			SELECT RoleCode FROM #RoleIdTmp 
			WHERE RoleCode NOT IN (
				SELECT RoleCode FROM UserRoleMap
				WHERE UserId = @iUserId
			))
			
			
			--本次刪除者
			INSERT INTO #RoleIdTmp(RoleCode,ModifyStatus)
			SELECT RoleCode,'D' FROM UserRoleMap 
			WHERE UserId = @iUserId
			AND RoleCode NOT IN(
				SELECT RoleCode FROM #RoleIdTmp 
			)
			
			--新增：使用者與角色對應
			INSERT INTO UserRoleMap(RoleCode,UserId) 
				SELECT RoleCode,@iUserId FROM #RoleIdTmp WHERE ModifyStatus = 'A'
			
			SET @oDescription = @iUserId + ' Insert Role Into User User=' +  @iUserId + ' And RoleCode=';

			--新增：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT	
					@OperatorIP,@OperatorUserId,'SystemAdmin','2',           
       				RoleCode,@iUserId,@iUserId,'',RoleCode, 
					@oDescription + RoleCode,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)
			FROM #RoleIdTmp WHERE ModifyStatus = 'A'
							
			--刪除：使用者與角色對應
			DELETE UserRoleMap
			WHERE UserId = @iUserId
			AND RoleCode IN (
				SELECT RoleCode FROM #RoleIdTmp WHERE ModifyStatus = 'D'
			)

			SET @oDescription = @OperatorUserId + ' Delete Role From User User=' +  @iUserId + ' And RoleCode=';
			
			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					RoleId,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT	
					@OperatorIP,@OperatorUserId,'SystemAdmin','2',           
       				RoleCode,
       				@iUserId,@iUserId,RoleCode,'', 
					@oDescription + RoleCode,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)
			FROM #RoleIdTmp WHERE ModifyStatus = 'D'
			
		
		END		
	ELSE
		BEGIN
			
			SET @oDescription = @OperatorUserId + ' Delete AllRole From User User=' +  @iUserId

			--刪除：寫入報表LOG檔
			INSERT INTO ezAcquireAudit.dbo.AuditLog(
					OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
					TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
					[Description],DocAuditCode,SessionId,RandomString)
			SELECT	
					@OperatorIP,@OperatorUserId,'SystemAdmin','2',           
       				@iUserId,@iUserId,'','', 
       				@oDescription,@iDocAuditCode,@iSessionId,
					dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'2',@oDescription,@iDocAuditCode)
			FROM UserRoleMap WHERE UserId = @iUserId
			
			--刪除：使用者與角色對應
			DELETE UserRoleMap
			WHERE UserId = @iUserId
			
		
		END

		--修改使用者的業務類別
		IF  @iBusinessType IS NOT NULL AND @iBusinessType <> ''
		BEGIN
			DELETE UserBusinessTypeMap WHERE UserId = @iUserId
			INSERT INTO UserBusinessTypeMap (UserId,BusinessTypeCode) VALUES (@iUserId,@iBusinessType)
		END

/****************************************************************************/
/********************************* 傳出結果 *********************************/	
		
		SELECT * from [User] WHERE UserId = @iUserId
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_ManageQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_ManageQuery]

	@OperatorUserId		varchar(50),	--操作者代碼
	@OperatorIP			varchar(50),	--操作者IP
	
	@targetUserId		varchar(50),	--被查詢者代碼
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE	@oDescription varchar(max);

	SET @oDescription = @OperatorUserId + ' Query User TargetUserId =' + @targetUserId;
	
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		TargetUserId,TransactionTatget,TransactionBefore,TransactionAfter,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@OperatorIP,@OperatorUserId,'SystemAdmin','3',           
		@targetUserId,@targetUserId,'','',
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@OperatorUserId,'3',@oDescription,@iDocAuditCode)
	)
	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog 
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ezAcquire_User_UnLock]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ezAcquire_User_UnLock]

	@loginUserId		varchar(50),	--登入者代碼
	@loginIP			varchar(50),	--登入者IP	
	@loginSystem		varchar(20),	--SystemAdmin、Scan、ImageQuery_Form、ImageQuery_Web、Filing
	@iDocAuditCode		varchar(100),	--傳入的檢核碼
	@iSessionId			varchar(100)	--SessionId
AS
BEGIN
	SET NOCOUNT ON;
	
	DECLARE	@oDescription varchar(max);
		
/************************************************************************************** 
	登入密碼有誤時再多寫一個記錄,AuditCode = 23
	更新使用者FailCount
**************************************************************************************/
			
	--更新使用者登入失敗次數=0
	UPDATE [User]
	SET FailCount = 0
	WHERE UserId = @loginUserId	
		
	--寫入Audit
	SET @oDescription = @loginUserId + ' Login System:' + @loginSystem + ' Unlock '
		
	INSERT INTO ezAcquireAudit.dbo.AuditLog(
		OperatorIP,OperatorUserId,OperatedSystem,OperationFunction,
		TargetUserId,TransactionTatget,
		[Description],DocAuditCode,SessionId,RandomString
	)VALUES(
		@loginIP,@loginUserId,@loginSystem,'23',           
		@loginUserId,@loginUserId,
		@oDescription,@iDocAuditCode,@iSessionId,
		dbo.ezAcquireAudit_Trans2Random(@loginUserId,'23',@oDescription,@iDocAuditCode)
	)		
		
	
	
/**************************************************************************************/	
	SELECT max(SerialId) from ezAcquireAudit.dbo.AuditLog
		
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetIndexQueryList]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetIndexQueryList]
    @RoleCode VARCHAR(50),
    @CultureName VARCHAR(50)
AS
BEGIN
    --copy data from View
    DECLARE @viewTable TABLE (
        [Value] VARCHAR(255),
        [Label] NVARCHAR(255) 
    )
    --convert to json
    DECLARE @optionTable TABLE (
        Type VARCHAR(50),
        OptionList NVARCHAR(MAX) 
    )
    DECLARE @curType varchar(50)

    DECLARE view_cursor CURSOR FOR
    SELECT [Type] FROM CodeType
    WHERE Type LIKE 'View[_]%'
    
    OPEN view_cursor
    FETCH NEXT FROM view_cursor 
    INTO @curType
    
    WHILE @@FETCH_STATUS = 0
    BEGIN
        --SAVE View to temp table
        DELETE FROM @viewTable
        INSERT INTO @viewTable
        EXEC sp_GetOptionList @curType
        --convert View to json
        INSERT INTO @optionTable
        SELECT @curType, (SELECT * FROM @viewTable FOR JSON PATH)

        --next 
        FETCH NEXT FROM view_cursor 
        INTO @curType
    END
    CLOSE view_cursor
    DEALLOCATE view_cursor

    --create IndwxQueryList
    SELECT
        (case when RQI.IndexFieldName IS NULL then 'N' else 'Y' end) AS CheckFlg, --勾選欄
        I.IndexCategory, --索引類別
        I.IndexFieldName, --索引代碼
        I.IndexDisplayName, --索引名稱
        I.IndexTextDescription, --索引說明
        II.InputType, --查詢條件輸入類型代碼
        (case when @CultureName='en-US' then CD.Remark02 else CD.Description end ) AS InputTypeName, --查詢條件輸入類型名稱
        CD1.Remark01 AS InputValidator, --字元限制
        II.MaxLength, --長度限制
        II.MinValue, --最小值
        II.MaxValue, --最大值
        II.IncreaseStep, --數值差
        II.OptionSource, --選項來源
        JSON_QUERY( 
            --選項由view取得
            CASE WHEN SUBSTRING(II.OptionSource,1,4)='View' 
            THEN (
                select OptionList
                from @optionTable
                WHERE Type=II.OptionSource			
            ) 
            ELSE 
                --選項由CodeData取得
                CASE WHEN @CultureName='en-US'
                THEN (
                    SELECT CD.Code AS [Value], CD.Remark02 AS [Label]
                    FROM CodeData CD
                    WHERE Type=II.OptionSource
                    ORDER BY Seq
                    FOR JSON PATH
                )
                ELSE (
                    SELECT CD.Code AS [Value], CD.Description AS [Label]
                    FROM CodeData CD
                    WHERE Type=II.OptionSource
                    ORDER BY Seq
                    FOR JSON PATH
                )
                END 
            END
        ) AS OptionList, --選項
        RQI.IndexContent --索引資料範圍限定

    FROM IndexDescription I
        LEFT JOIN RoleQueryIndexMap RQI ON RQI.IndexFieldName=I.IndexFieldName AND RQI.RoleCode=@RoleCode
        LEFT JOIN IndexInputSetting II ON II.IndexFieldName=I.IndexFieldName
        LEFT JOIN CodeData CD on CD.Code=II.InputType AND CD.Type='InputType'
        LEFT JOIN CodeData CD1 ON CD1.Code=II.InputValidator AND CD1.Type='InputValidator'
    WHERE I.RetrievalKey=1
        AND II.OptionSource NOT IN ('FormGroup','FormByGroup')
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetMachineCode]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROC [dbo].[sp_GetMachineCode]
(
    @userId			nvarchar(50), 
	@unitCode		nvarchar(50), 
	@machineName	nvarchar(50), 
	@ipAddress		nvarchar(50), 
	@macAddress		nvarchar(50)
)
AS
BEGIN
    IF @macAddress = ''
    BEGIN
        SELECT ''
    END
    ELSE 
    BEGIN
        IF EXISTS(SELECT * FROM ScanStation WHERE StationMAC = @macAddress)
        BEGIN
            -- 取得既有的 machine code
            SELECT MachineCode FROM ScanStation WHERE StationMAC = @macAddress
        END
        ELSE
        BEGIN
			DECLARE @machineCode nvarchar(50) = ''
            DECLARE @maxMachineCodeSuffix nvarchar(50) = ''

            SELECT TOP 1 @maxMachineCodeSuffix = ISNULL(MachineCodeSuffix,'') FROM ScanStation WHERE UnitCode = @unitCode ORDER BY MachineCodeSuffix DESC

            IF @maxMachineCodeSuffix = ''
            BEGIN
                -- machine code 起始值
                SET @maxMachineCodeSuffix = 'A'
            END
            ELSE
            BEGIN
                -- @char1 + 1
                SET @maxMachineCodeSuffix = dbo.fn_Zdecimal(@maxMachineCodeSuffix)
            END

            SET @machineCode = @unitCode + @maxMachineCodeSuffix
            INSERT INTO ScanStation (StationMAC, Description, RandomString, Unitcode, IPAddress, CreateUser, CreateDateTime, MachineCode, MachineCodeSuffix) 
			VALUES (@macAddress, @machineName, NEWID(), @unitCode, @ipAddress, @userId, getdate(), @machineCode, @maxMachineCodeSuffix)
            
			SELECT @machineCode
        END
    END
END


GO
/****** Object:  StoredProcedure [dbo].[sp_GetOptionList]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetOptionList](
  @viewName varchar(50)
	--optionJson nvarchar(MAX) OUTPUT
)	
AS
BEGIN
  SET NOCOUNT ON;
  DECLARE @exeSql NVARCHAR(MAX);

  SET @exeSql = N' SELECT * FROM dbo.' + QUOTENAME(@viewName)-- + ' FOR JSON PATH '
  EXEC ( @exeSql)
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryConditionJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetQueryConditionJson]
    @QueryPageId INT,
    @CultureName VARCHAR(50)
AS
BEGIN
	--copy data from View
	DECLARE @viewTable TABLE (
    [Value] VARCHAR(255),
    [Label] NVARCHAR(255) 
  )
  --convert to json
  DECLARE @optionTable TABLE (
    Type VARCHAR(50),
    OptionList NVARCHAR(MAX) 
  )
  DECLARE @curType varchar(50)

	DECLARE view_cursor CURSOR FOR
     SELECT Type FROM CodeType WHERE Type LIKE 'View[_]%'
  OPEN view_cursor
  FETCH NEXT FROM view_cursor INTO @curType
  WHILE @@FETCH_STATUS = 0
  BEGIN		
		--SAVE View to temp table
		DELETE FROM @viewTable
		INSERT INTO @viewTable
		EXEC sp_GetOptionList @curType
		--convert View to json
		INSERT INTO @optionTable 
		SELECT @curType, (SELECT * FROM @viewTable for json path)
		--next 
    FETCH NEXT FROM view_cursor INTO @curType
  END
  CLOSE view_cursor
  DEALLOCATE view_cursor

  --QueryFormGroup
  DECLARE @formGroupTable TABLE(
    [Value] VARCHAR(50),
    [Label] NVARCHAR(255)
  )
  IF (select count(*) from QueryFormGroup where QueryPageId=@QueryPageId)>0
  BEGIN
    INSERT INTO @formGroupTable 
    SELECT QFG.FormGroupCode, FG.FormGroupName
    FROM QueryFormGroup QFG
    LEFT JOIN FormGroup FG ON FG.FormGroupCode=QFG.FormGroupCode AND FG.FormGroupType='Q'
    WHERE QFG.QueryPageId=@QueryPageId
    ORDER BY QFG.FormGroupCode
  END
  ELSE
  BEGIN
    INSERT INTO @formGroupTable 
    SELECT FormGroupCode, FormGroupName
    FROM FormGroup
    WHERE FormGroupType='Q'
    ORDER BY FormGroupCode
  END

  --create Query JSON
  SELECT DISTINCT (
    SELECT 
    QF.IndexFieldName, --索引欄位代碼
    ID.IndexDisplayName, --索引欄位名稱
    QF.QueryLabel, --條件名稱
    II.InputType, --輸入類型
    CD.Remark01 AS InputValidator, --字元限制
    II.MaxLength, --長度限制
    II.MinValue, --最小值
    II.MaxValue, --最大值
    II.IncreaseStep, --數值差
        (case when ID.Multiple=0 then 'N' else 'Y' end) AS Multiple, --是否多值
    QF.RequiredFlg, --是否必填
    QF.InputRangeFlg, --是否區間設定
    II.OptionSource, --選項來源
    JSON_QUERY( 
        CASE 
  --選項由view取得
        WHEN SUBSTRING(II.OptionSource,1,4)='View' 
        THEN (
            select OptionList from @optionTable WHERE Type=II.OptionSource			
        )
  --選項FormGroup
        WHEN II.OptionSource='FormGroup'
        THEN (
            select * from @formGroupTable
            FOR JSON PATH
        )
  --選項由CodeData取得
        ELSE  
            CASE
            WHEN @CultureName='en-US'
            THEN (
                SELECT CD.Code AS [Value], CD.Remark02 AS [Label]
                FROM CodeData CD 
                WHERE Type=II.OptionSource
                ORDER BY Seq
                FOR JSON PATH
            )
            ELSE (
                SELECT CD.Code AS [Value], CD.Description AS [Label]
                FROM CodeData CD 
                WHERE Type=II.OptionSource
                ORDER BY Seq
                FOR JSON PATH
            )
            END     
        END
  ) AS OptionList --選項
    FROM QueryField QF
    LEFT JOIN IndexDescription ID ON ID.IndexFieldName=QF.IndexFieldName
    LEFT JOIN IndexInputSetting II ON II.IndexFieldName=QF.IndexFieldName
    LEFT JOIN CodeData CD ON CD.Code=II.InputValidator AND CD.Type='InputValidator'
    WHERE QueryPageId=@QueryPageId
    ORDER BY QF.Seq
    FOR JSON PATH
  ) AS QueryJSON
  FROM QueryField
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryDetailJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetQueryDetailJson]
   @QueryPageId INT,
   @CultureName VARCHAR(50)
AS
BEGIN
	--copy data from View
	DECLARE @viewTable TABLE (
    [Value] VARCHAR(255),
    [Label] NVARCHAR(255) 
  )
  --convert to json
  DECLARE @optionTable TABLE (
    Type VARCHAR(50),
    OptionList NVARCHAR(MAX) 
  )
  DECLARE @curType varchar(50)

	DECLARE view_cursor CURSOR FOR
     SELECT Type FROM CodeType WHERE Type LIKE 'View[_]%'
  OPEN view_cursor
  FETCH NEXT FROM view_cursor INTO @curType
  WHILE @@FETCH_STATUS = 0
  BEGIN
		--copy View to temp table
		DELETE FROM @viewTable
		INSERT INTO @viewTable
		EXEC sp_GetOptionList @curType
		--convert View to json
		INSERT INTO @optionTable 
		SELECT @curType, (SELECT * FROM @viewTable for json path)
		--next 
    FETCH NEXT FROM view_cursor INTO @curType
  END
  CLOSE view_cursor
  DEALLOCATE view_cursor

  --create QueryResultDetail JSON
  SELECT DISTINCT (
    SELECT 
    QD.IndexFieldName, --索引欄位
    QD.IndexLabel, --欄位名稱
    II.InputType, --輸入類型
    CD.Remark01 AS InputValidator, --字元限制
    II.MaxLength, --長度限制
    II.MinValue, --最小值
    II.MaxValue, --最大值
    II.IncreaseStep, --數值差
    (
      case when ID.Multiple=1 then 'Y' else 'N' end
    ) AS Multiple, --是否多值
    QD.RequiredFlg, --是否必填
    (
      case when QD.ModifiedFlg='Y' then 'N' else 'Y' end
    ) AS ReadonlyFlg,  --是否唯讀/可否修改
    II.OptionSource,
    ( 
        --選項由view取得
        CASE WHEN SUBSTRING(II.OptionSource,1,4)='View' 
        THEN ( 
            select OptionList from @optionTable WHERE Type=II.OptionSource
        )
        --選項由CodeData取得
        ELSE  
            CASE
            WHEN @CultureName='en-US'
            THEN (
                SELECT CD.Code AS [Value], CD.Remark02 AS [Label]
        FROM CodeData CD 
        WHERE Type=II.OptionSource
        ORDER BY Seq
                FOR JSON PATH
            )
            ELSE (
                SELECT CD.Code AS [Value], CD.Description AS [Label]
        FROM CodeData CD 
        WHERE Type=II.OptionSource
        ORDER BY Seq
                FOR JSON PATH
            )
            END     
        END
    ) AS OptionList --選項
    FROM QueryResultDetail QD
    LEFT JOIN IndexDescription ID ON ID.IndexFieldName=QD.IndexFieldName
    LEFT JOIN IndexInputSetting II ON II.IndexFieldName=QD.IndexFieldName
    LEFT JOIN CodeData CD ON CD.Code=II.InputValidator AND CD.Type='InputValidator'
    WHERE QueryPageId=@QueryPageId
    ORDER BY QD.Seq
    FOR JSON PATH
  ) AS DetailJSON
  FROM QueryResultDetail
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetQueryResultJson]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetQueryResultJson]
    @QueryPageId INT
AS
BEGIN
    SELECT DISTINCT (
        SELECT 
            QR.IndexFieldName, --索引代碼
            ID.IndexDisplayName, --索引名稱
            QR.HeaderName, --表頭名稱
            QR.HeaderSortingFlg --可否排序
        FROM QueryResultHeader QR
        INNER JOIN IndexDescription ID ON ID.IndexFieldName=QR.IndexFieldName
        WHERE QueryPageId=@QueryPageId
        ORDER BY Seq
        FOR JSON PATH
    ) AS ResultJSON
    FROM QueryResultHeader
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetUserFormQuery]    Script Date: 2021/11/19 下午 02:11:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetUserFormQuery]
(
  @UserId		varchar(100), 
	@FormId		varchar(20)
)
AS
BEGIN
  
	DECLARE @AuthTable TABLE (
		Page int,
		Auth VARCHAR(10)
	)
	DECLARE @curQuery varchar(50)
	DECLARE the_cursor CURSOR FOR
		SELECT DISTINCT dbo.fn_SplitString(QueryPages) FROM dbo.V_UserFormQuery  
		WHERE UserId=@UserId and FormId=@FormId
	OPEN the_cursor
	FETCH NEXT FROM the_cursor INTO @curQuery
	WHILE @@FETCH_STATUS = 0
	BEGIN
			PRINT @curQuery
			--SAVE auth for each page to table    
			INSERT INTO @AuthTable
		select ROW_NUMBER() OVER (ORDER BY (SELECT 100)) AS Page, VALUE 
		FROM STRING_SPLIT(dbo.fn_SplitString(@curQuery),',')
		WHERE LEN(VALUE)>0
			
			--next 
		FETCH NEXT FROM the_cursor INTO @curQuery
	END
	CLOSE the_cursor
	DEALLOCATE the_cursor

	select
	(case when SUM(CONVERT(INT,Auth))>0 then 1 else 0 end) 
	from @AuthTable group by Page
	for xml path('')
	
	END
GO
