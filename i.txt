USE [ezAcquire]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetIndexQueryList]    Script Date: 2021/4/19 下午 05:40:07 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetIndexQueryList]
  @RoleCode VARCHAR(50),
  @CultureName VARCHAR(50)
AS
BEGIN

  --copy data from View
  DECLARE @viewTable TABLE (
    [Value] VARCHAR(255),
    [Label] NVARCHAR(255) 
  )
  --convert to json
  DECLARE @optionTable TABLE (
    Type VARCHAR(50),
    OptionList NVARCHAR(MAX) 
  )
  DECLARE @curType varchar(50)

  DECLARE view_cursor CURSOR FOR
    SELECT Type FROM CodeType WHERE Type LIKE 'View[_]%'
  OPEN view_cursor
  FETCH NEXT FROM view_cursor INTO @curType
  WHILE @@FETCH_STATUS = 0
  BEGIN		
    --SAVE View to temp table
    DELETE FROM @viewTable
    INSERT INTO @viewTable
    EXEC sp_GetOptionList @curType
    --convert View to json
    INSERT INTO @optionTable 
    SELECT @curType, (SELECT * FROM @viewTable for json path)
    --next 
    FETCH NEXT FROM view_cursor INTO @curType
  END
  CLOSE view_cursor
  DEALLOCATE view_cursor

  --create IndwxQueryList
  SELECT 
  (case when RQI.IndexFieldName IS NULL then 'N' else 'Y' end) AS CheckFlg, --勾選欄
  I.IndexCategory, --索引類別
  I.IndexFieldName, --索引代碼
  I.IndexDisplayName, --索引名稱
  I.IndexTextDescription, --索引說明
  II.InputType, --查詢條件輸入類型代碼
  (case when @CultureName='en-US' then CD.Remark02 else CD.Description end ) AS InputTypeName, --查詢條件輸入類型名稱
  CD1.Remark01 AS InputValidator, --字元限制
  II.MaxLength, --長度限制
  II.MinValue, --最小值
  II.MaxValue, --最大值
  II.IncreaseStep, --數值差
  II.OptionSource, --選項來源
  JSON_QUERY( 
  --選項由view取得
      CASE WHEN SUBSTRING(II.OptionSource,1,4)='View' 
      THEN (
          select OptionList from @optionTable WHERE Type=II.OptionSource			
      ) 
  --選項由CodeData取得
      ELSE 
          CASE
          WHEN @CultureName='en-US'
          THEN (
              SELECT CD.Code AS [Value], CD.Remark02 AS [Label]
					    FROM CodeData CD 
					    WHERE Type=II.OptionSource
					    ORDER BY Seq
              FOR JSON PATH
          )
          ELSE (
              SELECT CD.Code AS [Value], CD.Description AS [Label]
					    FROM CodeData CD 
					    WHERE Type=II.OptionSource
					    ORDER BY Seq
              FOR JSON PATH
          )
          END 
      END
) AS OptionList, --選項
RQI.IndexContent --索引資料範圍限定

FROM IndexDescription I
LEFT JOIN RoleQueryIndexMap RQI ON RQI.IndexFieldName=I.IndexFieldName AND RQI.RoleCode=@RoleCode
LEFT JOIN IndexInputSetting II ON II.IndexFieldName=I.IndexFieldName
LEFT JOIN CodeData CD on CD.Code=II.InputType AND CD.Type='InputType'
LEFT JOIN CodeData CD1 ON CD1.Code=II.InputValidator AND CD1.Type='InputValidator'
WHERE I.RetrievalKey=1
AND II.OptionSource NOT IN ('FormGroup','FormByGroup')

END